{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Registro de Productor - AgroConnect{% endblock %}

{% block extra_head %}
<style>
    /* Estilos para inputs, selects y textareas del formulario */
    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="tel"],
    form input[type="number"],
    form select,
    form textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.15s ease-in-out;
    }
    
    /* Dark mode para inputs */
    .dark form input[type="text"],
    .dark form input[type="email"],
    .dark form input[type="password"],
    .dark form input[type="tel"],
    .dark form input[type="number"],
    .dark form select,
    .dark form textarea {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    /* Focus states */
    form input[type="text"]:focus,
    form input[type="email"]:focus,
    form input[type="password"]:focus,
    form input[type="tel"]:focus,
    form input[type="number"]:focus,
    form select:focus,
    form textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dark form input[type="text"]:focus,
    .dark form input[type="email"]:focus,
    .dark form input[type="password"]:focus,
    .dark form input[type="tel"]:focus,
    .dark form input[type="number"]:focus,
    .dark form select:focus,
    .dark form textarea:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    /* Textarea específico */
    form textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Select específico */
    form select {
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }
    
    .dark form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%9ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    
    /* Labels en modo oscuro */
    .dark label {
        color: #e5e7eb !important;
    }
    
    /* Selects de código de país con ancho uniforme */
    #country-code-select-producer {
        width: 180px !important;
        min-width: 180px !important;
        max-width: 180px !important;
        box-sizing: border-box !important;
    }
    
    /* Asegurar que el menú desplegable tenga el mismo ancho */
    #country-code-select-producer option {
        max-width: 180px !important;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-primary-50 via-white to-accent-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-strong">
                <i class="fas fa-tractor text-white text-3xl"></i>
            </div>
            <h2 class="text-4xl font-bold text-gray-900 mb-2">Registro de Productor</h2>
            <p class="text-gray-600 text-lg">Completa tu información y registra tu primera finca</p>
        </div>

        <!-- Form -->
        <div class="card">
            <div class="card-body p-8">
                {% if is_google_signup %}
                <!-- Información de Google -->
                <div class="mb-8 p-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center mr-4">
                            {% if google_data.photo_url %}
                                <img src="{{ google_data.photo_url }}" alt="Foto de perfil" class="w-10 h-10 rounded-full">
                            {% else %}
                                <i class="fas fa-user text-blue-600 dark:text-blue-400 text-xl"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-300">¡Bienvenido desde Google!</h3>
                            <p class="text-blue-700 dark:text-blue-300">Hemos obtenido tu información básica de Google. Completa los datos restantes para crear tu cuenta de productor.</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800 dark:text-blue-200">
                        <div><strong>Email:</strong> {{ google_data.email }}</div>
                        <div><strong>Nombre:</strong> {{ google_data.first_name }} {{ google_data.last_name }}</div>
                    </div>
                </div>
                {% endif %}
                
                <form method="post" id="producer-registration-form">
                    {% csrf_token %}
                    
                    <!-- Información Personal -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-user text-primary-600 mr-3"></i>
                            Información Personal
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombres *
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.first_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Apellidos *
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.last_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Correo Electrónico *
                                    {% if is_google_signup %}
                                        <span class="text-sm text-blue-600">(obtenido de Google)</span>
                                    {% endif %}
                                </label>
                                {% if is_google_signup %}
                                    <input type="email" value="{{ form.email.value }}" readonly 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed">
                                    <input type="hidden" name="email" value="{{ form.email.value }}">
                                {% else %}
                                    {{ form.email }}
                                {% endif %}
                                {% if form.email.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.email.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre de Usuario *
                                </label>
                                {{ form.username }}
                                {% if form.username.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.username.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.cedula.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Cédula *
                                </label>
                                {{ form.cedula }}
                                {% if form.cedula.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.cedula.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.telefono.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Teléfono *
                                </label>
                                <div class="flex gap-2">
                                    <select id="country-code-select-producer" class="flex-shrink-0 px-2 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm" style="width: 180px !important; min-width: 180px !important; max-width: 180px !important; box-sizing: border-box !important; text-align: center; text-align-last: center;">
                                        <option value="+93">Afganistán +93</option>
                                        <option value="+355">Albania +355</option>
                                        <option value="+49">Alemania +49</option>
                                        <option value="+376">Andorra +376</option>
                                        <option value="+244">Angola +244</option>
                                        <option value="+1">Antigua y Barbuda +1</option>
                                        <option value="+966">Arabia Saudita +966</option>
                                        <option value="+213">Argelia +213</option>
                                        <option value="+54">Argentina +54</option>
                                        <option value="+374">Armenia +374</option>
                                        <option value="+61">Australia +61</option>
                                        <option value="+43">Austria +43</option>
                                        <option value="+994">Azerbaiyán +994</option>
                                        <option value="+1">Bahamas +1</option>
                                        <option value="+973">Bahréin +973</option>
                                        <option value="+880">Bangladesh +880</option>
                                        <option value="+1">Barbados +1</option>
                                        <option value="+375">Bielorrusia +375</option>
                                        <option value="+32">Bélgica +32</option>
                                        <option value="+501">Belice +501</option>
                                        <option value="+229">Benín +229</option>
                                        <option value="+975">Bután +975</option>
                                        <option value="+591">Bolivia +591</option>
                                        <option value="+387">Bosnia y Herzegovina +387</option>
                                        <option value="+267">Botsuana +267</option>
                                        <option value="+55">Brasil +55</option>
                                        <option value="+673">Brunéi +673</option>
                                        <option value="+359">Bulgaria +359</option>
                                        <option value="+226">Burkina Faso +226</option>
                                        <option value="+257">Burundi +257</option>
                                        <option value="+238">Cabo Verde +238</option>
                                        <option value="+855">Camboya +855</option>
                                        <option value="+237">Camerún +237</option>
                                        <option value="+1">Canadá +1</option>
                                        <option value="+974">Catar +974</option>
                                        <option value="+235">Chad +235</option>
                                        <option value="+56">Chile +56</option>
                                        <option value="+86">China +86</option>
                                        <option value="+357">Chipre +357</option>
                                        <option value="+57" selected>Colombia +57</option>
                                        <option value="+269">Comoras +269</option>
                                        <option value="+242">Congo +242</option>
                                        <option value="+850">Corea del Norte +850</option>
                                        <option value="+82">Corea del Sur +82</option>
                                        <option value="+225">Costa de Marfil +225</option>
                                        <option value="+506">Costa Rica +506</option>
                                        <option value="+385">Croacia +385</option>
                                        <option value="+53">Cuba +53</option>
                                        <option value="+45">Dinamarca +45</option>
                                        <option value="+1">Dominica +1</option>
                                        <option value="+593">Ecuador +593</option>
                                        <option value="+20">Egipto +20</option>
                                        <option value="+503">El Salvador +503</option>
                                        <option value="+971">Emiratos Árabes Unidos +971</option>
                                        <option value="+291">Eritrea +291</option>
                                        <option value="+421">Eslovaquia +421</option>
                                        <option value="+386">Eslovenia +386</option>
                                        <option value="+34">España +34</option>
                                        <option value="+1">Estados Unidos +1</option>
                                        <option value="+372">Estonia +372</option>
                                        <option value="+268">Esuatini +268</option>
                                        <option value="+251">Etiopía +251</option>
                                        <option value="+63">Filipinas +63</option>
                                        <option value="+358">Finlandia +358</option>
                                        <option value="+679">Fiyi +679</option>
                                        <option value="+33">Francia +33</option>
                                        <option value="+241">Gabón +241</option>
                                        <option value="+220">Gambia +220</option>
                                        <option value="+995">Georgia +995</option>
                                        <option value="+233">Ghana +233</option>
                                        <option value="+1">Granada +1</option>
                                        <option value="+30">Grecia +30</option>
                                        <option value="+502">Guatemala +502</option>
                                        <option value="+224">Guinea +224</option>
                                        <option value="+240">Guinea Ecuatorial +240</option>
                                        <option value="+245">Guinea-Bisáu +245</option>
                                        <option value="+592">Guyana +592</option>
                                        <option value="+509">Haití +509</option>
                                        <option value="+504">Honduras +504</option>
                                        <option value="+36">Hungría +36</option>
                                        <option value="+91">India +91</option>
                                        <option value="+62">Indonesia +62</option>
                                        <option value="+98">Irán +98</option>
                                        <option value="+964">Irak +964</option>
                                        <option value="+353">Irlanda +353</option>
                                        <option value="+354">Islandia +354</option>
                                        <option value="+972">Israel +972</option>
                                        <option value="+39">Italia +39</option>
                                        <option value="+1">Jamaica +1</option>
                                        <option value="+81">Japón +81</option>
                                        <option value="+962">Jordania +962</option>
                                        <option value="+7">Kazajistán +7</option>
                                        <option value="+254">Kenia +254</option>
                                        <option value="+996">Kirguistán +996</option>
                                        <option value="+686">Kiribati +686</option>
                                        <option value="+965">Kuwait +965</option>
                                        <option value="+856">Laos +856</option>
                                        <option value="+266">Lesoto +266</option>
                                        <option value="+371">Letonia +371</option>
                                        <option value="+961">Líbano +961</option>
                                        <option value="+231">Liberia +231</option>
                                        <option value="+218">Libia +218</option>
                                        <option value="+423">Liechtenstein +423</option>
                                        <option value="+370">Lituania +370</option>
                                        <option value="+352">Luxemburgo +352</option>
                                        <option value="+261">Madagascar +261</option>
                                        <option value="+60">Malasia +60</option>
                                        <option value="+265">Malaui +265</option>
                                        <option value="+960">Maldivas +960</option>
                                        <option value="+223">Malí +223</option>
                                        <option value="+356">Malta +356</option>
                                        <option value="+212">Marruecos +212</option>
                                        <option value="+692">Islas Marshall +692</option>
                                        <option value="+230">Mauricio +230</option>
                                        <option value="+222">Mauritania +222</option>
                                        <option value="+52">México +52</option>
                                        <option value="+691">Micronesia +691</option>
                                        <option value="+373">Moldavia +373</option>
                                        <option value="+377">Mónaco +377</option>
                                        <option value="+976">Mongolia +976</option>
                                        <option value="+382">Montenegro +382</option>
                                        <option value="+258">Mozambique +258</option>
                                        <option value="+95">Myanmar +95</option>
                                        <option value="+264">Namibia +264</option>
                                        <option value="+674">Nauru +674</option>
                                        <option value="+977">Nepal +977</option>
                                        <option value="+505">Nicaragua +505</option>
                                        <option value="+227">Níger +227</option>
                                        <option value="+234">Nigeria +234</option>
                                        <option value="+47">Noruega +47</option>
                                        <option value="+64">Nueva Zelanda +64</option>
                                        <option value="+968">Omán +968</option>
                                        <option value="+31">Países Bajos +31</option>
                                        <option value="+92">Pakistán +92</option>
                                        <option value="+680">Palaos +680</option>
                                        <option value="+507">Panamá +507</option>
                                        <option value="+675">Papúa Nueva Guinea +675</option>
                                        <option value="+595">Paraguay +595</option>
                                        <option value="+51">Perú +51</option>
                                        <option value="+48">Polonia +48</option>
                                        <option value="+351">Portugal +351</option>
                                        <option value="+44">Reino Unido +44</option>
                                        <option value="+236">República Centroafricana +236</option>
                                        <option value="+420">República Checa +420</option>
                                        <option value="+243">Rep. Democrática del Congo +243</option>
                                        <option value="+1">República Dominicana +1</option>
                                        <option value="+250">Ruanda +250</option>
                                        <option value="+40">Rumania +40</option>
                                        <option value="+7">Rusia +7</option>
                                        <option value="+685">Samoa +685</option>
                                        <option value="+1">San Cristóbal y Nieves +1</option>
                                        <option value="+378">San Marino +378</option>
                                        <option value="+1">San Vicente y Granadinas +1</option>
                                        <option value="+1">Santa Lucía +1</option>
                                        <option value="+239">Santo Tomé y Príncipe +239</option>
                                        <option value="+221">Senegal +221</option>
                                        <option value="+381">Serbia +381</option>
                                        <option value="+248">Seychelles +248</option>
                                        <option value="+232">Sierra Leona +232</option>
                                        <option value="+65">Singapur +65</option>
                                        <option value="+963">Siria +963</option>
                                        <option value="+252">Somalia +252</option>
                                        <option value="+94">Sri Lanka +94</option>
                                        <option value="+27">Sudáfrica +27</option>
                                        <option value="+249">Sudán +249</option>
                                        <option value="+211">Sudán del Sur +211</option>
                                        <option value="+46">Suecia +46</option>
                                        <option value="+41">Suiza +41</option>
                                        <option value="+597">Surinam +597</option>
                                        <option value="+66">Tailandia +66</option>
                                        <option value="+255">Tanzania +255</option>
                                        <option value="+992">Tayikistán +992</option>
                                        <option value="+670">Timor Oriental +670</option>
                                        <option value="+228">Togo +228</option>
                                        <option value="+676">Tonga +676</option>
                                        <option value="+1">Trinidad y Tobago +1</option>
                                        <option value="+216">Túnez +216</option>
                                        <option value="+993">Turkmenistán +993</option>
                                        <option value="+90">Turquía +90</option>
                                        <option value="+688">Tuvalu +688</option>
                                        <option value="+380">Ucrania +380</option>
                                        <option value="+256">Uganda +256</option>
                                        <option value="+598">Uruguay +598</option>
                                        <option value="+998">Uzbekistán +998</option>
                                        <option value="+678">Vanuatu +678</option>
                                        <option value="+379">Vaticano +379</option>
                                        <option value="+58">Venezuela +58</option>
                                        <option value="+84">Vietnam +84</option>
                                        <option value="+967">Yemen +967</option>
                                        <option value="+253">Yibuti +253</option>
                                        <option value="+260">Zambia +260</option>
                                        <option value="+263">Zimbabue +263</option>
                                    </select>
                                    <input type="text" name="phone_number" id="phone-number-input-producer" class="flex-1 px-3 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="320 123 4567" maxlength="15" pattern="[0-9\s]+" title="Solo números">
                                    {{ form.telefono }}
                                </div>
                                {% if form.telefono.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.telefono.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if is_google_signup %}
                        <!-- Campos de contraseña obligatorios para usuarios de Google -->
                        <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mr-2"></i>
                                <span class="text-blue-800 dark:text-blue-300 font-medium">Asignar Contraseña</span>
                            </div>
                            <p class="text-blue-700 dark:text-blue-300 text-sm mb-4">Debes asignar una contraseña para poder iniciar sesión también con tu nombre de usuario, además de Google.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="{{ form.password1.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-lock mr-2 text-blue-600 dark:text-blue-400"></i>
                                        {{ form.password1.label }} <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.password1 }}
                                    {% if form.password1.help_text %}
                                        <p class="mt-1 text-xs text-blue-600 dark:text-blue-400">{{ form.password1.help_text }}</p>
                                    {% endif %}
                                    {% if form.password1.errors %}
                                        <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.password1.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <label for="{{ form.password2.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-lock mr-2 text-blue-600 dark:text-blue-400"></i>
                                        {{ form.password2.label }} <span class="text-red-500">*</span>
                                    </label>
                                    {{ form.password2 }}
                                    {% if form.password2.help_text %}
                                        <p class="mt-1 text-xs text-blue-600 dark:text-blue-400">{{ form.password2.help_text }}</p>
                                    {% endif %}
                                    {% if form.password2.errors %}
                                        <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.password2.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Campos de contraseña requeridos para registro normal -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label for="{{ form.password1.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Contraseña <span class="text-red-500">*</span>
                                </label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.password1.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.password2.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Confirmar Contraseña <span class="text-red-500">*</span>
                                </label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.password2.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Información para vendedores -->
                    <div class="mt-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-green-600 dark:text-green-400 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-semibold text-green-800 dark:text-green-300 mb-1">
                                    Registro como Productor
                                </h3>
                                <p class="text-sm text-green-700 dark:text-green-300">
                                    Como productor, podrás publicar y vender tus productos agrícolas. Es necesario registrar tu primera finca para garantizar la trazabilidad.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Finca -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-tractor text-green-600 mr-3"></i>
                            Información de tu Finca
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="{{ form.finca_nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre de la Finca *
                                </label>
                                {{ form.finca_nombre }}
                                {% if form.finca_nombre.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_nombre.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_departamento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Departamento *
                                </label>
                                {{ form.finca_departamento }}
                                {% if form.finca_departamento.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_departamento.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_ciudad.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Ciudad/Municipio *
                                </label>
                                {{ form.finca_ciudad }}
                                {% if form.finca_ciudad.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_ciudad.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="{{ form.finca_direccion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Dirección de la Finca *
                                </label>
                                {{ form.finca_direccion }}
                                {% if form.finca_direccion.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_direccion.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_area_total.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Área Total (hectáreas) *
                                </label>
                                {{ form.finca_area_total }}
                                {% if form.finca_area_total.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_area_total.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_area_cultivable.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Área Cultivable (hectáreas) *
                                </label>
                                {{ form.finca_area_cultivable }}
                                {% if form.finca_area_cultivable.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_area_cultivable.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_tipo_suelo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Tipo de Suelo *
                                </label>
                                {{ form.finca_tipo_suelo }}
                                {% if form.finca_tipo_suelo.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_tipo_suelo.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.finca_tipo_riego.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Tipo de Riego *
                                </label>
                                {{ form.finca_tipo_riego }}
                                {% if form.finca_tipo_riego.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.finca_tipo_riego.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Información Adicional -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                            Información Adicional
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.direccion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Dirección de Residencia *
                                </label>
                                {{ form.direccion }}
                                {% if form.direccion.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.direccion.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.main_crops.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Principales Cultivos
                                </label>
                                {{ form.main_crops }}
                                {% if form.main_crops.errors %}
                                    <div class="text-red-600 text-sm mt-1">{{ form.main_crops.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label for="{{ form.farm_description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Descripción de tu Experiencia
                            </label>
                            {{ form.farm_description }}
                            {% if form.farm_description.errors %}
                                <div class="text-red-600 text-sm mt-1">{{ form.farm_description.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                        <a href="{% url 'index' %}" class="btn-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Volver al Inicio
                        </a>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-user-plus mr-2"></i>
                            Crear Cuenta de Productor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departamentoSelect = document.getElementById('id_finca_departamento');
    const ciudadSelect = document.getElementById('id_finca_ciudad');
    
    departamentoSelect.addEventListener('change', function() {
        const departamento = this.value;
        
        // Limpiar opciones de ciudad
        ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
        
        if (departamento) {
            fetch('{% url "core:get_ciudades" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'departamento=' + encodeURIComponent(departamento)
            })
            .then(response => response.json())
            .then(data => {
                ciudadSelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
                data.ciudades.forEach(ciudad => {
                    const option = document.createElement('option');
                    option.value = ciudad.value;
                    option.textContent = ciudad.text;
                    ciudadSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                ciudadSelect.innerHTML = '<option value="">Error al cargar ciudades</option>';
            });
        } else {
            ciudadSelect.innerHTML = '<option value="">Primero seleccione un departamento</option>';
        }
    });
    
    // Sincronizar select de código de país con campo telefono
    const countryCodeSelect = document.getElementById('country-code-select-producer');
    const phoneNumberInput = document.getElementById('phone-number-input-producer');
    const telefonoField = document.getElementById('id_telefono');
    
    if (countryCodeSelect && phoneNumberInput && telefonoField) {
        // Forzar ancho fijo
        countryCodeSelect.style.width = '180px';
        countryCodeSelect.style.minWidth = '180px';
        countryCodeSelect.style.maxWidth = '180px';
        
        // Forzar ancho en el menú desplegable cuando se abra
        countryCodeSelect.addEventListener('mousedown', function() {
            this.style.width = '180px';
        });
        countryCodeSelect.addEventListener('focus', function() {
            this.style.width = '180px';
        });
        
        // Ocultar el campo original
        telefonoField.type = 'hidden';
        
        // Parsear el valor actual del teléfono si existe
        const currentPhone = telefonoField.value;
        if (currentPhone) {
            // Intentar extraer código de país y número
            const match = currentPhone.match(/^(\+\d+)\s*(.*)$/);
            if (match) {
                countryCodeSelect.value = match[1];
                phoneNumberInput.value = match[2].trim();
            }
        }
        
        // Actualizar campo telefono cuando cambie cualquiera de los dos
        function updatePhoneField() {
            const countryCode = countryCodeSelect.value;
            const phoneNumber = phoneNumberInput.value.replace(/[^0-9\s]/g, '');
            telefonoField.value = phoneNumber ? `${countryCode} ${phoneNumber}` : '';
        }
        
        countryCodeSelect.addEventListener('change', updatePhoneField);
        phoneNumberInput.addEventListener('input', updatePhoneField);
        
        // Validar solo números en el input
        phoneNumberInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9\s]/g, '');
        });
    }
});
</script>
{% endblock %}
