{% extends 'base.html' %}
{% load static %}

{% block title %}Prueba de Firebase - AgroConnect{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 via-white to-emerald-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl w-full">
        <div class="text-center mb-10">
            <h1 class="font-heading text-4xl sm:text-5xl font-bold text-green-900 mb-4">
                Prueba de Firebase
            </h1>
            <p class="text-base text-gray-700">
                Verificando configuraci√≥n de Firebase Phone Auth
            </p>
        </div>
        
        <div class="bg-white rounded-3xl shadow-md p-8">
            <div id="test-results" class="space-y-4">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Verificando configuraci√≥n...</p>
                </div>
            </div>
            
            <div class="mt-8">
                <button id="test-phone-auth" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
                    Probar Env√≠o de OTP
                </button>
            </div>
            
            <div class="mt-6">
                <label for="test-phone" class="block text-sm font-medium text-gray-700 mb-2">
                    N√∫mero de Tel√©fono de Prueba
                </label>
                <input type="tel" id="test-phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="+57 320 123 4567" value="+573203465135">
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v11+ -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

<!-- reCAPTCHA container -->
<div id="recaptcha-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultsDiv = document.getElementById('test-results');
    const testButton = document.getElementById('test-phone-auth');
    const phoneInput = document.getElementById('test-phone');
    
    function addResult(message, type = 'info') {
        const div = document.createElement('div');
        div.className = `p-4 rounded-lg ${
            type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' :
            'bg-blue-50 text-blue-800 border border-blue-200'
        }`;
        div.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
        resultsDiv.appendChild(div);
    }
    
    function clearResults() {
        resultsDiv.innerHTML = '';
    }
    
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "{{ FIREBASE_API_KEY }}",
        authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
        projectId: "{{ FIREBASE_PROJECT_ID }}",
        storageBucket: "{{ FIREBASE_STORAGE_BUCKET }}",
        messagingSenderId: "{{ FIREBASE_MESSAGING_SENDER_ID }}",
        appId: "{{ FIREBASE_APP_ID }}"
    };
    
    addResult('Iniciando pruebas de Firebase...', 'info');
    
    // 1. Verificar que Firebase est√© cargado
    if (typeof firebase === 'undefined') {
        addResult('‚ùå Firebase SDK no est√° cargado', 'error');
        return;
    }
    addResult('‚úÖ Firebase SDK cargado correctamente', 'success');
    
    // 2. Inicializar Firebase
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        addResult('‚úÖ Firebase inicializado correctamente', 'success');
    } catch (error) {
        addResult(`‚ùå Error inicializando Firebase: ${error.message}`, 'error');
        return;
    }
    
    // 3. Verificar Firebase Auth
    if (!firebase.auth) {
        addResult('‚ùå Firebase Auth no est√° disponible', 'error');
        return;
    }
    addResult('‚úÖ Firebase Auth disponible', 'success');
    
    // 4. Configurar reCAPTCHA seg√∫n documentaci√≥n oficial
    let recaptchaVerifier = null;
    try {
        addResult('Configurando reCAPTCHA seg√∫n documentaci√≥n oficial...', 'info');
        
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible',
            'callback': (response) => {
                addResult('‚úÖ reCAPTCHA resuelto correctamente', 'success');
            },
            'expired-callback': () => {
                addResult('‚ö†Ô∏è reCAPTCHA expirado', 'error');
            }
        });
        
        // Renderizar reCAPTCHA seg√∫n documentaci√≥n
        recaptchaVerifier.render().then((widgetId) => {
            addResult(`‚úÖ reCAPTCHA renderizado correctamente (Widget ID: ${widgetId})`, 'success');
        }).catch((error) => {
            addResult(`‚ùå Error renderizando reCAPTCHA: ${error.message}`, 'error');
        });
        
        addResult('‚úÖ reCAPTCHA configurado correctamente', 'success');
    } catch (error) {
        addResult(`‚ùå Error configurando reCAPTCHA: ${error.message}`, 'error');
        return;
    }
    
    // 5. Habilitar bot√≥n de prueba
    testButton.disabled = false;
    addResult('‚úÖ Configuraci√≥n completada. Listo para probar env√≠o de OTP', 'success');
    
    // 6. Funci√≥n de prueba
    testButton.addEventListener('click', async function() {
        const phoneNumber = phoneInput.value.trim();
        if (!phoneNumber) {
            addResult('‚ùå Por favor ingresa un n√∫mero de tel√©fono', 'error');
            return;
        }
        
        testButton.disabled = true;
        testButton.textContent = 'Enviando...';
        
        addResult(`üì± Enviando OTP a: ${phoneNumber}`, 'info');
        
        try {
            const confirmationResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
            addResult('‚úÖ C√≥digo OTP enviado exitosamente!', 'success');
            addResult('üì± Revisa tu tel√©fono para el c√≥digo de verificaci√≥n', 'info');
            
            // Mostrar bot√≥n para verificar c√≥digo
            const verifyButton = document.createElement('button');
            verifyButton.textContent = 'Verificar C√≥digo';
            verifyButton.className = 'w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 mt-4';
            verifyButton.onclick = () => {
                const code = prompt('Ingresa el c√≥digo de verificaci√≥n:');
                if (code) {
                    confirmationResult.confirm(code).then((result) => {
                        addResult('‚úÖ C√≥digo verificado correctamente!', 'success');
                    }).catch((error) => {
                        addResult(`‚ùå Error verificando c√≥digo: ${error.message}`, 'error');
                    });
                }
            };
            resultsDiv.appendChild(verifyButton);
            
        } catch (error) {
            addResult(`‚ùå Error enviando OTP: ${error.code} - ${error.message}`, 'error');
            console.error('Error detallado:', error);
        }
        
        testButton.disabled = false;
        testButton.textContent = 'Probar Env√≠o de OTP';
    });
});
</script>
{% endblock %}
