<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AgroConnect{% endblock %} | Panel de Administraci√≥n</title>
    
    {% load static %}
    
    <!-- Meta Description -->
    <meta name="description" content="{% block description %}AgroConnect - Plataforma que conecta productores agr√≠colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% block og_title %}AgroConnect - Del Campo a tu Hogar, Sin Intermediarios{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Plataforma que conecta productores agr√≠colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-image.svg' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="AgroConnect">
    <meta property="og:locale" content="es_CO">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:title" content="{% block twitter_title %}AgroConnect - Del Campo a tu Hogar, Sin Intermediarios{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Plataforma que conecta productores agr√≠colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'images/og-image.svg' %}{% endblock %}">
    
    <!-- Google Fonts - Outfit (TailAdmin Font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    'outfit': ['Outfit', 'sans-serif'],
                },
                colors: {
                    primary: {
                        50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
                        400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
                        800: '#166534', 900: '#14532d'
                    },
                    accent: {
                        50: '#fef3c7', 100: '#fde68a', 200: '#fcd34d', 300: '#fbbf24',
                        400: '#f59e0b', 500: '#f97316', 600: '#ea580c', 700: '#c2410c',
                        800: '#9a3412', 900: '#7c2d12'
                    },
                    gray: {
                        25: '#fcfcfd', 50: '#f9fafb', 100: '#f2f4f7', 200: '#e4e7ec', 
                        300: '#d0d5dd', 400: '#98a2b3', 500: '#667085', 600: '#475467', 
                        700: '#344054', 800: '#1d2939', 900: '#101828', 950: '#0c111d'
                    }
                }
            }
        }
    }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /><stop offset='100%25' style='stop-color:%2315803d;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23grad)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üå±</text></svg>">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">

{% block extra_head %}
<!-- Script para evitar parpadeo - se ejecuta ANTES del render -->
<script>
(function() {
    const savedState = localStorage.getItem('sidebarCollapsed');
    if (savedState === 'true') {
        document.documentElement.classList.add('sidebar-collapsed');
    }
})();
</script>

<style>
    /* Clase que se aplica al HTML cuando el sidebar est√° colapsado */
    html.sidebar-collapsed #sidebar {
        width: 5rem !important;
    }
    
    html.sidebar-collapsed #sidebar .sidebar-text {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        overflow: hidden !important;
        transition: none !important;
    }
    
    html.sidebar-collapsed #sidebar .sidebar-nav h4 {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        white-space: nowrap !important;
        transition: none !important;
    }
    
    html.sidebar-collapsed #sidebar .user-welcome {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0.5rem !important;
        margin-bottom: 1rem !important;
        display: flex !important;
        justify-content: center !important;
        /* Mantener la altura fija */
        min-height: 5rem !important;
        height: 5rem !important;
        transition: background 0.3s, border 0.3s, box-shadow 0.3s, padding 0.3s !important;
    }
    
    html.sidebar-collapsed #sidebar .user-welcome a {
        justify-content: center !important;
        padding: 0 !important;
        background: transparent !important;
    }
    
    html.sidebar-collapsed #sidebar .user-welcome a:hover {
        background: transparent !important;
    }
    
    html.sidebar-collapsed #sidebar .sidebar-header {
        justify-content: center !important;
    }
    
    html.sidebar-collapsed #sidebar .sidebar-nav a {
        justify-content: center !important;
        min-height: 3rem !important;
        height: 3rem !important;
    }
    
    html.sidebar-collapsed #sidebar .sidebar-nav h4 {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        transition: none !important;
    }

    /* Sidebar styles */
    #sidebar {
        background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-900) 100%);
        box-shadow: var(--shadow-strong);
        border-right: 1px solid var(--primary-700);
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    /* Custom scrollbar for sidebar */
    #sidebar::-webkit-scrollbar {
        width: 6px;
    }
    
    #sidebar::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
    }
    
    #sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Smooth scrolling for sidebar */
    #sidebar {
        scroll-behavior: smooth;
    }
    
    /* Ensure sidebar content doesn't get cut off */
    #sidebar .sidebar-nav {
        padding-bottom: 2rem;
    }
    
    /* Make sure the sidebar container takes full height */
    .relative.flex {
        min-height: 100vh;
    }
    
    /* Ensure sidebar is part of document flow */
    #sidebar {
        position: sticky;
        top: 0;
        z-index: 40;
        height: 100vh;
        max-height: 100vh;
        overflow-y: auto;
    }
    
    /* Remove any fixed positioning */
    #sidebar.fixed {
        position: relative !important;
    }
    
    #sidebar.w-20 .sidebar-text {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        overflow: hidden !important;
        transition: none !important;
    }
    
    #sidebar.w-20 .sidebar-nav a {
        justify-content: center;
        padding: 0.75rem;
        min-height: 3rem !important;
        height: 3rem !important;
    }
    
    #sidebar.w-20 .sidebar-nav h4 {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        white-space: nowrap !important;
        transition: none !important;
    }
    
    #sidebar.w-20 .sidebar-nav a.bg-gradient-to-r {
        background: transparent;
        border: none;
    }
    
    #sidebar.w-20 .sidebar-nav a.bg-gradient-to-r i {
        filter: brightness(1.5);
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    #sidebar.w-20 .user-welcome {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0.5rem !important;
        margin-bottom: 1rem !important;
        display: flex !important;
        justify-content: center !important;
        opacity: 1;
        transform: translateY(0);
        /* Mantener la altura fija */
        min-height: 5rem !important;
        height: 5rem !important;
        transition: background 0.3s, border 0.3s, box-shadow 0.3s, padding 0.3s !important;
    }
    
    #sidebar.w-20 .user-welcome a {
        justify-content: center !important;
        padding: 0 !important;
        background: transparent !important;
    }
    
    #sidebar.w-20 .user-welcome a:hover {
        background: transparent !important;
    }
    
    #sidebar.w-20 .sidebar-header {
        justify-content: center;
        padding: 0 0.5rem;
    }
    
    #sidebar.w-20 .sidebar-header .group {
        flex: none;
    }
    
    /* Smooth transitions for text visibility */
    .sidebar-text {
        opacity: 1;
        visibility: visible;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
    }
    
    .user-welcome {
        opacity: 1;
        transform: translateY(0);
        /* Altura fija para evitar rebote */
        min-height: 5rem;
        height: 5rem;
        display: flex;
        align-items: center;
        transition: background 0.3s, border 0.3s, box-shadow 0.3s, padding 0.3s;
    }
    
    #sidebar-toggle {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 0.5rem;
    }
    
    #sidebar-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
    }
    
    .sidebar-nav a {
        position: relative;
        overflow: hidden;
        border-radius: 0.75rem;
        margin-bottom: 0.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .sidebar-nav a::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
    }
    
    .sidebar-nav a:hover::before {
        left: 100%;
    }
    
    .sidebar-nav a:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
    }
    
    .sidebar-nav a.bg-primary-600 {
        background: linear-gradient(135deg, var(--accent-500) 0%, var(--accent-600) 100%);
        box-shadow: var(--shadow-md);
    }
    
    .sidebar-nav a.bg-primary-600:hover {
        background: linear-gradient(135deg, var(--accent-600) 0%, var(--accent-700) 100%);
        transform: translateX(4px) scale(1.02);
    }
    
    .main-content {
        min-height: 100vh;
    }
    
    .user-welcome {
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--accent-50) 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--primary-200);
    }
    
    #sidebar-toggle {
        cursor: pointer !important;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        min-width: 2.5rem;
        min-height: 2.5rem;
    }
    
    #sidebar-toggle:hover {
        background-color: rgba(255, 255, 255, 0.15) !important;
        border-color: rgba(251, 191, 36, 0.6) !important;
        transform: scale(1.05);
    }
    
    #sidebar-toggle:active {
        transform: scale(0.95);
    }
    
    .sidebar-nav a {
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        padding: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        min-height: 3rem;
        height: 3rem;
        background: transparent;
        border: none;
        transition: background 0.3s ease, transform 0.3s ease;
        position: relative;
        white-space: nowrap;
        overflow: hidden;
    }
    
    .sidebar-nav a:hover {
        transform: none;
    }
    
    .sidebar-nav a.bg-gradient-to-r {
        transform: none;
        box-shadow: none;
    }
    
    /* Icon and text spacing */
    .sidebar-nav a {
        gap: 0.75rem;
    }
    
    .sidebar-nav a i {
        font-size: 1.25rem;
        transition: filter 0.3s ease;
        filter: brightness(0.7);
        flex-shrink: 0;
        opacity: 1;
        transform: none;
        position: static;
        width: 1.25rem;
        height: 1.25rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    #sidebar.w-20 .sidebar-nav a i {
        opacity: 1;
        transform: none;
        position: static;
        transition: filter 0.3s ease;
    }
    
    .sidebar-nav a:hover i {
        filter: brightness(1);
    }
    
    .sidebar-nav a.bg-gradient-to-r i {
        filter: brightness(1.5);
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .sidebar-nav a .sidebar-text {
        flex: 1;
        font-weight: 500;
    }
    
    /* Ensure all navigation links have consistent styling */
    .sidebar-nav a {
        text-decoration: none;
        color: inherit;
    }
    
    .sidebar-nav a:hover {
        text-decoration: none;
        color: inherit;
    }
    
    /* Consistent button styles */
    .sidebar-nav a,
    label[for="sidebar-toggle-checkbox"] {
        transition: all 0.3s ease;
    }
    
    /* Simple sidebar toggle */
    #sidebar-toggle-checkbox {
        display: none;
    }
    
    /* When checkbox is checked, collapse sidebar */
    #sidebar-toggle-checkbox:checked + .relative #sidebar {
        width: 5rem; /* w-20 */
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .sidebar-text {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        overflow: hidden !important;
        transition: none !important;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .user-welcome {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0.5rem !important;
        margin-bottom: 1rem !important;
        display: flex !important;
        justify-content: center !important;
        /* Mantener la altura fija */
        min-height: 5rem !important;
        height: 5rem !important;
        transition: background 0.3s, border 0.3s, box-shadow 0.3s, padding 0.3s !important;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .user-welcome a {
        justify-content: center !important;
        padding: 0 !important;
        background: transparent !important;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .user-welcome a:hover {
        background: transparent !important;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .sidebar-header {
        justify-content: center;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .sidebar-nav a {
        justify-content: center;
        min-height: 3rem !important;
        height: 3rem !important;
    }
    
    #sidebar-toggle-checkbox:checked + .relative #sidebar .sidebar-nav h4 {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        white-space: nowrap !important;
        transition: none !important;
    }
    
    /* Estilo espec√≠fico para el bot√≥n de cerrar sesi√≥n */
    .sidebar-nav a[href*="logout"] {
        background: transparent !important;
        border: none !important;
    }
    
    .sidebar-nav a[href*="logout"]:hover {
        background: rgba(239, 68, 68, 0.2) !important;
    }
    
    /* Smooth transitions for dropdowns */
    [x-cloak] {
        display: none !important;
    }
    
    /* Altura fija para la secci√≥n de navegaci√≥n para evitar rebotes */
    .sidebar-nav > div {
        min-height: fit-content;
    }
    
    /* Asegurar que los t√≠tulos de secci√≥n tengan altura consistente */
    .sidebar-nav h4 {
        min-height: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
        transition: none;
        white-space: nowrap;
        overflow: hidden;
    }
    
    /* Transici√≥n suave solo para el ancho del sidebar */
    #sidebar {
        transition: width 0.3s ease-in-out;
    }
    
    /* Desactivar transiciones en elementos internos para evitar rebote */
    #sidebar * {
        transition-property: background, border, box-shadow, color, transform, filter;
        transition-duration: 0.3s;
    }
    
    /* Excepci√≥n: NO animar cambios de tama√±o, display, visibility u opacity */
    #sidebar .sidebar-text,
    #sidebar .sidebar-nav h4 {
        transition: none !important;
    }
</style>
{% endblock %}
</head>
<body class="bg-gray-50 font-outfit">
<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none">
    <!-- Los toasts aparecer√°n aqu√≠ din√°micamente -->
</div>

<!-- Sidebar Toggle with CSS only - no JavaScript -->
<input type="checkbox" id="sidebar-toggle-checkbox" class="hidden">

<div class="relative flex min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="w-64 text-white p-4 pb-8 transition-all duration-300 ease-in-out min-h-screen max-h-screen overflow-y-auto overflow-x-hidden flex-shrink-0">
        <!-- Sidebar Header -->
        <div class="sidebar-header flex items-center justify-between mb-8 px-1">
            <div class="flex items-center sidebar-text group flex-1">
                <div class="w-10 h-10 bg-gradient-to-br from-accent-400 to-accent-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-cog text-white text-xl"></i>
                </div>
                <span class="sidebar-text text-lg font-normal text-white ml-3 bg-gradient-to-r from-white to-accent-100 bg-clip-text text-transparent whitespace-nowrap">Panel</span>
            </div>
            <button type="button" onclick="document.getElementById('sidebar-toggle-checkbox').click()" class="w-10 h-10 flex items-center justify-center text-white hover:text-accent-200 focus:outline-none focus:ring-2 focus:ring-accent-400 focus:ring-opacity-50 rounded-xl hover:bg-white/10 transition-all duration-300 border border-accent-400/30 hover:border-accent-300 cursor-pointer">
                <i class="fas fa-bars text-lg"></i>
            </button>
        </div>

        <!-- User Welcome Card -->
        <div class="user-welcome mb-6">
            <a href="{% url 'profile' %}" class="flex items-center p-2 rounded-lg hover:bg-white/10 transition-all duration-200 group">
                {% if user.profile_image %}
                    <img src="{{ user.profile_image.url }}" alt="{{ user.username }}" class="w-12 h-12 rounded-full object-cover shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-105">
                {% else %}
                <div class="w-12 h-12 bg-gradient-to-br from-accent-400 to-accent-600 rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-105">
                    <i class="fas fa-user text-white text-lg"></i>
                </div>
                {% endif %}
                <div class="ml-3 sidebar-text">
                    <h3 class="font-semibold text-gray-800 text-sm transition-colors duration-200">{{ user.first_name|default:user.username }}</h3>
                    <p class="text-primary-600 text-xs font-medium transition-colors duration-200">{{ user.role }}</p>
                </div>
            </a>
        </div>

        <nav class="text-white sidebar-nav px-0">
            <!-- Navegaci√≥n Principal -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Men√∫</span></h4>
                <a href="{% url 'index' %}" class="mb-3 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'index' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-home w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Inicio</span>
                </a>
                
                <a href="{% url 'marketplace' %}" class="mb-3 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'marketplace' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-store w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Tienda</span>
                </a>
            </div>
            
            <!-- Dashboard y Perfil -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Cuenta</span></h4>
                {% if user.role == 'Productor' %}
                <a href="{% url 'producer_dashboard' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'producer_dashboard' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Panel</span>
                </a>
                
                <!-- Mis Fincas - Primera opci√≥n para productores -->
                <a href="{% url 'core:farm_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'farm_list' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-tractor w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Fincas</span>
                </a>
                
                <!-- Mis Cultivos - Segunda opci√≥n para productores -->
                <a href="{% url 'crop_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'crop_list' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-seedling w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Cultivos</span>
                </a>
                {% elif user.role == 'Comprador' %}
                <a href="{% url 'buyer_dashboard' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'buyer_dashboard' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Panel</span>
                </a>
                
                <!-- Opci√≥n para convertirse en vendedor - Solo para compradores -->
                <a href="{% url 'become_seller' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'become_seller' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-store w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Ser Vendedor</span>
                </a>
                {% endif %}
            </div>
            
            <!-- Funcionalidades Espec√≠ficas por Rol -->
            {% if user.role == 'Productor' %}
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Productos</span></h4>
                <a href="{% url 'my_publications' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'my_publications' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-bullhorn w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Publicaciones</span>
                </a>
                <a href="{% url 'producer_sales' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'producer_sales' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-chart-line w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Ventas</span>
                </a>
            </div>
            {% endif %}
            
            <!-- Comunicaci√≥n y Pedidos -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Mensajes</span></h4>
                <a href="{% url 'conversation_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'conversation_list' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-comments w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Chats</span>
                </a>
                <a href="{% url 'core:notifications_page' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'notifications_page' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <div class="relative">
                        <i class="fas fa-bell w-5"></i>
                        <span id="sidebar-notifications-badge" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold rounded-full h-4 min-w-[1rem] px-1 flex items-center justify-center shadow-lg"></span>
                    </div>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Alertas</span>
                </a>
            </div>
            
            <!-- Pedidos y Compras -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Pedidos</span></h4>
                <a href="{% url 'order_history' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'order_history' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-shopping-cart w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">{% if user.role == 'Productor' %}Compras{% else %}Pedidos{% endif %}</span>
                </a>
            </div>
            
            <!-- Ayuda y Documentaci√≥n -->
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Ayuda</span></h4>
                <a href="{% url 'core:documentation' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'documentation' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-book w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Docs</span>
                </a>
            </div>
            
            <!-- Panel de Administraci√≥n (solo para staff) -->
            {% if user.is_staff %}
            <div class="mb-6">
                <h4 class="text-xs font-semibold text-primary-300 uppercase tracking-wider mb-3 sidebar-text whitespace-nowrap"><span class="section-title">Administraci√≥n</span></h4>
                
                <a href="{% url 'admin_dashboard' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if request.resolver_match.url_name == 'admin_dashboard' %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Dashboard</span>
                </a>
                
                <a href="{% url 'admin_user_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if 'admin_user' in request.resolver_match.url_name %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-users w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Usuarios</span>
                </a>
                
                <a href="{% url 'admin_crop_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if 'admin_crop' in request.resolver_match.url_name %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-seedling w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Cultivos</span>
                </a>
                
                <a href="{% url 'admin_publication_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if 'admin_publication' in request.resolver_match.url_name %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-store w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Publicaciones</span>
                </a>
                
                <a href="{% url 'admin_order_list' %}" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200 {% if 'admin_order' in request.resolver_match.url_name %}bg-gradient-to-r from-accent-500 to-accent-600{% endif %}">
                    <i class="fas fa-shopping-cart w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Pedidos</span>
                </a>
                
                <a href="/admin/" target="_blank" class="mb-2 flex items-center px-3 py-2 rounded-lg hover:bg-white/10 transition-all duration-200">
                    <i class="fas fa-cog w-5"></i>
                    <span class="sidebar-text ml-3 whitespace-nowrap">Django Admin</span>
                </a>
            </div>
            {% endif %}
            
            <!-- Divider -->
            <div class="border-t border-primary-700 my-4"></div>
            
            <a href="{% url 'logout' %}" class="flex items-center px-3 py-2 rounded-lg hover:bg-red-500/20 transition-all duration-200 text-red-300 hover:text-white">
                <i class="fas fa-sign-out-alt w-5"></i>
                <span class="sidebar-text ml-3 whitespace-nowrap">Salir</span>
            </a>
        </nav>
    </div>

    <!-- Main content -->
    <div id="main-content" class="flex-1 transition-all duration-300 ease-in-out bg-gray-50">
        <!-- Content Area -->
        <div class="p-4 mx-auto max-w-screen-2xl md:p-6 2xl:p-10">
            {% block user_content %}{% endblock %}
        </div>
    </div>
</div>

<!-- JavaScript mejorado para sidebar state persistence -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('sidebar-toggle-checkbox');
    
    // Sincronizar checkbox con el estado actual
    const savedState = localStorage.getItem('sidebarCollapsed');
    if (savedState === 'true') {
        checkbox.checked = true;
    }
    
    // Manejar cambios del checkbox
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            document.documentElement.classList.add('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', 'true');
        } else {
            document.documentElement.classList.remove('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', 'false');
        }
    });
});
</script>

<!-- Custom JS -->
<script src="{% static 'js/main.js' %}"></script>

<!-- Toast Notification System -->
<script>
    // Sistema de notificaciones toast
    window.showToast = function(message, type = 'success', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        // Crear el elemento toast
        const toast = document.createElement('div');
        toast.className = 'toast-notification pointer-events-auto transform transition-all duration-300 ease-out translate-x-96 opacity-0';
        
        // Definir colores e iconos seg√∫n el tipo
        const types = {
            success: {
                bg: 'bg-gradient-to-r from-green-500 to-green-600',
                icon: 'fa-check-circle',
                iconBg: 'bg-green-700'
            },
            error: {
                bg: 'bg-gradient-to-r from-red-500 to-red-600',
                icon: 'fa-times-circle',
                iconBg: 'bg-red-700'
            },
            warning: {
                bg: 'bg-gradient-to-r from-yellow-500 to-yellow-600',
                icon: 'fa-exclamation-triangle',
                iconBg: 'bg-yellow-700'
            },
            info: {
                bg: 'bg-gradient-to-r from-blue-500 to-blue-600',
                icon: 'fa-info-circle',
                iconBg: 'bg-blue-700'
            }
        };
        
        const config = types[type] || types.success;
        
        toast.innerHTML = `
            <div class="${config.bg} text-white px-4 py-3 rounded-xl shadow-2xl flex items-center space-x-3 min-w-[320px] max-w-md">
                <div class="${config.iconBg} rounded-lg p-2 flex items-center justify-center">
                    <i class="fas ${config.icon} text-lg"></i>
                </div>
                <p class="flex-1 font-medium text-sm">${message}</p>
                <button onclick="this.closest('.toast-notification').remove()" class="hover:bg-white/20 rounded-lg p-1.5 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        `;
        
        // Agregar al contenedor
        container.appendChild(toast);
        
        // Animar entrada
        setTimeout(() => {
            toast.classList.remove('translate-x-96', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
        }, 10);
        
        // Auto-remover despu√©s de la duraci√≥n
        setTimeout(() => {
            toast.classList.remove('translate-x-0', 'opacity-100');
            toast.classList.add('translate-x-96', 'opacity-0');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, duration);
    };
    
    // Manejar mensajes de Django
    {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                showToast(
                    '{{ message|escapejs }}',
                    '{{ message.tags|default:"info" }}'.replace('error', 'error').replace('success', 'success').replace('warning', 'warning').replace('info', 'info'),
                    4000
                );
            {% endfor %}
        });
    {% endif %}
</script>

{% block extra_js %}{% endblock %}

<!-- Floating AI Assistant Bubble -->
<div id="assistant-bubble" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-40">
    <button id="assistant-toggle" class="w-12 h-12 md:w-14 md:h-14 rounded-full shadow-strong bg-gradient-to-br from-primary-500 to-primary-700 text-white flex items-center justify-center hover:scale-105 transition-transform">
        <i class="fas fa-robot text-lg md:text-xl"></i>
    </button>
    <div id="assistant-panel" class="hidden mt-3 w-[calc(100vw-2rem)] max-w-[20rem] sm:w-[24rem] md:w-[28rem] lg:w-[32rem] bg-white rounded-2xl shadow-strong border border-gray-200 overflow-hidden" style="height: 28rem;">
        <div class="px-3 py-2 md:px-4 md:py-3 bg-primary-600 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-robot text-sm md:text-base"></i>
                    <span class="font-semibold text-sm md:text-base">Asistente IA ¬∑ AgroConnect</span>
            </div>
            <button id="assistant-close" class="text-white/80 hover:text-white"><i class="fas fa-times text-sm md:text-base"></i></button>
        </div>
        </div>
        <div class="border-b border-gray-200 flex">
            <button id="tab-ai" class="flex-1 px-2 py-2 md:px-3 text-xs md:text-sm font-medium bg-white">Asistente</button>
            <button id="tab-chat" class="flex-1 px-2 py-2 md:px-3 text-xs md:text-sm text-gray-600 bg-gray-100">Chats</button>
        </div>
        <div id="assistant-title" class="px-3 py-1 md:px-4 md:py-2 text-xs text-gray-600 bg-white border-b">Nueva conversaci√≥n</div>
        <div id="assistant-messages" class="overflow-y-auto p-3 md:p-4 space-y-2 md:space-y-3 bg-gray-50" style="height: 16rem;">
            <div class="text-sm text-gray-700 bg-white rounded-xl p-3 shadow-soft">
                Hola, ¬øen qu√© te ayudo hoy?
                </div>
                </div>
        <div id="chat-pane" class="hidden bg-gray-50 flex flex-col" style="height: 16rem;">
            <!-- View: conversations list only -->
            <div id="chat-list-view" class="h-full flex flex-col">
                <div class="p-2 md:p-3 border-b bg-white flex-shrink-0">
                    <input id="chat-search" type="text" placeholder="Buscar..." class="w-full text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
                <div id="chat-list" class="flex-1 overflow-y-auto p-1 md:p-2 space-y-1 bg-white"></div>
        </div>
            <!-- View: thread with back button -->
            <div id="chat-thread-view" class="hidden h-full flex flex-col">
                <div class="flex items-center justify-between px-2 md:px-3 py-2 border-b bg-white flex-shrink-0">
                    <button id="chat-back" class="text-primary-700 text-xs md:text-sm px-2 py-1 rounded hover:bg-primary-50"><i class="fas fa-arrow-left mr-1"></i>Atr√°s</button>
                    <div id="chat-thread-title" class="text-xs md:text-sm text-gray-700 truncate ml-2 flex-1"></div>
                </div>
                <div id="chat-thread" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-1 md:space-y-2 bg-gray-50"></div>
                <form id="chat-form" class="flex items-center p-2 md:p-3 border-t border-gray-200 bg-white flex-shrink-0">
                    <input id="chat-input" type="text" class="flex-1 text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Escribe un mensaje..." required>
                    <button id="chat-send" class="ml-2 md:ml-3 px-2 md:px-3 py-1 md:py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <i class="fas fa-paper-plane text-xs md:text-sm"></i>
                    </button>
                </form>
            </div>
        </div>
        <form id="assistant-form" class="flex items-center p-2 md:p-3 border-t border-gray-200 bg-white">
            <input id="assistant-input" type="text" class="flex-1 text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 placeholder:text-sm" placeholder="Pregunta sobre la plataforma..." required>
            <button id="assistant-send" class="ml-2 md:ml-3 px-2 md:px-3 py-1 md:py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                <i class="fas fa-paper-plane text-xs md:text-sm"></i>
            </button>
        </form>
    </div>
</div>

<!-- Assistant Bubble Logic -->
<script>
    (function(){
    const bubble = document.getElementById('assistant-bubble');
        if (!bubble) return;
    const panel = document.getElementById('assistant-panel');
    const toggle = document.getElementById('assistant-toggle');
    const closeBtn = document.getElementById('assistant-close');
    const form = document.getElementById('assistant-form');
    const input = document.getElementById('assistant-input');
    const messages = document.getElementById('assistant-messages');
    const aiTitle = document.getElementById('assistant-title');
    const sendBtn = document.getElementById('assistant-send');
        const tabAI = document.getElementById('tab-ai');
        const tabChat = document.getElementById('tab-chat');
        const chatPane = document.getElementById('chat-pane');
        const chatList = document.getElementById('chat-list');
        const chatThread = document.getElementById('chat-thread');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatListView = document.getElementById('chat-list-view');
        const chatThreadView = document.getElementById('chat-thread-view');
        const chatBack = document.getElementById('chat-back');
        const chatTitle = document.getElementById('chat-thread-title');
        let activeConversationId = null;
        let lastMsgId = 0;
        let polling = false;
        let conversationsCache = [];

        function appendMessage(text, from){
            const div = document.createElement('div');
            div.className = `text-sm rounded-xl p-3 shadow-soft ${from === 'user' ? 'bg-primary-600 text-white ml-10' : 'bg-white text-gray-800 mr-10'}`;
            if (from === 'bot'){
                // Render minimal markdown: **bold** and '- ' lists
                const html = (text || '')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
                    .split('\n')
                    .map(line => line.trim().startsWith('- ')
                        ? `<li>${line.trim().substring(2)}</li>`
                        : `<p>${line}</p>`)
                    .join('');
                div.innerHTML = html.includes('<li>') ? `<ul class="list-disc ml-4 space-y-1">${html}<\/ul>` : html;
            } else {
                div.textContent = text;
            }
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function setTyping(state){
            let el = document.getElementById('assistant-typing');
            if (state){
                if (!el){
                    el = document.createElement('div');
                    el.id = 'assistant-typing';
                    el.className = 'text-xs text-gray-600 italic mr-10 px-3 py-2';
                    el.textContent = 'El asistente est√° escribiendo‚Ä¶';
                    messages.appendChild(el);
                    messages.scrollTop = messages.scrollHeight;
                }
            } else if (el){
                el.remove();
            }
        }

        function setTitleIfEmpty(fromText){
            try{
                if (fromText){
                    const t = fromText.trim().replace(/\s+/g,' ').slice(0,60);
                    aiTitle.textContent = t || 'Nueva conversaci√≥n';
                } else {
                    aiTitle.textContent = 'Nueva conversaci√≥n';
                }
            }catch(_){/* ignore */}
        }

        // Resetear t√≠tulo al cargar la p√°gina
        setTitleIfEmpty('');

        function getCookie(name){
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        toggle.addEventListener('click', ()=>{ panel.classList.toggle('hidden'); });
        closeBtn.addEventListener('click', ()=>{ panel.classList.add('hidden'); });

        // Tabs
        if (tabAI && tabChat){
            tabAI.addEventListener('click', ()=>{
                tabAI.classList.remove('text-gray-600','bg-gray-100');
                tabAI.classList.add('font-medium','bg-white');
                tabChat.classList.remove('font-medium','bg-white');
                tabChat.classList.add('text-gray-600','bg-gray-100');
                aiTitle.classList.remove('hidden');
                messages.classList.remove('hidden');
                form.classList.remove('hidden');
                chatPane.classList.add('hidden');
            });
            tabChat.addEventListener('click', ()=>{
                tabChat.classList.remove('text-gray-600','bg-gray-100');
                tabChat.classList.add('font-medium','bg-white');
                tabAI.classList.remove('font-medium','bg-white');
                tabAI.classList.add('text-gray-600','bg-gray-100');
                aiTitle.classList.add('hidden');
                messages.classList.add('hidden');
                form.classList.add('hidden');
                chatPane.classList.remove('hidden');
                // Start in list view
                if (chatListView && chatThreadView){
                    chatListView.classList.remove('hidden');
                    chatThreadView.classList.add('hidden');
                }
                loadConversations();
            });
        }

        form.addEventListener('submit', function(e){
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            input.value = '';
            sendBtn.disabled = true;
            setTyping(true);
            const csrftoken = getCookie('csrftoken');
            setTitleIfEmpty(text);
        fetch('{% url "core:assistant_reply" %}', {
            method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                credentials: 'same-origin',
                body: JSON.stringify({ message: text })
            }).then(r=>r.json()).then(res=>{
                setTyping(false);
                if (res && res.success){
                    appendMessage(res.reply + (res.model && res.model !== 'fallback' ? `\n\n` : ''), 'bot');
                    if (res.model && res.model !== 'fallback'){
                        const modelTag = document.createElement('div');
                        modelTag.className = 'text-[10px] text-gray-500 mt-1 mr-10 text-right';
                        modelTag.textContent = `Respuesta IA: ${res.model}`;
                        messages.appendChild(modelTag);
                    }
                } else { appendMessage('Lo siento, hubo un problema. Intenta de nuevo.', 'bot'); }
            }).catch(()=>{
                setTyping(false);
                appendMessage('No pude conectar con el asistente.', 'bot');
            }).finally(()=>{
                sendBtn.disabled = false;
        });
    });
    
        // Mini chat helpers
        function renderConvList(items){
            chatList.innerHTML = '';
            (items || []).forEach(c => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-primary-50';
                btn.innerHTML = `<div class="font-medium">${c.other_user}</div><div class="text-xs text-gray-600 truncate">${c.last_message || ''}</div>`;
                btn.addEventListener('click', ()=>{
                    activeConversationId = c.id;
                    chatThread.innerHTML = '';
                    lastMsgId = 0;
                    // Switch to thread view
                    if (chatListView && chatThreadView){
                        chatListView.classList.add('hidden');
                        chatThreadView.classList.remove('hidden');
                    }
                    if (chatTitle){ chatTitle.textContent = c.other_user || 'Chat'; }
                    pollMessages();
                });
                chatList.appendChild(btn);
            });
        }

        function loadConversations(){
            // Only last 15 days
            const since = new Date(Date.now() - 15*24*60*60*1000).toISOString().slice(0,10);
            fetch(`/api/conversations/?since=${since}`, { credentials: 'same-origin' })
              .then(r=>r.json()).then(res=>{
                if (res && res.success){
                    conversationsCache = res.conversations || [];
                    renderConvList(conversationsCache);
                    // Mostrar aviso si hay archivadas
                    if ((res.archived_count||0) > 0){
                        const note = document.createElement('div');
                        note.className = 'text-xs text-gray-600 px-3 py-2';
                        note.innerHTML = `Tienes ${res.archived_count} conversaciones archivadas (&gt;15 d√≠as). <a href="/conversations/" class="text-primary-700 underline">Ver panel</a>`;
                        chatList.prepend(note);
                    }
                }
              }).catch(()=>{});
        }

        // Filtro de conversaciones
        const chatSearch = document.getElementById('chat-search');
        if (chatSearch){
            chatSearch.addEventListener('input', function(){
                const q = this.value.toLowerCase().trim();
                const filtered = conversationsCache.filter(c =>
                    (c.other_user||'').toLowerCase().includes(q) || (c.last_message||'').toLowerCase().includes(q)
                );
                renderConvList(filtered);
            });
        }

        function pollMessages(){
            if (!activeConversationId || polling) return;
            polling = true;
            fetch(`/conversation/${activeConversationId}/messages/?since=${lastMsgId}`, { credentials: 'same-origin' })
              .then(r=>r.json()).then(data=>{
                (data.messages||[]).forEach(m=>{
                    const div = document.createElement('div');
                    const own = Number('{{ user.id|default:0 }}') === m.sender_id;
                    div.className = `text-sm rounded-xl p-2 ${own ? 'bg-primary-600 text-white ml-10' : 'bg-white text-gray-800 mr-10'}`;
                    div.textContent = m.content;
                    chatThread.appendChild(div);
                    lastMsgId = Math.max(lastMsgId, m.id);
                    chatThread.scrollTop = chatThread.scrollHeight;
                });
                polling = false;
              }).catch(()=>{ polling = false; });
        }

        setInterval(()=>{ if (chatPane && !chatPane.classList.contains('hidden') && activeConversationId) pollMessages(); }, 500);

        // Back button to conversations list
        if (chatBack){
            chatBack.addEventListener('click', function(){
                activeConversationId = null;
                if (chatListView && chatThreadView){
                    chatThreadView.classList.add('hidden');
                    chatListView.classList.remove('hidden');
                    chatThread.innerHTML = '';
                }
            });
        }

        chatForm.addEventListener('submit', function(e){
            e.preventDefault();
            if (!activeConversationId){
                const warn = document.createElement('div');
                warn.className = 'text-xs text-red-600 px-3 pb-2';
                warn.textContent = 'Primero selecciona una conversaci√≥n.';
                chatThread.prepend(warn);
                setTimeout(()=> warn.remove(), 3000);
                return;
            }
            const text = chatInput.value.trim();
            if (!text) return;
            const fd = new FormData();
            fd.append('content', text);
            fd.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            fetch(`/conversation/${activeConversationId}/`, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
              .then(r=>r.json()).then(res=>{
                if (res && res.success){
                    const div = document.createElement('div');
                    div.className = 'text-sm rounded-xl p-2 bg-primary-600 text-white ml-10';
                    div.textContent = res.message.content;
                    chatThread.appendChild(div);
                    lastMsgId = Math.max(lastMsgId, res.message.id);
                    chatInput.value = '';
                    chatThread.scrollTop = chatThread.scrollHeight;
                } else if (res && res.archived){
                    // Si la conversaci√≥n est√° archivada, redirigir al panel completo
                    window.location.href = '/conversations/';
                }
              }).catch(()=>{});
        });
    })();
</script>

<script>
// Polling para notificaciones del sidebar
(function() {
    let pollingInterval = null;
    
    function updateSidebarBadge(count) {
        const badge = document.getElementById('sidebar-notifications-badge');
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count > 9 ? '9+' : String(count);
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    function fetchSidebarNotifications() {
        fetch('{% url "core:notifications_list" %}', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(res => {
                if (res && res.success) {
                    const unreadCount = res.notifications.filter(n => !n.is_read).length;
                    updateSidebarBadge(unreadCount);
                    console.log('Notifications polled:', unreadCount, 'unread');
                }
            })
            .catch((error) => {
                console.log('Polling error:', error);
            });
    }
    
    function startSidebarPolling() {
        if (pollingInterval) return; // Already polling
        pollingInterval = setInterval(fetchSidebarNotifications, 500); // Poll every 0.5 seconds
    }
    
    function stopSidebarPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }
    
    // Start polling when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateSidebarBadge(0);
        // Fetch notifications immediately
        fetchSidebarNotifications();
        // Start polling for notifications
        startSidebarPolling();
        console.log('Notifications polling started');
    });
    
    // Stop polling when page is hidden (performance optimization)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopSidebarPolling();
        } else {
            startSidebarPolling();
        }
    });
})();
</script>

</body>
</html>