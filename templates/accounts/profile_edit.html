{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar Perfil{% endblock %}

{% block extra_head %}
<!-- Critical script to ensure dark mode is preserved -->
<script>
    // Apply theme IMMEDIATELY before rendering - must run before any other scripts
    (function() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            // Default to system preference if no saved theme
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
    })();
</script>
<style>
    /* Dark mode inputs in profile edit form */
    .dark input, .dark select, .dark textarea {
        background-color: #374151 !important;
        border-color: #4b5563 !important;
        color: #f9fafb !important;
    }
    
    .dark input::placeholder, .dark textarea::placeholder {
        color: #9ca3af !important;
    }
    
    .dark label {
        color: #e5e7eb !important;
    }
    
    /* Dark mode dividers */
    .dark .border-gray-300 {
        border-color: #475569 !important;
    }
    
    .dark .text-gray-500 {
        color: #94a3b8 !important;
    }
    
    .dark .bg-white {
        background-color: #1e293b !important;
    }
    
    .dark .text-gray-700 {
        color: #cbd5e1 !important;
    }

    .profile-glass {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 32px;
        padding: 2.5rem;
        border: 1px solid rgba(15, 118, 110, 0.08);
        box-shadow: 0 35px 80px rgba(4, 15, 11, 0.25);
    }

    .dark .profile-glass {
        background: rgba(15, 23, 42, 0.78);
        border-color: rgba(148, 163, 184, 0.18);
        backdrop-filter: blur(24px);
    }

    .profile-section {
        border-radius: 24px;
        border: 1px solid rgba(147, 197, 253, 0.25);
        padding: 1.75rem 1.9rem;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 20px 45px rgba(15, 118, 110, 0.08);
    }

    .dark .profile-section {
        background: rgba(17, 24, 39, 0.72);
        border-color: rgba(56, 189, 248, 0.25);
    }

    /* Ocultar el input file nativo */
    input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
    }
    
    /* Ocultar elementos del widget ClearableFileInput de Django */
    /* Solo ocultar elementos que vengan directamente del widget, no nuestros elementos personalizados */
    .flex-1 > input[type="checkbox"],
    .flex-1 > input[type="checkbox"] + label:not(.profile-image-button),
    .flex-1 > a[href*="profile_images"],
    .flex-1 > br:not(.profile-image-controls br) {
        display: none !important;
    }
    
    /* Asegurar que nuestros controles personalizados siempre sean visibles */
    .profile-image-controls,
    .profile-image-button {
        display: flex !important;
        visibility: visible !important;
    }
    
    /* Estilos para inputs, selects y textareas del formulario */
    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="tel"],
    form select:not(#id_pais):not(#country-code-select-edit):not(#country-code-select-register):not(#country-code-select-producer),
    form textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.15s ease-in-out;
    }
    
    /* Dark mode para inputs */
    .dark form input[type="text"],
    .dark form input[type="email"],
    .dark form input[type="password"],
    .dark form input[type="tel"],
    .dark form select,
    .dark form textarea {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    /* Focus states */
    form input[type="text"]:focus,
    form input[type="email"]:focus,
    form input[type="password"]:focus,
    form input[type="tel"]:focus,
    form select:focus,
    form textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dark form input[type="text"]:focus,
    .dark form input[type="email"]:focus,
    .dark form input[type="password"]:focus,
    .dark form input[type="tel"]:focus,
    .dark form select:focus,
    .dark form textarea:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    /* Textarea espec√≠fico */
    form textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Select espec√≠fico */
    form select {
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }
    
    .dark form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%9ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    
    /* Campo de pa√≠s con ancho limitado - sobrescribe w-full y otros estilos */
    #id_pais,
    #id_pais.w-full {
        max-width: 180px !important;
        width: 180px !important;
        min-width: 180px !important;
    }
    
    /* Selects de c√≥digo de pa√≠s con ancho uniforme */
    #country-code-select-edit,
    #country-code-select-register,
    #country-code-select-producer {
        max-width: 180px !important;
        width: 180px !important;
        min-width: 180px !important;
    }
    
    /* Asegurar que el contenedor del campo pais tambi√©n respete el ancho */
    #id_pais {
        box-sizing: border-box !important;
    }
    
    /* Labels en modo oscuro */
    .dark label {
        color: #e5e7eb !important;
    }
    
    /* Ocultar completamente el campo pais */
    #id_pais {
        display: none !important;
        visibility: hidden !important;
        position: absolute !important;
        opacity: 0 !important;
        width: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-green-50 via-white to-emerald-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen py-12 px-4 sm:px-6 lg:px-10">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="flex mb-4 items-center justify-center">
                <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="4" r="4" fill="#15803d"></circle>
                </svg>
                <span class="inline-block ml-2 text-sm font-medium text-green-900 dark:text-green-300">Perfil</span>
            </div>
            <h1 class="font-heading text-4xl sm:text-5xl font-bold text-green-900 dark:text-white">
                Editar Perfil
            </h1>
            <p class="text-base lg:text-lg text-gray-600 dark:text-emerald-100/95">
                Actualiza tu informaci√≥n personal y de perfil
            </p>
        </div>

        <!-- Registration Form -->
        <div class="profile-glass">
                <form method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}

                    <!-- Informaci√≥n Personal -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-user text-green-600 dark:text-green-400 mr-3"></i>
                            Informaci√≥n Personal
                        </h2>
                    
                    <!-- Profile Image -->
                    <div class="flex items-center space-x-6 mb-6">
                        <div class="relative">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="Imagen de Perfil" class="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-gray-600 shadow-lg">
                            {% else %}
                                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 dark:from-primary-800 dark:to-primary-900 flex items-center justify-center border-4 border-white dark:border-gray-600 shadow-lg">
                                    <i class="fas fa-user text-3xl text-primary-600 dark:text-primary-300"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1" style="position: relative;">
                            <label for="{{ form.profile_image.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.profile_image.label }}
                            </label>
                            <div class="mt-1 flex items-center gap-3 profile-image-controls">
                                <label for="{{ form.profile_image.id_for_label }}" class="profile-image-button cursor-pointer inline-flex items-center px-4 py-2 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500 dark:focus-within:ring-primary-400 transition-all duration-200 shadow-sm">
                                    <i class="fas fa-upload mr-2 text-gray-500 dark:text-gray-300"></i>
                                    Actualizar
                                </label>
                                <span id="file-name" data-default-text="Ning√∫n archivo seleccionado" class="text-sm text-gray-500 dark:text-gray-400">
                                    {% if user.profile_image %}
                                        {{ user.profile_image.name|cut:"profile_images/" }}
                                    {% else %}
                                        Ning√∫n archivo seleccionado
                                    {% endif %}
                                </span>
                            </div>
                            <div style="position: absolute; opacity: 0; pointer-events: none; width: 0; height: 0; overflow: hidden;">
                                {{ form.profile_image }}
                            </div>
                            {% if form.profile_image.help_text %}
                                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">{{ form.profile_image.help_text }}</p>
                            {% endif %}
                            {% for error in form.profile_image.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.username.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.username }}
                            </div>
                            {% for error in form.username.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.email.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.email }}
                            </div>
                            {% for error in form.email.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.first_name.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.first_name }}
                            </div>
                            {% for error in form.first_name.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.last_name.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.last_name }}
                            </div>
                            {% for error in form.last_name.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.cedula.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.cedula.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.cedula }}
                            </div>
                            {% if form.cedula.help_text %}
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.cedula.help_text }}</p>
                            {% endif %}
                            {% for error in form.cedula.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.telefono.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.telefono.label }}
                            </label>
                            <div class="flex gap-2 mt-1">
                                <select id="country-code-select-edit" class="flex-shrink-0 px-2 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-xs" style="width: 130px; text-align: center; text-align-last: center;">
                                    <option value="+93">Afganist√°n +93</option>
                                    <option value="+355">Albania +355</option>
                                    <option value="+49">Alemania +49</option>
                                    <option value="+376">Andorra +376</option>
                                    <option value="+244">Angola +244</option>
                                    <option value="+1">Antigua y Barbuda +1</option>
                                    <option value="+966">Arabia Saudita +966</option>
                                    <option value="+213">Argelia +213</option>
                                    <option value="+54">Argentina +54</option>
                                    <option value="+374">Armenia +374</option>
                                    <option value="+61">Australia +61</option>
                                    <option value="+43">Austria +43</option>
                                    <option value="+994">Azerbaiy√°n +994</option>
                                    <option value="+1">Bahamas +1</option>
                                    <option value="+973">Bahr√©in +973</option>
                                    <option value="+880">Bangladesh +880</option>
                                    <option value="+1">Barbados +1</option>
                                    <option value="+375">Bielorrusia +375</option>
                                    <option value="+32">B√©lgica +32</option>
                                    <option value="+501">Belice +501</option>
                                    <option value="+229">Ben√≠n +229</option>
                                    <option value="+975">But√°n +975</option>
                                    <option value="+591">Bolivia +591</option>
                                    <option value="+387">Bosnia y Herzegovina +387</option>
                                    <option value="+267">Botsuana +267</option>
                                    <option value="+55">Brasil +55</option>
                                    <option value="+673">Brun√©i +673</option>
                                    <option value="+359">Bulgaria +359</option>
                                    <option value="+226">Burkina Faso +226</option>
                                    <option value="+257">Burundi +257</option>
                                    <option value="+238">Cabo Verde +238</option>
                                    <option value="+855">Camboya +855</option>
                                    <option value="+237">Camer√∫n +237</option>
                                    <option value="+1">Canad√° +1</option>
                                    <option value="+974">Catar +974</option>
                                    <option value="+235">Chad +235</option>
                                    <option value="+56">Chile +56</option>
                                    <option value="+86">China +86</option>
                                    <option value="+357">Chipre +357</option>
                                    <option value="+57">Colombia +57</option>
                                    <option value="+269">Comoras +269</option>
                                    <option value="+242">Congo +242</option>
                                    <option value="+850">Corea del Norte +850</option>
                                    <option value="+82">Corea del Sur +82</option>
                                    <option value="+225">Costa de Marfil +225</option>
                                    <option value="+506">Costa Rica +506</option>
                                    <option value="+385">Croacia +385</option>
                                    <option value="+53">Cuba +53</option>
                                    <option value="+45">Dinamarca +45</option>
                                    <option value="+1">Dominica +1</option>
                                    <option value="+593">Ecuador +593</option>
                                    <option value="+20">Egipto +20</option>
                                    <option value="+503">El Salvador +503</option>
                                    <option value="+971">Emiratos √Årabes Unidos +971</option>
                                    <option value="+291">Eritrea +291</option>
                                    <option value="+421">Eslovaquia +421</option>
                                    <option value="+386">Eslovenia +386</option>
                                    <option value="+34">Espa√±a +34</option>
                                    <option value="+1">Estados Unidos +1</option>
                                    <option value="+372">Estonia +372</option>
                                    <option value="+268">Esuatini +268</option>
                                    <option value="+251">Etiop√≠a +251</option>
                                    <option value="+63">Filipinas +63</option>
                                    <option value="+358">Finlandia +358</option>
                                    <option value="+679">Fiyi +679</option>
                                    <option value="+33">Francia +33</option>
                                    <option value="+241">Gab√≥n +241</option>
                                    <option value="+220">Gambia +220</option>
                                    <option value="+995">Georgia +995</option>
                                    <option value="+233">Ghana +233</option>
                                    <option value="+1">Granada +1</option>
                                    <option value="+30">Grecia +30</option>
                                    <option value="+502">Guatemala +502</option>
                                    <option value="+224">Guinea +224</option>
                                    <option value="+240">Guinea Ecuatorial +240</option>
                                    <option value="+245">Guinea-Bis√°u +245</option>
                                    <option value="+592">Guyana +592</option>
                                    <option value="+509">Hait√≠ +509</option>
                                    <option value="+504">Honduras +504</option>
                                    <option value="+36">Hungr√≠a +36</option>
                                    <option value="+91">India +91</option>
                                    <option value="+62">Indonesia +62</option>
                                    <option value="+98">Ir√°n +98</option>
                                    <option value="+964">Irak +964</option>
                                    <option value="+353">Irlanda +353</option>
                                    <option value="+354">Islandia +354</option>
                                    <option value="+972">Israel +972</option>
                                    <option value="+39">Italia +39</option>
                                    <option value="+1">Jamaica +1</option>
                                    <option value="+81">Jap√≥n +81</option>
                                    <option value="+962">Jordania +962</option>
                                    <option value="+7">Kazajist√°n +7</option>
                                    <option value="+254">Kenia +254</option>
                                    <option value="+996">Kirguist√°n +996</option>
                                    <option value="+686">Kiribati +686</option>
                                    <option value="+965">Kuwait +965</option>
                                    <option value="+856">Laos +856</option>
                                    <option value="+266">Lesoto +266</option>
                                    <option value="+371">Letonia +371</option>
                                    <option value="+961">L√≠bano +961</option>
                                    <option value="+231">Liberia +231</option>
                                    <option value="+218">Libia +218</option>
                                    <option value="+423">Liechtenstein +423</option>
                                    <option value="+370">Lituania +370</option>
                                    <option value="+352">Luxemburgo +352</option>
                                    <option value="+261">Madagascar +261</option>
                                    <option value="+60">Malasia +60</option>
                                    <option value="+265">Malaui +265</option>
                                    <option value="+960">Maldivas +960</option>
                                    <option value="+223">Mal√≠ +223</option>
                                    <option value="+356">Malta +356</option>
                                    <option value="+212">Marruecos +212</option>
                                    <option value="+692">Islas Marshall +692</option>
                                    <option value="+230">Mauricio +230</option>
                                    <option value="+222">Mauritania +222</option>
                                    <option value="+52">M√©xico +52</option>
                                    <option value="+691">Micronesia +691</option>
                                    <option value="+373">Moldavia +373</option>
                                    <option value="+377">M√≥naco +377</option>
                                    <option value="+976">Mongolia +976</option>
                                    <option value="+382">Montenegro +382</option>
                                    <option value="+258">Mozambique +258</option>
                                    <option value="+95">Myanmar +95</option>
                                    <option value="+264">Namibia +264</option>
                                    <option value="+674">Nauru +674</option>
                                    <option value="+977">Nepal +977</option>
                                    <option value="+505">Nicaragua +505</option>
                                    <option value="+227">N√≠ger +227</option>
                                    <option value="+234">Nigeria +234</option>
                                    <option value="+47">Noruega +47</option>
                                    <option value="+64">Nueva Zelanda +64</option>
                                    <option value="+968">Om√°n +968</option>
                                    <option value="+31">Pa√≠ses Bajos +31</option>
                                    <option value="+92">Pakist√°n +92</option>
                                    <option value="+680">Palaos +680</option>
                                    <option value="+507">Panam√° +507</option>
                                    <option value="+675">Pap√∫a Nueva Guinea +675</option>
                                    <option value="+595">Paraguay +595</option>
                                    <option value="+51">Per√∫ +51</option>
                                    <option value="+48">Polonia +48</option>
                                    <option value="+351">Portugal +351</option>
                                    <option value="+44">Reino Unido +44</option>
                                    <option value="+236">Rep√∫blica Centroafricana +236</option>
                                    <option value="+420">Rep√∫blica Checa +420</option>
                                    <option value="+243">Rep. Democr√°tica del Congo +243</option>
                                    <option value="+1">Rep√∫blica Dominicana +1</option>
                                    <option value="+250">Ruanda +250</option>
                                    <option value="+40">Rumania +40</option>
                                    <option value="+7">Rusia +7</option>
                                    <option value="+685">Samoa +685</option>
                                    <option value="+1">San Crist√≥bal y Nieves +1</option>
                                    <option value="+378">San Marino +378</option>
                                    <option value="+1">San Vicente y Granadinas +1</option>
                                    <option value="+1">Santa Luc√≠a +1</option>
                                    <option value="+239">Santo Tom√© y Pr√≠ncipe +239</option>
                                    <option value="+221">Senegal +221</option>
                                    <option value="+381">Serbia +381</option>
                                    <option value="+248">Seychelles +248</option>
                                    <option value="+232">Sierra Leona +232</option>
                                    <option value="+65">Singapur +65</option>
                                    <option value="+963">Siria +963</option>
                                    <option value="+252">Somalia +252</option>
                                    <option value="+94">Sri Lanka +94</option>
                                    <option value="+27">Sud√°frica +27</option>
                                    <option value="+249">Sud√°n +249</option>
                                    <option value="+211">Sud√°n del Sur +211</option>
                                    <option value="+46">Suecia +46</option>
                                    <option value="+41">Suiza +41</option>
                                    <option value="+597">Surinam +597</option>
                                    <option value="+66">Tailandia +66</option>
                                    <option value="+255">Tanzania +255</option>
                                    <option value="+992">Tayikist√°n +992</option>
                                    <option value="+670">Timor Oriental +670</option>
                                    <option value="+228">Togo +228</option>
                                    <option value="+676">Tonga +676</option>
                                    <option value="+1">Trinidad y Tobago +1</option>
                                    <option value="+216">T√∫nez +216</option>
                                    <option value="+993">Turkmenist√°n +993</option>
                                    <option value="+90">Turqu√≠a +90</option>
                                    <option value="+688">Tuvalu +688</option>
                                    <option value="+380">Ucrania +380</option>
                                    <option value="+256">Uganda +256</option>
                                    <option value="+598">Uruguay +598</option>
                                    <option value="+998">Uzbekist√°n +998</option>
                                    <option value="+678">Vanuatu +678</option>
                                    <option value="+379">Vaticano +379</option>
                                    <option value="+58">Venezuela +58</option>
                                    <option value="+84">Vietnam +84</option>
                                    <option value="+967">Yemen +967</option>
                                    <option value="+253">Yibuti +253</option>
                                    <option value="+260">Zambia +260</option>
                                    <option value="+263">Zimbabue +263</option>
                                </select>
                                                                <input type="tel" id="phone-number-input-edit" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-xs" placeholder="N√∫mero de tel√©fono" maxlength="15">
                                {{ form.telefono }}
                                <div style="display: none !important;">
                                    {{ form.pais }}
                                </div>
                            </div>
                            {% if form.telefono.help_text %}
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.telefono.help_text }}</p>
                            {% endif %}
                            {% for error in form.telefono.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.pais.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.pais.label }}
                            </label>
                            <div class="mt-1" style="width: 180px;">
                                {{ form.pais }}
                            </div>
                            {% if form.pais.help_text %}
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.pais.help_text }}</p>
                            {% endif %}
                            {% for error in form.pais.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Ubicaci√≥n -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-map-marker-alt text-green-600 dark:text-green-400 mr-3"></i>
                        Ubicaci√≥n
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.departamento.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.departamento.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.departamento }}
                            </div>
                            {% for error in form.departamento.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.ciudad.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.ciudad.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.ciudad }}
                            </div>
                            {% for error in form.ciudad.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Cambio de Contrase√±a -->
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-lock text-green-600 dark:text-green-400 mr-3"></i>
                        Cambio de Contrase√±a
                    </h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Solo ingresa tu nueva contrase√±a y su confirmaci√≥n si deseas cambiarla.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.new_password.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.new_password.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.new_password }}
                            </div>
                            {% if form.new_password.help_text %}
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.new_password.help_text }}</p>
                            {% endif %}
                            {% for error in form.new_password.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.confirm_password.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.confirm_password.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.confirm_password }}
                            </div>
                            {% for error in form.confirm_password.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos del productor -->
                {% if user.role == 'Productor' %}
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                        <i class="fas fa-tractor text-green-600 dark:text-green-400 mr-3"></i>
                        Informaci√≥n de la Finca
                    </h2>
                    <div class="space-y-6">
                        <div class="field-wrapper">
                            <label for="{{ form.direccion.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.direccion.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.direccion }}
                            </div>
                            {% for error in form.direccion.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.farm_description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.farm_description.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.farm_description }}
                            </div>
                            {% for error in form.farm_description.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.main_crops.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                {{ form.main_crops.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.main_crops }}
                            </div>
                            {% for error in form.main_crops.errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botones de acci√≥n -->
                <div class="flex justify-end items-center space-x-4 pt-8 pb-4 border-t border-gray-200 dark:border-gray-600">
                    <a href="{% url 'profile' %}" class="px-6 py-3 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white font-medium transition-colors duration-200">
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                    <button type="submit" class="inline-flex items-center justify-center py-3 px-8 text-base font-medium text-white bg-green-900 hover:bg-green-800 rounded-full transition duration-200">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Formulario de edici√≥n de perfil cargado');
    
    // Ocultar completamente el campo pais original de Django
    function hidePaisField() {
        const paisInput = document.getElementById('id_pais');
        if (paisInput) {
            paisInput.style.display = 'none';
            paisInput.style.visibility = 'hidden';
            paisInput.style.position = 'absolute';
            paisInput.style.opacity = '0';
            paisInput.style.width = '0';
            paisInput.style.height = '0';
            paisInput.style.overflow = 'hidden';
            paisInput.setAttribute('tabindex', '-1');
            // Ocultar tambi√©n el label si existe
            const paisLabel = document.querySelector('label[for="id_pais"]');
            if (paisLabel) {
                paisLabel.style.display = 'none';
                paisLabel.style.visibility = 'hidden';
            }
            // Ocultar cualquier wrapper o contenedor del campo que contenga "Pa√≠s"
            const allDivs = document.querySelectorAll('div');
            allDivs.forEach(div => {
                const text = div.textContent || '';
                if (div.contains(paisInput) && (text.includes('Pa√≠s') || text.includes('pais')) && div !== paisInput.parentElement) {
                    // Verificar que no sea nuestro div personalizado
                    if (!div.querySelector('#country-code-select-edit')) {
                        div.style.display = 'none';
                    }
                }
            });
        }
    }
    
    // Ejecutar inmediatamente y despu√©s de un peque√±o delay
    hidePaisField();
    setTimeout(hidePaisField, 100);
    setTimeout(hidePaisField, 500);
    
    // Manejar la interacci√≥n entre pa√≠s y tel√©fono
    const countryCodeSelect = document.getElementById('country-code-select-edit');
    const telefonoInput = document.getElementById('id_telefono');
    const visiblePhoneInput = document.getElementById('phone-number-input-edit');
    
    if (countryCodeSelect && telefonoInput && visiblePhoneInput) {
        const defaultCountryCode = '+57';
        const placeholderByCountry = {
            '+1': '555 123 4567',
            '+34': '612 345 678',
            '+44': '7700 900123',
            '+49': '151 12345678',
            '+52': '55 1234 5678',
            '+54': '11 1234 5678',
            '+55': '11 91234 5678',
            '+56': '9 1234 5678',
            '+57': '320 123 4567',
            '+58': '412 123 4567',
            '+61': '412 345 678',
            '+81': '90 1234 5678',
            '+82': '10 1234 5678',
            '+86': '138 0013 8000',
            '+91': '98765 43210',
            '+351': '912 345 678'
        };
        
        telefonoInput.type = 'hidden';
        
        function sanitizeNumber(value) {
            return value.replace(/[^0-9\s]/g, '').replace(/\s+/g, ' ').trim();
        }
        
        function updatePhonePlaceholder() {
            const code = countryCodeSelect.value || defaultCountryCode;
            const placeholder = placeholderByCountry[code] || 'N√∫mero de tel√©fono';
            visiblePhoneInput.placeholder = placeholder;
            visiblePhoneInput.title = `Formato: ${placeholder}`;
        }
        
        function updateHiddenPhone() {
            const code = countryCodeSelect.value || defaultCountryCode;
            const number = sanitizeNumber(visiblePhoneInput.value);
            telefonoInput.value = number ? `${code} ${number}` : '';
            // Actualizar tambi√©n el campo pais si existe
            if (paisInput) {
                paisInput.value = code;
            }
        }
        
        function initializePhoneFields() {
            const storedPhone = telefonoInput.value || '';
            let storedCode = '';
            let storedNumber = '';
            
            if (storedPhone) {
                // Primero intentar con formato "+57 3201234567" o "+573201234567"
                const match = storedPhone.match(/^(\+\d{1,4})\s*(.*)$/);
                if (match) {
                    storedCode = match[1];
                    storedNumber = match[2].trim();
                } else if (storedPhone.startsWith('+')) {
                    // Si empieza con + pero no hay espacio, intentar extraer c√≥digo
                    // Ordenar c√≥digos de m√°s largos a m√°s cortos para evitar coincidencias incorrectas
                    const codes = ['+351', '+591', '+593', '+595', '+598', '+57', '+58', '+55', '+56', '+54', '+52', '+51', '+49', '+44', '+39', '+34', '+33', '+86', '+82', '+81', '+61', '+91', '+7', '+1'];
                    for (const code of codes) {
                        if (storedPhone.startsWith(code)) {
                            storedCode = code;
                            storedNumber = storedPhone.substring(code.length).trim();
                            // Limpiar el n√∫mero de cualquier car√°cter no num√©rico excepto espacios
                            storedNumber = storedNumber.replace(/[^0-9\s]/g, '').trim();
                            break;
                        }
                    }
                } else {
                    // Si no empieza con +, asumir que es solo el n√∫mero
                    // Si es un n√∫mero colombiano (10 d√≠gitos empezando con 3), usar +57
                    const cleanNumber = storedPhone.replace(/[^0-9]/g, '');
                    if (cleanNumber.length === 10 && cleanNumber.startsWith('3')) {
                        storedCode = '+57';
                        storedNumber = cleanNumber;
                    } else {
                        // Si no, usar el n√∫mero tal cual y c√≥digo por defecto
                        storedCode = defaultCountryCode;
                        storedNumber = cleanNumber;
                    }
                }
            }
            
            // Establecer el c√≥digo de pa√≠s en el select
            if (storedCode && countryCodeSelect.querySelector(`option[value="${storedCode}"]`)) {
                countryCodeSelect.value = storedCode;
            } else if (!countryCodeSelect.value) {
                countryCodeSelect.value = defaultCountryCode;
            }
            
            // Limpiar y formatear el n√∫mero para mostrar
            if (storedNumber) {
                // Remover el c√≥digo de pa√≠s si est√° duplicado al inicio
                storedNumber = storedNumber.replace(/^\+?\d{1,4}\s*/, '');
                // Limpiar espacios y caracteres no num√©ricos
                storedNumber = sanitizeNumber(storedNumber);
            }
            
            visiblePhoneInput.value = storedNumber;
            updatePhonePlaceholder();
            // No actualizar el campo oculto todav√≠a, solo cuando el usuario interact√∫e
        }
        
        initializePhoneFields();
        
        countryCodeSelect.addEventListener('change', () => {
            updatePhonePlaceholder();
            updateHiddenPhone();
        });
        
        visiblePhoneInput.addEventListener('input', () => {
            visiblePhoneInput.value = sanitizeNumber(visiblePhoneInput.value);
            updateHiddenPhone();
        });
        
        // Forzar ancho fijo en el select de pa√≠s
        countryCodeSelect.style.width = '180px';
        countryCodeSelect.style.minWidth = '180px';
        countryCodeSelect.style.maxWidth = '180px';
        countryCodeSelect.addEventListener('mousedown', function() {
            this.style.width = '180px';
        });
        countryCodeSelect.addEventListener('focus', function() {
            this.style.width = '180px';
        });
    }
    
    // Manejar la visualizaci√≥n del nombre del archivo seleccionado
    const fileInput = document.getElementById('id_profile_image');
    const fileNameSpan = document.getElementById('file-name');
    const fileLabel = document.querySelector('label[for="' + (fileInput ? fileInput.id : '') + '"]');
    
    if (fileInput && fileNameSpan) {
        const defaultText = fileNameSpan.dataset.defaultText || 'Ning√∫n archivo seleccionado';
        
        // Ocultar completamente el input file nativo
        fileInput.style.position = 'absolute';
        fileInput.style.opacity = '0';
        fileInput.style.width = '0';
        fileInput.style.height = '0';
        fileInput.style.pointerEvents = 'none';
        
        // Hacer que el label act√∫e como bot√≥n para el input file
        if (fileLabel && fileLabel !== fileInput.previousElementSibling) {
            fileLabel.addEventListener('click', function(e) {
                if (e.target === fileLabel || fileLabel.contains(e.target)) {
                    e.preventDefault();
                    fileInput.click();
                }
            });
        }
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameSpan.textContent = this.files[0].name;
                fileNameSpan.classList.remove('text-gray-500', 'dark:text-gray-400');
                fileNameSpan.classList.add('text-green-600', 'dark:text-green-400', 'font-medium');
            } else {
                fileNameSpan.textContent = defaultText;
                fileNameSpan.classList.remove('text-green-600', 'dark:text-green-400', 'font-medium');
                fileNameSpan.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
        
        // Ocultar elementos adicionales del widget ClearableFileInput
        setTimeout(function() {
            const wrapper = fileInput.closest('.flex-1');
            if (wrapper) {
                // Ocultar checkboxes (pero no nuestro bot√≥n label)
                const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.style.display = 'none';
                    const nextLabel = cb.nextElementSibling;
                    if (nextLabel && nextLabel.tagName === 'LABEL' && !nextLabel.getAttribute('for')?.includes('profile_image')) {
                        nextLabel.style.display = 'none';
                    }
                });
                
                // Ocultar enlaces
                const links = wrapper.querySelectorAll('a[href*="profile_images"]');
                links.forEach(link => link.style.display = 'none');
                
                // Ocultar elementos <br> que no est√©n dentro de nuestro div personalizado
                const customDiv = wrapper.querySelector('.mt-1.flex.items-center');
                if (customDiv) {
                    const brs = wrapper.querySelectorAll('br');
                    brs.forEach(br => {
                        if (!customDiv.contains(br)) {
                            br.style.display = 'none';
                        }
                    });
                }
                
                // Ocultar texto que contenga "Actualmente", "Modificar" o "Limpiar" pero solo fuera de nuestro div personalizado
                const customDiv2 = wrapper.querySelector('.mt-1.flex.items-center');
                if (customDiv2) {
                    const allElements = wrapper.querySelectorAll('*');
                    allElements.forEach(el => {
                        // No ocultar elementos dentro de nuestro div personalizado
                        if (customDiv2.contains(el)) {
                            return;
                        }
                        // No ocultar labels, spans con id file-name, p√°rrafos, o el input file
                        if (el.tagName === 'LABEL' || el.id === 'file-name' || el.tagName === 'P' || el === fileInput) {
                            return;
                        }
                        const text = el.textContent || '';
                        if (text.includes('Actualmente') || text.includes('Modificar') || text.includes('Limpiar')) {
                            el.style.display = 'none';
                        }
                    });
                }
            }
        }, 100);
    }
    
    // Manejar dropdown din√°mico de departamento/ciudad
    const departamentoSelect = document.getElementById('id_departamento');
    const ciudadSelect = document.getElementById('id_ciudad');
    
    if (departamentoSelect && ciudadSelect) {
        [departamentoSelect, ciudadSelect].forEach(select => {
            select.removeAttribute('data-dropdown-toggle');
            select.removeAttribute('data-dropdown-trigger');
            select.classList.remove('flowbite-dropdown');
            select.setAttribute('data-flowbite-ignore', 'true');
        });
        
        // Obtener valores iniciales desde Django template
        const initialCityValue = '{{ form.ciudad.value|default:form.ciudad.initial|default:user.ciudad|default:"" }}';
        const initialDepartamentoValue = '{{ form.departamento.value|default:form.departamento.initial|default:user.departamento|default:"" }}';
        
        function loadCities(departamento, preserveCity = false, cityToSelect = '') {
            if (!departamento) {
                ciudadSelect.innerHTML = '<option value="">Selecciona primero un departamento</option>';
                ciudadSelect.disabled = true;
                return;
            }
            
            ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
            ciudadSelect.disabled = true;
            
            fetch('{% url "ajax_get_cities" %}?department=' + encodeURIComponent(departamento))
                .then(response => response.json())
                .then(data => {
                    ciudadSelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
                    ciudadSelect.disabled = false;
                    
                    if (data.success && data.cities) {
                        let foundMatch = false;
                        const cityValue = preserveCity ? (cityToSelect || initialCityValue) : '';
                        
                        data.cities.forEach(ciudad => {
                            const option = document.createElement('option');
                            option.value = ciudad;
                            option.textContent = ciudad;
                            
                            // Si estamos preservando la ciudad y coincide, seleccionarla
                            if (preserveCity && cityValue) {
                                if (ciudad === cityValue || 
                                    ciudad.trim() === cityValue.trim() ||
                                    ciudad.toLowerCase() === cityValue.toLowerCase()) {
                                    option.selected = true;
                                    foundMatch = true;
                                }
                            }
                            
                            ciudadSelect.appendChild(option);
                        });
                        
                        // Si no se encontr√≥ match pero hay un valor inicial, agregarlo
                        if (preserveCity && cityValue && !foundMatch) {
                            const customOption = document.createElement('option');
                            customOption.value = cityValue;
                            customOption.textContent = cityValue;
                            customOption.selected = true;
                            ciudadSelect.insertBefore(customOption, ciudadSelect.firstChild.nextSibling);
                        }
                    } else {
                        ciudadSelect.innerHTML = '<option value="">No hay ciudades disponibles</option>';
                        ciudadSelect.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error cargando ciudades:', error);
                    ciudadSelect.innerHTML = '<option value="">Error al cargar ciudades</option>';
                    ciudadSelect.disabled = true;
                });
        }
        
        // Cargar ciudades autom√°ticamente si ya hay un departamento seleccionado
        // Usar el valor del select o el valor inicial del template
        const currentDepartamento = departamentoSelect.value || initialDepartamentoValue;
        const currentCity = ciudadSelect.value || initialCityValue;
        
        console.log('üîç Inicializando ciudades:', {
            currentDepartamento,
            currentCity,
            selectValue: departamentoSelect.value,
            initialDepartamentoValue,
            initialCityValue
        });
        
        if (currentDepartamento && currentDepartamento.trim() !== '') {
            // Asegurar que el departamento est√© seleccionado
            if (departamentoSelect.value !== currentDepartamento) {
                departamentoSelect.value = currentDepartamento;
            }
            // Cargar ciudades con la ciudad actual
            console.log('üìû Cargando ciudades para:', currentDepartamento, 'con ciudad:', currentCity);
            loadCities(currentDepartamento, true, currentCity);
        } else if (!ciudadSelect.value && ciudadSelect.options.length <= 1) {
            ciudadSelect.disabled = true;
        }
        
        // Tambi√©n intentar cargar despu√©s de un peque√±o delay por si acaso
        setTimeout(function() {
            const deptValue = departamentoSelect.value || initialDepartamentoValue;
            const cityValue = ciudadSelect.value || initialCityValue;
            if (deptValue && deptValue.trim() !== '' && (!ciudadSelect.value || ciudadSelect.disabled)) {
                console.log('‚è∞ Cargando ciudades con delay para:', deptValue);
                loadCities(deptValue, true, cityValue);
            }
        }, 300);
        
        departamentoSelect.addEventListener('change', function() {
            ciudadSelect.value = '';
            loadCities(this.value, false);
        });
    }
    
    
});
</script>
{% endblock %}