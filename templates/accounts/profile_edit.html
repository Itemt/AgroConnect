{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar Perfil{% endblock %}

{% block extra_head %}
<style>
    /* Ocultar el input file nativo */
    input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 py-8 px-4 sm:px-6 lg:px-8" style="padding-bottom: 2rem !important;">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-700 to-green-800 px-6 py-8">
                <h1 class="text-3xl font-bold text-white flex items-center">
                    <i class="fas fa-user-edit mr-3"></i>
                    Editar Perfil
                </h1>
                <p class="mt-2 text-green-100">Actualiza tu información personal y de perfil.</p>
            </div>

            <div class="px-6 py-8 pb-10">
                <form method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}

                    <!-- Información Personal -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                            <i class="fas fa-user text-green-600 mr-3"></i>
                            Información Personal
                        </h2>
                    
                    <!-- Profile Image -->
                    <div class="flex items-center space-x-6 mb-6">
                        <div class="relative">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="Imagen de Perfil" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                            {% else %}
                                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center border-4 border-white shadow-lg">
                                    <i class="fas fa-user text-3xl text-primary-600"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <label for="{{ form.profile_image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.profile_image.label }}
                            </label>
                            <div class="mt-1 flex items-center">
                                <label for="{{ form.profile_image.id_for_label }}" class="cursor-pointer inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500 transition-all duration-200">
                                    <i class="fas fa-upload mr-2 text-gray-500"></i>
                                    Seleccionar archivo
                                </label>
                                {{ form.profile_image }}
                                <span id="file-name" class="ml-3 text-sm text-gray-500">Ningún archivo seleccionado</span>
                            </div>
                            {% if form.profile_image.help_text %}
                                <p class="mt-2 text-xs text-gray-500">{{ form.profile_image.help_text }}</p>
                            {% endif %}
                            {% for error in form.profile_image.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.username.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.username.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.username }}
                            </div>
                            {% for error in form.username.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.email.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.email }}
                            </div>
                            {% for error in form.email.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.first_name.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.first_name }}
                            </div>
                            {% for error in form.first_name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.last_name.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.last_name }}
                            </div>
                            {% for error in form.last_name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.cedula.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.cedula.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.cedula }}
                            </div>
                            {% if form.cedula.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.cedula.help_text }}</p>
                            {% endif %}
                            {% for error in form.cedula.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.telefono.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.telefono.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.telefono }}
                            </div>
                            {% if form.telefono.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.telefono.help_text }}</p>
                            {% endif %}
                            {% for error in form.telefono.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.pais.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.pais.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.pais }}
                            </div>
                            {% if form.pais.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.pais.help_text }}</p>
                            {% endif %}
                            {% for error in form.pais.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Ubicación -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-map-marker-alt text-primary-600 mr-3"></i>
                        Ubicación
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.departamento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.departamento.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.departamento }}
                            </div>
                            {% for error in form.departamento.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.ciudad.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.ciudad.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.ciudad }}
                            </div>
                            {% for error in form.ciudad.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Cambio de Contraseña -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-lock text-primary-600 mr-3"></i>
                        Cambio de Contraseña
                    </h2>
                    <p class="text-sm text-gray-600 mb-6">Deja estos campos vacíos si no quieres cambiar tu contraseña.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-wrapper">
                            <label for="{{ form.current_password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.current_password.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.current_password }}
                            </div>
                            {% if form.current_password.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.current_password.help_text }}</p>
                            {% endif %}
                            {% for error in form.current_password.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.new_password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.new_password.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.new_password }}
                            </div>
                            {% if form.new_password.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.new_password.help_text }}</p>
                            {% endif %}
                            {% for error in form.new_password.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper md:col-span-2">
                            <label for="{{ form.confirm_password.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.confirm_password.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.confirm_password }}
                            </div>
                            {% for error in form.confirm_password.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Campos específicos del productor -->
                {% if user.role == 'Productor' %}
                <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                    <h2 class="text-xl font-semibold text-green-800 mb-6 flex items-center">
                        <i class="fas fa-tractor text-green-600 mr-3"></i>
                        Información de la Finca
                    </h2>
                    <div class="space-y-6">
                        <div class="field-wrapper">
                            <label for="{{ form.direccion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.direccion.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.direccion }}
                            </div>
                            {% for error in form.direccion.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.farm_description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.farm_description.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.farm_description }}
                            </div>
                            {% for error in form.farm_description.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>

                        <div class="field-wrapper">
                            <label for="{{ form.main_crops.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.main_crops.label }}
                            </label>
                            <div class="mt-1">
                                {{ form.main_crops }}
                            </div>
                            {% for error in form.main_crops.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="flex justify-end items-center space-x-4 pt-8 pb-4 border-t border-gray-200">
                    <a href="{% url 'profile' %}" class="px-6 py-3 text-gray-600 hover:text-gray-800 font-medium transition-colors duration-200">
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                    <button type="submit" class="bg-gradient-to-r from-primary-600 to-primary-700 text-white px-8 py-3 rounded-xl hover:from-primary-700 hover:to-primary-800 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('📝 Formulario de edición de perfil cargado');
    
    // Obtener el valor inicial de la ciudad desde Django
    const initialCityValue = '{{ form.ciudad.initial|default:"" }}';
    
    // Manejar la interacción entre país y teléfono
    const paisSelect = document.getElementById('id_pais');
    const telefonoInput = document.getElementById('id_telefono');
    
    if (paisSelect && telefonoInput) {
        // Función para actualizar el placeholder del teléfono
        function updatePhonePlaceholder() {
            const selectedCountry = paisSelect.value;
            if (selectedCountry) {
                // Extraer el código de país del texto seleccionado
                const countryText = paisSelect.options[paisSelect.selectedIndex].text;
                const countryCode = selectedCountry;
                
                // Actualizar placeholder basado en el país
                const placeholders = {
                    '+1': '+1 555 123 4567',  // Estados Unidos/Canadá
                    '+52': '+52 55 1234 5678',  // México
                    '+54': '+54 11 1234 5678',  // Argentina
                    '+55': '+55 11 91234 5678',  // Brasil
                    '+56': '+56 9 1234 5678',  // Chile
                    '+57': '+57 320 123 4567',  // Colombia
                    '+58': '+58 412 123 4567',  // Venezuela
                    '+51': '+51 987 654 321',  // Perú
                    '+591': '+591 7 123 4567',  // Bolivia
                    '+593': '+593 99 123 4567',  // Ecuador
                    '+595': '+595 981 123 456',  // Paraguay
                    '+598': '+598 99 123 456',  // Uruguay
                    '+34': '+34 612 345 678',  // España
                    '+33': '+33 6 12 34 56 78',  // Francia
                    '+49': '+49 151 12345678',  // Alemania
                    '+39': '+39 320 123 4567',  // Italia
                    '+44': '+44 7700 900123',  // Reino Unido
                    '+7': '+7 912 345 6789',  // Rusia
                    '+86': '+86 138 0013 8000',  // China
                    '+81': '+81 90 1234 5678',  // Japón
                    '+82': '+82 10 1234 5678',  // Corea del Sur
                    '+91': '+91 98765 43210',  // India
                    '+61': '+61 412 345 678',  // Australia
                    '+27': '+27 82 123 4567',  // Sudáfrica
                    '+20': '+20 10 1234 5678',  // Egipto
                    '+90': '+90 532 123 4567',  // Turquía
                    '+966': '+966 50 123 4567',  // Arabia Saudí
                    '+971': '+971 50 123 4567',  // Emiratos Árabes Unidos
                };
                
                const placeholder = placeholders[countryCode] || `${countryCode} XXX XXX XXX`;
                telefonoInput.placeholder = placeholder;
                telefonoInput.title = `Formato: ${placeholder}`;
            } else {
                telefonoInput.placeholder = '+57 320 123 4567';
                telefonoInput.title = 'Formato: +57 320 123 4567';
            }
        }
        
        // Actualizar placeholder al cargar la página
        updatePhonePlaceholder();
        
        // Actualizar placeholder cuando cambie el país
        paisSelect.addEventListener('change', updatePhonePlaceholder);
    }
    
    // Manejar la visualización del nombre del archivo seleccionado
    const fileInput = document.getElementById('id_profile_image');
    const fileNameSpan = document.getElementById('file-name');
    
    if (fileInput && fileNameSpan) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameSpan.textContent = this.files[0].name;
                fileNameSpan.classList.remove('text-gray-500');
                fileNameSpan.classList.add('text-green-600', 'font-medium');
            } else {
                fileNameSpan.textContent = 'Ningún archivo seleccionado';
                fileNameSpan.classList.remove('text-green-600', 'font-medium');
                fileNameSpan.classList.add('text-gray-500');
            }
        });
    }
    
    // Manejar dropdown dinámico de departamento/ciudad
    setTimeout(() => {
        const departamentoSelect = document.getElementById('id_departamento');
        const ciudadSelect = document.getElementById('id_ciudad');
        
        if (departamentoSelect && ciudadSelect) {
            // Deshabilitar Flowbite para ambos selects
            [departamentoSelect, ciudadSelect].forEach(select => {
                select.removeAttribute('data-dropdown-toggle');
                select.removeAttribute('data-dropdown-trigger');
                select.classList.remove('flowbite-dropdown');
                select.setAttribute('data-flowbite-ignore', 'true');
            });
            
            // Función para cargar ciudades
            function loadCities(departamento, preserveCurrentValue = false, initialCityValue = '') {
                if (departamento) {
                    const currentValue = preserveCurrentValue ? (initialCityValue || ciudadSelect.value) : '';
                    ciudadSelect.innerHTML = '<option value="">Cargando...</option>';
                    
                    fetch('{% url "ajax_get_cities" %}?department=' + encodeURIComponent(departamento))
                    .then(response => response.json())
                    .then(data => {
                        ciudadSelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
                        
                        if (data.success && data.cities) {
                            // Recrear completamente el select
                            const parent = ciudadSelect.parentNode;
                            const newSelect = document.createElement('select');
                            
                            // Copiar atributos del select original
                            newSelect.id = ciudadSelect.id;
                            newSelect.name = ciudadSelect.name;
                            newSelect.className = ciudadSelect.className;
                            
                            // Agregar opción inicial
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = 'Seleccionar ciudad';
                            newSelect.appendChild(defaultOption);
                            
                            // Agregar ciudades
                            data.cities.forEach(ciudad => {
                                const option = document.createElement('option');
                                option.value = ciudad;
                                option.textContent = ciudad;
                                if (preserveCurrentValue && ciudad === currentValue) {
                                    option.selected = true;
                                }
                                newSelect.appendChild(option);
                            });
                            
                            // Si no se encontró coincidencia exacta, intentar con trim
                            if (preserveCurrentValue && currentValue && !newSelect.value) {
                                const trimmedValue = currentValue.trim();
                                const matchingOption = Array.from(newSelect.options).find(opt => opt.value.trim() === trimmedValue);
                                if (matchingOption) {
                                    matchingOption.selected = true;
                                }
                            }
                            
                            // Reemplazar el select original
                            parent.replaceChild(newSelect, ciudadSelect);
                            
                            // Reasignar el event listener al nuevo select
                            ciudadSelect = newSelect;
                        } else {
                            ciudadSelect.innerHTML = '<option value="">No hay ciudades</option>';
                        }
                    })
                    .catch(error => {
                        ciudadSelect.innerHTML = '<option value="">Error</option>';
                    });
                } else {
                    ciudadSelect.innerHTML = '<option value="">Seleccionar departamento primero</option>';
                }
            }
            
            // Cargar ciudades automáticamente si ya hay un departamento seleccionado
            if (departamentoSelect.value) {
                loadCities(departamentoSelect.value, true, initialCityValue);
            }
            
            // Event listener para cambios en el departamento
            departamentoSelect.addEventListener('change', function() {
                loadCities(this.value, false);
            });
        }
    }, 1000);
    
    // Mostrar/ocultar campos de contraseña según necesidad
    const newPasswordField = document.getElementById('id_new_password');
    const confirmPasswordField = document.getElementById('id_confirm_password');
    
    if (newPasswordField && confirmPasswordField) {
        function togglePasswordFields() {
            const hasNewPassword = newPasswordField.value.length > 0;
            confirmPasswordField.closest('.field-wrapper').style.display = hasNewPassword ? 'block' : 'none';
        }
        
        newPasswordField.addEventListener('input', togglePasswordFields);
        togglePasswordFields(); // Ejecutar al cargar
    }
});
</script>
{% endblock %}