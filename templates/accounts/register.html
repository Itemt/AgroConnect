{% extends 'base.html' %}
{% load static %}

{% block title %}Registro de Usuario{% endblock %}

{% block content %}
    <div class="min-h-screen bg-gradient-to-br from-primary-50 via-white to-accent-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-primary-400 to-primary-600 rounded-2xl flex items-center justify-center shadow-strong mx-auto mb-6">
                    <i class="fas fa-user-plus text-white text-3xl"></i>
                </div>
                <h1 class="text-5xl font-bold text-gradient mb-4">
                    Registro de Usuario
                </h1>
                <p class="text-xl text-gray-600">
                    Crea tu cuenta en AgroConnect
                </p>
            </div>
            
            <!-- Registration Form -->
            <div class="card">
                <div class="card-body p-8">
                    <form method="post">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                                {% for error in form.non_field_errors %}
                                    <p class="text-sm">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="space-y-6">
                    {% for field in form %}
                        {% if field.name == 'company_name' or field.name == 'business_type' %}
                            <!-- Campos espec√≠ficos para compradores - se muestran con JavaScript -->
                            <div id="buyer-fields" class="space-y-4" style="display: none;">
                                {% if field.name == 'company_name' %}
                                    <div class="field-wrapper">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            <i class="fas fa-building mr-2 text-primary-600"></i>{{ field.label }}
                                        </label>
                                        <input type="text" 
                                               name="{{ field.name }}" 
                                               id="{{ field.id_for_label }}"
                                               class="form-input"
                                               placeholder="{{ field.field.widget.attrs.placeholder }}"
                                               value="{{ field.value|default:'' }}">
                                        {% for error in field.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% elif field.name == 'business_type' %}
                                    <div class="field-wrapper">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            <i class="fas fa-briefcase mr-2 text-primary-600"></i>{{ field.label }}
                                        </label>
                                        <input type="text" 
                                               name="{{ field.name }}" 
                                               id="{{ field.id_for_label }}"
                                               class="form-input"
                                               placeholder="{{ field.field.widget.attrs.placeholder }}"
                                               value="{{ field.value|default:'' }}">
                                        {% for error in field.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% elif field.name == 'direccion' or field.name == 'farm_description' or field.name == 'main_crops' %}
                            <!-- Campos espec√≠ficos para productores - se muestran con JavaScript -->
                            <div id="producer-fields" class="space-y-4" style="display: none;">
                                {% if field.name == 'direccion' %}
                                    <div class="field-wrapper">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            <i class="fas fa-map-marker-alt mr-2 text-primary-600"></i>{{ field.label }}
                                        </label>
                                        <input type="text" 
                                               name="{{ field.name }}" 
                                               id="{{ field.id_for_label }}"
                                               class="form-input"
                                               placeholder="{{ field.field.widget.attrs.placeholder }}"
                                               value="{{ field.value|default:'' }}">
                                        {% for error in field.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% elif field.name == 'farm_description' %}
                                    <div class="field-wrapper">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            <i class="fas fa-tractor mr-2 text-primary-600"></i>{{ field.label }}
                                        </label>
                                        <textarea name="{{ field.name }}" 
                                                  id="{{ field.id_for_label }}"
                                                  class="form-input"
                                                  placeholder="{{ field.field.widget.attrs.placeholder }}"
                                                  rows="4">{{ field.value|default:'' }}</textarea>
                                        {% for error in field.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% elif field.name == 'main_crops' %}
                                    <div class="field-wrapper">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            <i class="fas fa-seedling mr-2 text-primary-600"></i>{{ field.label }}
                                        </label>
                                        <input type="text" 
                                               name="{{ field.name }}" 
                                               id="{{ field.id_for_label }}"
                                               class="form-input"
                                               placeholder="{{ field.field.widget.attrs.placeholder }}"
                                               value="{{ field.value|default:'' }}">
                                        {% for error in field.errors %}
                                            <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <!-- Campos generales -->
                            <div class="field-wrapper">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {% if field.name == 'role' %}
                                        <i class="fas fa-user-tag mr-2 text-primary-600"></i>
                                    {% elif field.name == 'departamento' %}
                                        <i class="fas fa-map-marker-alt mr-2 text-primary-600"></i>
                                    {% elif field.name == 'ciudad' %}
                                        <i class="fas fa-city mr-2 text-primary-600"></i>
                                    {% elif field.name == 'username' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'first_name' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'last_name' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'email' %}
                                        <i class="fas fa-envelope mr-2 text-primary-600"></i>
                                    {% elif field.name == 'cedula' %}
                                        <i class="fas fa-id-card mr-2 text-primary-600"></i>
                                    {% endif %}
                                    {{ field.label }}
                                </label>
                                
                                {% if field.field.widget.input_type == 'password' %}
                                    <input type="password" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}">
                                {% elif field.field.widget.input_type == 'email' %}
                                    <input type="email" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}"
                                           value="{{ field.value|default:'' }}">
                                {% elif field.name == 'role' or field.name == 'departamento' or field.name == 'ciudad' %}
                                    {{ field }}
                                {% elif field.name == 'cedula' %}
                                    <input type="text" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="{{ field.field.widget.attrs.placeholder }}"
                                           value="{{ field.value|default:'' }}">
                                {% else %}
                                    <input type="text" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}"
                                           value="{{ field.value|default:'' }}">
                                {% endif %}
                                
                                {% if field.help_text %}
                                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                                
                                {% for error in field.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                        <div class="pt-6">
                            <button type="submit" class="btn-primary w-full group">
                                <i class="fas fa-user-plus mr-2 group-hover:scale-110 transition-transform duration-300"></i>
                                Registrarse
                            </button>
                        </div>

                        <div class="text-center pt-4">
                            <p class="text-gray-600">
                                ¬øYa tienes cuenta? 
                                <a href="{% url 'login' %}" class="font-semibold text-primary-600 hover:text-primary-700 transition-colors duration-300">
                                    Inicia sesi√≥n aqu√≠
                                </a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Formulario de registro cargado');
    
    const roleSelect = document.getElementById('id_role');
    const buyerFields = document.getElementById('buyer-fields');
    const producerFields = document.getElementById('producer-fields');
    const form = document.querySelector('form');
    
    function toggleRoleFields() {
        const role = roleSelect.value;
        console.log('üîÑ Rol seleccionado:', role);
        
        // Ocultar todos los campos espec√≠ficos primero
        if (buyerFields) buyerFields.style.display = 'none';
        if (producerFields) producerFields.style.display = 'none';
        
        // Resetear todos los campos espec√≠ficos a opcionales
        const companyNameField = document.getElementById('id_company_name');
        const businessTypeField = document.getElementById('id_business_type');
        const direccionField = document.getElementById('id_direccion');
        const farmDescriptionField = document.getElementById('id_farm_description');
        const mainCropsField = document.getElementById('id_main_crops');
        
        if (companyNameField) companyNameField.required = false;
        if (businessTypeField) businessTypeField.required = false;
        if (direccionField) direccionField.required = false;
        if (farmDescriptionField) farmDescriptionField.required = false;
        if (mainCropsField) mainCropsField.required = false;
        
        // Mostrar campos seg√∫n el rol seleccionado
        if (role === 'Comprador') {
            if (buyerFields) {
                buyerFields.style.display = 'block';
                console.log('‚úÖ Mostrando campos de comprador');
            }
            // Hacer los campos de comprador requeridos
            if (companyNameField) companyNameField.required = true;
            if (businessTypeField) businessTypeField.required = true;
        } else if (role === 'Productor') {
            if (producerFields) {
                producerFields.style.display = 'block';
                console.log('‚úÖ Mostrando campos de productor');
            }
            // Los campos de productor son opcionales, no los hacemos requeridos
        }
    }
    
    // Ejecutar al cargar la p√°gina
    toggleRoleFields();
    
    // Ejecutar cuando cambie el rol
    if (roleSelect) {
        roleSelect.addEventListener('change', toggleRoleFields);
    }
    
    // Debug del env√≠o del formulario
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üì§ Intentando enviar formulario...');
            
            // Verificar campos requeridos
            const requiredFields = form.querySelectorAll('[required]');
            let hasErrors = false;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    console.error('‚ùå Campo requerido vac√≠o:', field.name || field.id);
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                console.error('‚ùå Hay campos requeridos sin completar');
            } else {
                console.log('‚úÖ Todos los campos requeridos est√°n completos');
            }
        });
    }
});
</script>
{% endblock %}