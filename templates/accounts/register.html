{% extends 'base.html' %}
{% load static %}

{% block title %}Registro de Usuario{% endblock %}

{% block content %}
    <div class="min-h-screen bg-gradient-to-br from-primary-50 via-white to-accent-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-primary-400 to-primary-600 rounded-2xl flex items-center justify-center shadow-strong mx-auto mb-6">
                    <i class="fas fa-user-plus text-white text-3xl"></i>
                </div>
                <h1 class="text-5xl font-bold text-gradient mb-4">
                    Registro de Usuario
                </h1>
                <p class="text-xl text-gray-600">
                    Crea tu cuenta en AgroConnect
                </p>
            </div>
            
            <!-- Registration Form -->
            <div class="card">
                <div class="card-body p-8">
                    <form method="post">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                                {% for error in form.non_field_errors %}
                                    <p class="text-sm">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="space-y-6">
                    {% for field in form %}
                        {% if field.name == 'company_name' or field.name == 'business_type' %}
                            <!-- Campos específicos para compradores - se muestran con JavaScript -->
                            <div class="buyer-field field-wrapper" style="display: none;">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {% if field.name == 'company_name' %}
                                        <i class="fas fa-building mr-2 text-primary-600"></i>
                                    {% elif field.name == 'business_type' %}
                                        <i class="fas fa-briefcase mr-2 text-primary-600"></i>
                                    {% endif %}
                                    {{ field.label }}
                                </label>
                                {{ field }}
                                {% if field.help_text %}
                                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                                {% for error in field.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% elif field.name == 'direccion' or field.name == 'farm_description' or field.name == 'main_crops' %}
                            <!-- Campos específicos para productores - se muestran con JavaScript -->
                            <div class="producer-field field-wrapper" style="display: none;">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {% if field.name == 'direccion' %}
                                        <i class="fas fa-map-marker-alt mr-2 text-primary-600"></i>
                                    {% elif field.name == 'farm_description' %}
                                        <i class="fas fa-tractor mr-2 text-primary-600"></i>
                                    {% elif field.name == 'main_crops' %}
                                        <i class="fas fa-seedling mr-2 text-primary-600"></i>
                                    {% endif %}
                                    {{ field.label }}
                                </label>
                                {{ field }}
                                {% if field.help_text %}
                                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                                {% for error in field.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- Campos generales -->
                            <div class="field-wrapper">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {% if field.name == 'role' %}
                                        <i class="fas fa-user-tag mr-2 text-primary-600"></i>
                                    {% elif field.name == 'departamento' %}
                                        <i class="fas fa-map-marker-alt mr-2 text-primary-600"></i>
                                    {% elif field.name == 'ciudad' %}
                                        <i class="fas fa-city mr-2 text-primary-600"></i>
                                    {% elif field.name == 'username' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'first_name' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'last_name' %}
                                        <i class="fas fa-user mr-2 text-primary-600"></i>
                                    {% elif field.name == 'email' %}
                                        <i class="fas fa-envelope mr-2 text-primary-600"></i>
                                    {% elif field.name == 'cedula' %}
                                        <i class="fas fa-id-card mr-2 text-primary-600"></i>
                                    {% endif %}
                                    {{ field.label }}
                                </label>
                                
                                {% if field.field.widget.input_type == 'password' %}
                                    <input type="password" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}">
                                {% elif field.field.widget.input_type == 'email' %}
                                    <input type="email" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}"
                                           value="{{ field.value|default:'' }}">
                                {% elif field.name == 'role' or field.name == 'departamento' or field.name == 'ciudad' %}
                                    {{ field }}
                                {% elif field.name == 'cedula' %}
                                    <input type="text" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="{{ field.field.widget.attrs.placeholder }}"
                                           value="{{ field.value|default:'' }}">
                                {% else %}
                                    <input type="text" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           class="form-input"
                                           placeholder="Ingresa tu {{ field.label|lower }}"
                                           value="{{ field.value|default:'' }}">
                                {% endif %}
                                
                                {% if field.help_text %}
                                    <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                                {% endif %}
                                
                                {% for error in field.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                        <div class="pt-6">
                            <button type="submit" class="btn-primary w-full group">
                                <i class="fas fa-user-plus mr-2 group-hover:scale-110 transition-transform duration-300"></i>
                                Registrarse
                            </button>
                        </div>

                        <div class="text-center pt-4">
                            <p class="text-gray-600">
                                ¿Ya tienes cuenta? 
                                <a href="{% url 'login' %}" class="font-semibold text-primary-600 hover:text-primary-700 transition-colors duration-300">
                                    Inicia sesión aquí
                                </a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('📝 Formulario de registro cargado');
    
    const roleSelect = document.getElementById('id_role');
    const buyerFields = document.querySelectorAll('.buyer-field');
    const producerFields = document.querySelectorAll('.producer-field');
    const form = document.querySelector('form');
    
    function toggleRoleFields() {
        const role = roleSelect.value;
        console.log('🔄 Rol seleccionado:', role);
        
        // Obtener los inputs dentro de los campos
        const companyNameField = document.getElementById('id_company_name');
        const businessTypeField = document.getElementById('id_business_type');
        const direccionField = document.getElementById('id_direccion');
        const farmDescriptionField = document.getElementById('id_farm_description');
        const mainCropsField = document.getElementById('id_main_crops');
        
        // Ocultar y deshabilitar todos los campos específicos primero
        buyerFields.forEach(field => {
            field.style.display = 'none';
            const input = field.querySelector('input, select, textarea');
            if (input) {
                input.disabled = true;
                input.required = false;
            }
        });
        
        producerFields.forEach(field => {
            field.style.display = 'none';
            const input = field.querySelector('input, select, textarea');
            if (input) {
                input.disabled = true;
                input.required = false;
            }
        });
        
        // Mostrar y habilitar campos según el rol seleccionado
        if (role === 'Comprador') {
            console.log('✅ Mostrando campos de comprador');
            buyerFields.forEach(field => {
                field.style.display = 'block';
                const input = field.querySelector('input, select, textarea');
                if (input) {
                    input.disabled = false;
                    input.required = true;
                }
            });
        } else if (role === 'Productor') {
            console.log('✅ Mostrando campos de productor');
            producerFields.forEach(field => {
                field.style.display = 'block';
                const input = field.querySelector('input, select, textarea');
                if (input) {
                    input.disabled = false;
                    // Los campos de productor son opcionales
                }
            });
        }
    }
    
    // Ejecutar al cargar la página
    toggleRoleFields();
    
    // Ejecutar cuando cambie el rol
    if (roleSelect) {
        roleSelect.addEventListener('change', toggleRoleFields);
    }
    
    // Debug del envío del formulario
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('📤 Intentando enviar formulario...');
            
            // Verificar campos requeridos que estén visibles
            const requiredFields = form.querySelectorAll('[required]:not([disabled])');
            let hasErrors = false;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    console.error('❌ Campo requerido vacío:', field.name || field.id);
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                console.error('❌ Hay campos requeridos sin completar');
            } else {
                console.log('✅ Todos los campos requeridos están completos');
            }
        });
    }
});
</script>
{% endblock %}