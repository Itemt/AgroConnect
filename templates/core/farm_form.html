{% extends 'accounts/producer_base_tailadmin.html' %}

{% block title %}{{ title }} - AgroConnect{% endblock %}

{% block producer_content %}
<style>
    /* Asegurar que el gradiente ocupe toda la página */
    #main-content > div.p-4.mx-auto.max-w-7xl.md\:p-6 {
        max-width: 100% !important;
        padding: 0 !important;
    }
    
    #main-content > footer {
        max-width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    /* Estilos para inputs, selects y textareas del formulario */
    #farm-form input[type="text"],
    #farm-form input[type="number"],
    #farm-form input[type="email"],
    #farm-form select,
    #farm-form textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.15s ease-in-out;
    }
    
    /* Dark mode para inputs */
    .dark #farm-form input[type="text"],
    .dark #farm-form input[type="number"],
    .dark #farm-form input[type="email"],
    .dark #farm-form select,
    .dark #farm-form textarea {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    /* Focus states */
    #farm-form input[type="text"]:focus,
    #farm-form input[type="number"]:focus,
    #farm-form input[type="email"]:focus,
    #farm-form select:focus,
    #farm-form textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dark #farm-form input[type="text"]:focus,
    .dark #farm-form input[type="number"]:focus,
    .dark #farm-form input[type="email"]:focus,
    .dark #farm-form select:focus,
    .dark #farm-form textarea:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    /* Textarea específico */
    #farm-form textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Select específico */
    #farm-form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }
    
    .dark #farm-form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%9ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    
    /* Labels en modo oscuro */
    .dark label {
        color: #e5e7eb !important;
    }
    
    /* Headers en modo oscuro */
    .dark h2 {
        color: #f9fafb !important;
    }
    
    /* Iconos de headers en modo oscuro */
    .dark h2 i {
        opacity: 0.9;
    }
    
    /* Checkboxes */
    #farm-form input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        background-color: #ffffff;
    }
    
    .dark #farm-form input[type="checkbox"] {
        border-color: #4b5563;
        background-color: #374151;
    }
</style>

<div class="bg-gradient-to-br from-green-50 via-white to-emerald-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 py-8 px-4 sm:px-6 lg:px-8 min-h-screen" style="padding-bottom: 2rem !important;">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10 lg:mb-12">
            <div class="flex mb-4 items-center justify-center">
                <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="4" r="4" fill="#15803d"></circle>
                </svg>
                <span class="inline-block ml-2 text-sm font-medium text-green-900 dark:text-green-300">Fincas</span>
            </div>
            <h1 class="font-heading text-4xl sm:text-5xl lg:text-6xl font-bold text-green-900 dark:text-gray-100 mb-4">
                {{ title }}
            </h1>
            <p class="text-base lg:text-lg text-gray-700 dark:text-gray-300">
                Completa la información de tu finca
            </p>
        </div>

        <!-- Form -->
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-md p-6 lg:p-10">
            <form method="post" id="farm-form" class="space-y-6">
            {% csrf_token %}
            
            <!-- Información Básica -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <i class="fas fa-info-circle text-green-600 dark:text-green-400 mr-3"></i>
                    Información Básica
                </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Nombre de la Finca *
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.nombre.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.tipo_suelo.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tipo de Suelo *
                                </label>
                                {{ form.tipo_suelo }}
                                {% if form.tipo_suelo.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.tipo_suelo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label for="{{ form.descripcion.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Descripción
                            </label>
                            {{ form.descripcion }}
                            {% if form.descripcion.errors %}
                                <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.descripcion.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ubicación -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-map-marker-alt text-blue-600 dark:text-blue-400 mr-3"></i>
                            Ubicación
                </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.departamento.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Departamento *
                                </label>
                                {{ form.departamento }}
                                {% if form.departamento.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.departamento.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.ciudad.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Ciudad/Municipio *
                                </label>
                                {{ form.ciudad }}
                                {% if form.ciudad.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.ciudad.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label for="{{ form.direccion.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Dirección Completa *
                            </label>
                            {{ form.direccion }}
                            {% if form.direccion.errors %}
                                <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.direccion.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label for="{{ form.coordenadas_lat.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Latitud (opcional)
                                </label>
                                {{ form.coordenadas_lat }}
                                {% if form.coordenadas_lat.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.coordenadas_lat.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.coordenadas_lng.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Longitud (opcional)
                                </label>
                                {{ form.coordenadas_lng }}
                                {% if form.coordenadas_lng.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.coordenadas_lng.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Características de la Finca -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-chart-area text-green-600 dark:text-green-400 mr-3"></i>
                            Características de la Finca
                </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.area_total.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Área Total (hectáreas) *
                                </label>
                                {{ form.area_total }}
                                {% if form.area_total.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.area_total.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.area_cultivable.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Área Cultivable (hectáreas) *
                                </label>
                                {{ form.area_cultivable }}
                                {% if form.area_cultivable.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.area_cultivable.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label for="{{ form.tipo_riego.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tipo de Riego *
                                </label>
                                {{ form.tipo_riego }}
                                {% if form.tipo_riego.errors %}
                                    <div class="text-red-600 dark:text-red-400 text-sm mt-1">{{ form.tipo_riego.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
            </div>
            </form>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex flex-col sm:flex-row gap-4 pt-6 mt-6 justify-end">
            <a href="{% url 'core:farm_list' %}" class="inline-flex items-center justify-center px-6 py-3.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-xl font-medium transition-colors">
                <i class="fas fa-times mr-2"></i>
                Cancelar
            </a>
            <button type="submit" form="farm-form" class="inline-flex items-center justify-center py-3 px-8 text-base font-medium text-white bg-green-900 hover:bg-green-800 rounded-full transition duration-200">
                <i class="fas fa-save mr-2"></i>
                {% if finca %}Actualizar Finca{% else %}Crear Finca{% endif %}
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departamentoSelect = document.getElementById('id_departamento');
    const ciudadSelect = document.getElementById('id_ciudad');

    if (!departamentoSelect || !ciudadSelect) {
        console.error('❌ Selects not found', { departamentoSelect, ciudadSelect });
        return;
    }

    const departamentoCurrent = (departamentoSelect.getAttribute('data-current') || '').trim();
    const ciudadCurrent = (ciudadSelect.getAttribute('data-current') || '').trim();

    function setCityOptions(ciudades, selectedCity) {
        ciudadSelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
        ciudades.forEach(ciudad => {
            const option = document.createElement('option');
            option.value = ciudad.value || ciudad;
            option.textContent = ciudad.text || ciudad;
            ciudadSelect.appendChild(option);
        });

        if (selectedCity) {
            ciudadSelect.value = selectedCity;
        }

        ciudadSelect.disabled = ciudadSelect.options.length <= 1;
    }

    function fetchCities(departamento, selectedCity=null) {
        if (!departamento) {
            ciudadSelect.innerHTML = '<option value="">Primero seleccione un departamento</option>';
            ciudadSelect.disabled = true;
            return;
        }

        ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
        ciudadSelect.disabled = true;

        const url = '{% url "core:get_ciudades" %}';
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'departamento=' + encodeURIComponent(departamento)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const ciudades = (data.ciudades || []).map(c => ({ value: c.value, text: c.text }));
            // Garantizar que la ciudad actual esté incluida
            if (selectedCity && !ciudades.find(c => c.value === selectedCity)) {
                ciudades.push({ value: selectedCity, text: selectedCity });
            }
            setCityOptions(ciudades, selectedCity);
        })
        .catch(error => {
            console.error('Error loading cities:', error);
            ciudadSelect.innerHTML = '<option value="">Error al cargar ciudades</option>';
            ciudadSelect.disabled = true;
        });
    }

    // Inicializar selects con valores actuales si existen
    if (departamentoCurrent) {
        departamentoSelect.value = departamentoCurrent;
        fetchCities(departamentoCurrent, ciudadCurrent || null);
    } else {
        ciudadSelect.innerHTML = '<option value="">Primero seleccione un departamento</option>';
        ciudadSelect.disabled = true;
    }

    departamentoSelect.addEventListener('change', function() {
        const departamento = this.value;
        fetchCities(departamento);
    });
});
</script>
{% endblock %}
