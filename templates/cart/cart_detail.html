{% extends 'base.html' %}

{% block og_title %}Mi Carrito • AgroConnect{% endblock %}
{% block og_description %}Revisa tus productos y procede al pago con MercadoPago. Compra directa al productor en AgroConnect.{% endblock %}
{% block twitter_title %}Mi Carrito • AgroConnect{% endblock %}
{% block twitter_description %}Tu carrito en AgroConnect listo para pagar de forma segura.{% endblock %}
{% load cart_tags %}

{% block title %}Mi Carrito de Compras{% endblock %}

{% block extra_head %}
<style>
    /* Estilos para inputs en modo oscuro */
    form input[type="text"],
    form input[type="number"] {
        color: #1f2937;
        background-color: #ffffff;
        border-color: #d1d5db;
    }
    
    .dark form input[type="text"],
    .dark form input[type="number"] {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    form input[type="text"]:focus,
    form input[type="number"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dark form input[type="text"]:focus,
    .dark form input[type="number"]:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 py-8 lg:py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8 lg:mb-12">
            <div class="flex mb-4 items-center justify-center">
                <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="4" r="4" fill="#15803d"></circle>
                </svg>
                <span class="inline-block ml-2 text-sm font-medium text-green-900">Carrito</span>
            </div>
            <h1 class="font-heading text-4xl sm:text-5xl lg:text-6xl font-bold text-green-900 dark:text-gray-100 mb-4">
                Mi Carrito de Compras
            </h1>
            <p class="text-base lg:text-lg text-gray-700 dark:text-gray-300">
                Revisa tus productos antes de proceder al pago
            </p>
        </div>

        {% if not cart.items.all %}
            <!-- Carrito Vacío -->
            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-md p-8 lg:p-16 text-center border border-gray-100 dark:border-slate-700">
                <div class="w-24 h-24 mx-auto mb-6 bg-green-50 dark:bg-slate-700 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-4xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">Tu carrito está vacío</h2>
                <p class="text-gray-700 dark:text-gray-300 mb-8 max-w-md mx-auto">
                    Parece que todavía no has añadido nada a tu carrito. ¡Explora nuestros productos y encuentra lo que necesitas!
                </p>
                <a href="{% url 'marketplace' %}" 
                   class="inline-flex items-center py-3 px-6 text-base font-medium text-white bg-green-900 hover:bg-green-800 rounded-full transition duration-200">
                    <i class="fas fa-store mr-2"></i>
                    ¡Empieza a comprar!
                </a>
            </div>
        {% else %}
            <!-- Carrito con Productos -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
                <!-- Productos del Carrito -->
                <div class="lg:col-span-2">
                    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-md p-6 lg:p-8 border border-gray-100 dark:border-slate-700">
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200 dark:border-slate-700">
                            <div>
                                <h2 class="text-xl lg:text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
                                    <i class="fas fa-box text-green-600 mr-3"></i>
                                    Productos en tu Carrito
                                </h2>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">{{ cart.items.count }} producto{{ cart.items.count|pluralize }} seleccionado{{ cart.items.count|pluralize }}</p>
                            </div>
                        </div>
                
                    <div class="space-y-4">
                        {% for item in cart.items.all %}
                        <div class="p-5 bg-gray-50 dark:bg-slate-700/50 rounded-2xl border border-gray-200 dark:border-slate-600 hover:border-green-300 transition-all duration-200">
                            <div class="flex items-start gap-4">
                                <!-- Imagen del Producto -->
                                <div class="flex-shrink-0">
                                    {% if item.publication.all_images.first %}
                                        <img class="w-20 h-20 sm:w-24 sm:h-24 rounded-2xl object-cover" 
                                             src="{{ item.publication.all_images.first.image.url }}" 
                                             alt="{{ item.publication.cultivo.nombre }}" />
                                    {% elif item.publication.imagen %}
                                        <img class="w-20 h-20 sm:w-24 sm:h-24 rounded-2xl object-cover" 
                                             src="{{ item.publication.imagen.url }}" 
                                             alt="{{ item.publication.cultivo.nombre }}" />
                                    {% else %}
                                        <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center">
                                            <i class="fas fa-seedling text-2xl text-white"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Información del Producto -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <h3 class="text-base sm:text-lg font-bold text-gray-900 dark:text-gray-100 mb-2">
                                                {{ item.publication.cultivo.nombre }}
                                            </h3>
                                            <div class="space-y-1">
                                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                                    <i class="fas fa-user mr-1 text-green-600"></i>
                                                    <span class="font-medium">{{ item.publication.cultivo.productor.username }}</span>
                                                </p>
                                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                                    <i class="fas fa-map-marker-alt mr-1 text-green-600"></i>
                                                    {{ item.publication.cultivo.finca.departamento }}, {{ item.publication.cultivo.finca.ciudad }}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <!-- Precio -->
                                        <div class="text-right ml-4">
                                            <p class="text-lg sm:text-xl font-bold text-green-700 dark:text-green-400 mb-1">
                                                ${{ item.get_item_price|floatformat:2 }}
                                            </p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                ${{ item.precio_unitario_display|floatformat:2 }} / {{ item.unidad_compra }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Cantidad y Actualizar -->
                                    <div class="pt-3 border-t border-gray-200 dark:border-slate-700">
                                        <form action="{% url 'cart:update_cart' item.id %}" method="post">
                                            {% csrf_token %}
                                            
                                            <!-- Primera línea: Label + Control de cantidad + Unidad (simétricos) -->
                                            <div class="flex items-center gap-2 mb-2.5">
                                                <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Cantidad:</span>
                                                
                                                <!-- Control de cantidad compacto -->
                                                <div class="flex items-center border border-gray-300 dark:border-slate-600 rounded-md overflow-hidden h-8">
                                                    <button type="button" onclick="decreaseQuantity(this)" class="px-2.5 h-full bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors flex items-center">
                                                        <i class="fas fa-minus text-xs text-gray-600 dark:text-gray-300"></i>
                                                    </button>
                                                    <input type="number" name="quantity" value="{% if item.quantity %}{{ item.quantity|floatformat:1 }}{% else %}0.0{% endif %}" min="0" step="0.1"
                                                           class="w-14 text-center border-0 focus:ring-0 focus:outline-none bg-white dark:bg-slate-700 text-sm font-medium text-gray-900 dark:text-gray-100 h-full [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                                    <button type="button" onclick="increaseQuantity(this)" class="px-2.5 h-full bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors flex items-center">
                                                        <i class="fas fa-plus text-xs text-gray-600 dark:text-gray-300"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Selector de unidad al lado - mismo tamaño -->
                                                <select name="unidad" class="text-sm border border-gray-300 dark:border-slate-600 rounded-md px-3 bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-100 h-8 font-medium">
                                                    {% for u in item.publication.unidades_disponibles_para_conversion %}
                                                        <option value="{{ u }}" {% if u == item.unidad_compra %}selected{% endif %}>{{ u }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <!-- Segunda línea: Botones Actualizar y Eliminar -->
                                            <div class="flex items-center gap-2 mb-2.5">
                                                <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-xs font-semibold transition-colors shadow-sm">
                                                    <i class="fas fa-check mr-1"></i>Actualizar
                                                </button>
                                                
                                                <button type="button" 
                                                   class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition-all shadow-sm inline-flex items-center"
                                                   onclick="showDeleteConfirm('{{ item.id }}', '{{ item.publication.cultivo.nombre }}')">
                                                    <i class="fas fa-trash text-xs"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Tercera línea: Info de Disponible y Mínimo -->
                                            <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                                <div>
                                                    <i class="fas fa-box text-green-600 mr-1"></i>
                                                    <span>Disponible: <strong class="text-gray-700 dark:text-gray-300">{{ item.disponible_en_unidad_compra|floatformat:1 }} {{ item.unidad_compra }}</strong></span>
                                                </div>
                                                <div>
                                                    <i class="fas fa-info-circle text-blue-600 mr-1"></i>
                                                    <span>Mínimo: <strong class="text-blue-700 dark:text-blue-300">{{ item.minimo_en_unidad_compra|floatformat:1 }} {{ item.unidad_compra }}</strong></span>
                                                </div>
                                            </div>
                                            
                                            {% if item.validation_error %}
                                            <div class="mt-2 text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded">
                                                <i class="fas fa-exclamation-circle mr-1"></i>{{ item.validation_error }}
                                            </div>
                                            {% endif %}
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Resumen del Pedido -->
                <div class="lg:col-span-1">
                    <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-md p-6 lg:p-8 lg:sticky lg:top-8 border border-gray-100 dark:border-slate-700">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center mb-6 pb-4 border-b border-gray-200 dark:border-slate-700">
                            <i class="fas fa-receipt text-green-600 mr-3"></i>
                            Resumen del Pedido
                        </h2>
                    
                    <div class="space-y-5">
                        <!-- Subtotal -->
                        <div class="flex justify-between items-center py-3">
                            <span class="text-gray-700 dark:text-gray-300 font-medium">Subtotal</span>
                            <span class="text-lg font-bold text-gray-900 dark:text-gray-100">${{ cart.get_total_price|floatformat:2 }}</span>
                        </div>
                        
                        <!-- Total -->
                        <div class="flex justify-between items-center py-4 bg-green-50 dark:bg-slate-700/50 rounded-2xl px-4 border-2 border-green-200 dark:border-slate-600">
                            <span class="text-lg font-bold text-gray-900 dark:text-gray-100">Total</span>
                            <span class="text-2xl font-bold text-green-700 dark:text-green-400">${{ cart.get_total_price|floatformat:2 }}</span>
                        </div>

                        <!-- Resumen de Cantidades por Unidad -->
                        {% if cart.totals_by_unit_items %}
                        <div class="mt-2 text-sm">
                            <div class="text-gray-700 dark:text-gray-300 font-medium mb-2 flex items-center">
                                <i class="fas fa-weight-hanging text-green-600 mr-2"></i>
                                Cantidades por unidad
                            </div>
                            <div class="flex flex-wrap gap-2">
                                {% for unidad, cantidad in cart.totals_by_unit_items %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full border-2 border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-100">
                                    <span class="font-semibold mr-1">{{ cantidad|floatformat:1 }}</span>
                                    <span class="uppercase tracking-wide text-xs">{{ unidad }}</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if cart.has_invalid_items %}
                        <div class="mb-4 p-3 rounded-xl border-2 border-red-200 bg-red-50 dark:border-red-900/50 dark:bg-red-900/20 text-red-700 dark:text-red-300 text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Corrige las cantidades inválidas para continuar con el pago.
                        </div>
                        {% endif %}

                        <!-- Botón de Pago -->
                        <form action="{% url 'create_order_from_cart' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" {% if cart.has_invalid_items %}disabled title="Hay productos con cantidades inválidas"{% endif %}
                                    class="w-full bg-green-900 hover:bg-green-800 text-white font-bold py-4 px-6 rounded-full transition duration-200 flex items-center justify-center {% if cart.has_invalid_items %}opacity-50 cursor-not-allowed hover:bg-green-900{% endif %}">
                                <i class="fas fa-credit-card mr-2"></i>
                                Proceder al Pago
                            </button>
                        </form>
                        
                        <p class="text-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i>
                            Se crearán los pedidos y podrás pagar con MercadoPago
                        </p>
                        
                        <!-- Información de Seguridad -->
                        <div class="bg-blue-50 dark:bg-slate-700/50 border-2 border-blue-200 dark:border-slate-600 rounded-2xl p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-shield-alt text-blue-600 text-lg mt-0.5"></i>
                                <div>
                                    <h3 class="text-sm font-bold text-blue-900 dark:text-gray-100 mb-1">Pago 100% Seguro</h3>
                                    <p class="text-xs text-blue-700 dark:text-gray-300">Protegido por MercadoPago</p>
                                    <p class="text-xs text-blue-600 dark:text-gray-300 mt-1">Acepta tarjetas, PSE y efectivo</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información de Entrega -->
                        <div class="bg-green-50 dark:bg-slate-700/50 border-2 border-green-200 dark:border-slate-600 rounded-2xl p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-truck text-green-600 text-lg mt-0.5"></i>
                                <div>
                                    <h3 class="text-sm font-bold text-green-900 dark:text-gray-100 mb-1">Entrega Directa</h3>
                                    <p class="text-xs text-green-700 dark:text-gray-300">Del productor a tu hogar</p>
                                    <p class="text-xs text-green-600 dark:text-gray-300 mt-1">3-5 días hábiles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="deleteModalContent">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4 rounded-t-2xl">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
                </div>
                <h3 class="ml-4 text-xl font-bold text-white">¿Eliminar producto?</h3>
            </div>
        </div>

        <!-- Body -->
        <div class="px-6 py-6">
            <p class="text-gray-700 dark:text-gray-300 text-base mb-4">
                ¿Estás seguro de que quieres eliminar <strong id="productName" class="text-gray-900 dark:text-white"></strong> de tu carrito?
            </p>
            
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 rounded mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300">
                            Esta acción eliminará el producto de tu carrito.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 font-semibold transition-colors">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <a id="confirmDelete" href="#" class="flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg font-semibold transition-all text-center shadow-lg">
                    <i class="fas fa-trash mr-2"></i>Sí, Eliminar
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Modal de eliminación
function showDeleteConfirm(itemId, productName) {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    const productNameEl = document.getElementById('productName');
    const confirmBtn = document.getElementById('confirmDelete');
    
    productNameEl.textContent = productName;
    confirmBtn.href = `/cart/remove/${itemId}/`;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    }, 300);
}

document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);

// Cerrar al hacer clic fuera del modal
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Funciones para manejar cantidad con decimales
function increaseQuantity(button) {
    const input = button.parentElement.querySelector('input[type="number"]');
    const step = parseFloat(input.getAttribute('step') || '0.1');
    const current = parseFloat(input.value || '0');
    const next = (current + step);
    input.value = next.toFixed(1);
    // NO disparar el evento change automáticamente
    // input.dispatchEvent(new Event('change'));
}

function decreaseQuantity(button) {
    const input = button.parentElement.querySelector('input[type="number"]');
    const step = parseFloat(input.getAttribute('step') || '0.1');
    const min = parseFloat(input.getAttribute('min') || '0');
    const current = parseFloat(input.value || '0');
    const next = Math.max(min, current - step);
    input.value = next.toFixed(1);
    // NO disparar el evento change automáticamente
    // input.dispatchEvent(new Event('change'));
}
</script>
{% endblock %}