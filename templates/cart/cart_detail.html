{% extends 'base.html' %}
{% load cart_tags %}

{% block title %}Mi Carrito de Compras{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Mi Carrito de Compras</h1>

    {% if not cart.items.all %}
        <div class="text-center py-16">
            <i class="fas fa-shopping-cart text-gray-300 text-8xl"></i>
            <p class="text-xl font-semibold text-gray-700 mt-8">Tu carrito está vacío.</p>
            <p class="text-gray-500 mt-2">Parece que todavía no has añadido nada a tu carrito.</p>
            <a href="{% url 'marketplace' %}" class="mt-6 inline-block bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300">
                ¡Empieza a comprar!
            </a>
        </div>
    {% else %}
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Lado izquierdo: Tabla de productos -->
            <div class="w-full md:w-2/3">
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Producto
                                </th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Precio Unitario
                                </th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Cantidad
                                </th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Subtotal
                                </th>
                                <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart.items.all %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                    <div class="flex items-center">
                                        {% if item.publication.imagen %}
                                            <div class="flex-shrink-0 w-20 h-20">
                                                <img class="w-full h-full rounded-md object-cover" src="{{ item.publication.imagen.url }}" alt="{{ item.publication.cultivo.nombre }}" />
                                            </div>
                                        {% endif %}
                                        <div class="ml-4">
                                            <p class="text-gray-900 font-semibold whitespace-no-wrap">
                                                {{ item.publication.cultivo.nombre }}
                                            </p>
                                            <p class="text-gray-600 text-xs whitespace-no-wrap">Vendido por: {{ item.publication.cultivo.productor.username }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                                    <p class="text-gray-900 whitespace-no-wrap">${{ item.publication.precio_por_unidad|floatformat:2 }}</p>
                                </td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                    <form action="{% url 'cart:update_cart' item.id %}" method="post" class="flex items-center justify-center">
                                        {% csrf_token %}
                                        <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.publication.cantidad_disponible }}" class="w-20 text-center bg-gray-100 border border-gray-300 rounded-md py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <button type="submit" class="ml-3 text-xs text-blue-600 hover:text-blue-800 font-semibold focus:outline-none">
                                            Actualizar
                                        </button>
                                    </form>
                                </td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-right">
                                    <p class="text-gray-900 font-bold whitespace-no-wrap">${{ item.get_item_price|floatformat:2 }}</p>
                                </td>
                                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center">
                                    <div class="flex justify-center items-center h-full">
                                        <a href="{% url 'cart:remove_from_cart' item.id %}" class="text-gray-400 hover:text-red-600 p-2 rounded-full transition-colors duration-200">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lado derecho: Resumen del pedido -->
            <div class="w-full md:w-1/3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4">Resumen del Pedido</h2>
                    <div class="flex justify-between items-center mb-2 pb-2 border-b">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-semibold">${{ cart.get_total_price|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between items-center font-bold text-lg mt-4">
                        <span>Total</span>
                        <span>${{ cart.get_total_price|floatformat:2 }}</span>
                    </div>
                    <div class="mt-6">
                        <form action="{% url 'create_order_from_cart' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="block w-full text-center bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300">
                                Realizar Pedido
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
