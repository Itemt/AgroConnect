{% load static %}
<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AgroConnect{% endblock %}</title>
    
    <!-- Meta Description -->
    <meta name="description" content="{% block description %}AgroConnect - Plataforma que conecta productores agrÃ­colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% block og_title %}AgroConnect - Del Campo a tu Hogar, Sin Intermediarios{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Plataforma que conecta productores agrÃ­colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIHZpZXdCb3g9IjAgMCAxMjAwIDYzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjMwIiBmaWxsPSJ1cmwoI2dyYWRpZW50KSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMyMmM1NWU7c3RvcC1vcGFjaXR5OjEiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMTU4MDNkO3N0b3Atb3BhY2l0eToxIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHRleHQgeD0iNjAwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI4MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BZ3JvQ29ubmVjdDwvdGV4dD4KPHRleHQgeD0iNjAwIiB5PSIzODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkRlbCBDYW1wbyBhIHR1IEhvZ2FyPC90ZXh0Pgo8L3N2Zz4K{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:alt" content="AgroConnect - Del Campo a tu Hogar">
    <meta property="og:site_name" content="AgroConnect">
    <meta property="og:locale" content="es_CO">
    
    <!-- Additional Open Graph tags for better compatibility -->
    <meta property="og:updated_time" content="{% now 'c' %}">
    <meta property="og:see_also" content="{{ request.scheme }}://{{ request.get_host }}">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta name="twitter:title" content="{% block twitter_title %}AgroConnect - Del Campo a tu Hogar, Sin Intermediarios{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Plataforma que conecta productores agrÃ­colas con compradores. Compra y vende productos frescos directamente del campo.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwMCIgaGVpZ2h0PSI2MzAiIHZpZXdCb3g9IjAgMCAxMjAwIDYzMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjEyMDAiIGhlaWdodD0iNjMwIiBmaWxsPSJ1cmwoI2dyYWRpZW50KSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMyMmM1NWU7c3RvcC1vcGFjaXR5OjEiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMTU4MDNkO3N0b3Atb3BhY2l0eToxIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHRleHQgeD0iNjAwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI4MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BZ3JvQ29ubmVjdDwvdGV4dD4KPHRleHQgeD0iNjAwIiB5PSIzODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkRlbCBDYW1wbyBhIHR1IEhvZ2FyPC90ZXh0Pgo8L3N2Zz4K{% endblock %}">
    <meta name="twitter:image:alt" content="AgroConnect - Del Campo a tu Hogar">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%2322c55e;stop-opacity:1' /><stop offset='100%25' style='stop-color:%2315803d;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23grad)'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>ðŸŒ±</text></svg>">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    
    <style>
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            overflow-x: hidden;
        }
        
        * {
            box-sizing: border-box;
        }
        
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Figtree', 'Inter', 'system-ui', 'sans-serif'],
                        'body': ['Figtree', 'sans-serif'],
                        'heading': ['Figtree', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            50: '#fef3c7',
                            100: '#fde68a',
                            200: '#fcd34d',
                            300: '#fbbf24',
                            400: '#f59e0b',
                            500: '#d97706',
                            600: '#b45309',
                            700: '#92400e',
                            800: '#78350f',
                            900: '#451a03',
                        }
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'strong': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.1)',
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    }
                }
            }
        }
    </script>
    {% block extra_head %}{% endblock %}
</head>
<body class="antialiased bg-white text-body font-body m-0 p-0">
    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-3 pointer-events-none">
        <!-- Las notificaciones se agregarÃ¡n aquÃ­ dinÃ¡micamente -->
    </div>

    <!-- Navigation -->
    {% if not request.resolver_match.url_name|slice:":8" == "producer" and not request.resolver_match.url_name|slice:":6" == "buyer_" and not request.resolver_match.url_name == "profile" and not request.resolver_match.url_name|slice:":12" == "conversation" and not request.resolver_match.url_name|slice:":4" == "crop" and not request.resolver_match.url_name|slice:":5" == "order" and not request.resolver_match.url_name|slice:":5" == "admin" %}
    <section class="overflow-hidden relative z-50" x-data="{ mobileNavOpen: false }">
        <nav class="py-4 border-b border-gray-100 w-full relative z-50">
            <div class="w-full px-4 lg:px-8">
                <div class="relative flex items-center justify-between">
                    <a href="{% url 'index' %}" class="inline-block">
                        <div class="flex items-center space-x-3 group">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-seedling text-white text-xl"></i>
                            </div>
                            <span class="text-2xl font-bold text-green-900">AgroConnect</span>
                        </div>
                    </a>

                    <ul class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden lg:flex items-center space-x-1">
                        <li><a class="inline-block text-green-900 hover:text-green-700 font-medium py-2.5 px-4 rounded-full transition duration-200" href="{% url 'marketplace' %}">Marketplace</a></li>
                        <li><a class="inline-block text-green-900 hover:text-green-700 font-medium py-2.5 px-4 rounded-full transition duration-200" href="{% url 'rankings' %}">Rankings</a></li>
                        <li><a class="inline-block text-green-900 hover:text-green-700 font-medium py-2.5 px-4 rounded-full transition duration-200" href="{% url 'core:documentation' %}">Ayuda</a></li>
                        {% if user.is_authenticated %}
                            {% if user.role == 'Productor' %}
                            <li><a class="inline-block text-green-900 hover:text-green-700 font-medium py-2.5 px-4 rounded-full transition duration-200" href="{% url 'producer_dashboard' %}">Dashboard</a></li>
                            {% elif user.role == 'Comprador' %}
                            <li><a class="inline-block text-green-900 hover:text-green-700 font-medium py-2.5 px-4 rounded-full transition duration-200" href="{% url 'buyer_dashboard' %}">Dashboard</a></li>
                            {% endif %}
                        {% endif %}
                    </ul>
                    
                    <!-- Right side buttons -->
                    <div class="flex items-center space-x-2">
                        {% if user.is_authenticated %}
                        <!-- Notifications Bell -->
                        <button id="notifications-button" type="button" class="relative p-2 text-green-900 hover:text-green-700 hover:bg-green-50 rounded-full transition duration-200" style="z-index: 10000;">
                            <i class="fas fa-bell text-lg"></i>
                            <span id="notifications-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 min-w-[1.25rem] px-1 flex items-center justify-center"></span>
                        </button>
                        <div id="notifications-dropdown" class="hidden fixed text-base list-none bg-white rounded-2xl shadow-2xl border border-gray-200 w-80 max-h-96 overflow-auto" style="z-index: 10001 !important;">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <span class="block text-sm font-semibold text-gray-900">Notificaciones</span>
                                <div class="flex space-x-2">
                                    <button id="mark-all-read" class="text-xs text-primary-700 hover:underline">Marcar todo como leÃ­do</button>
                                    <button id="delete-all-notifications" class="text-xs text-red-600 hover:underline">Borrar todas</button>
                                </div>
                            </div>
                            <div id="notifications-empty" class="py-6 text-center text-sm text-gray-600">No hay notificaciones</div>
                            <ul id="notifications-list" class="py-2 space-y-1 max-h-72 overflow-y-auto"></ul>
                            <div class="px-4 py-2 text-center">
                                <a href="{% url 'core:notifications_page' %}" class="text-sm text-primary-700 hover:underline">Ver todas las notificaciones</a>
                            </div>
                        </div>
                        
                        <!-- Cart Icon -->
                        <a href="{% url 'cart:cart_detail' %}" class="relative p-2 text-green-900 hover:text-green-700 hover:bg-green-50 rounded-full transition duration-200">
                            <i class="fas fa-shopping-cart text-lg"></i>
                            {% if cart.items.all|length > 0 %}
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">{{ cart.items.all|length }}</span>
                            {% endif %}
                        </a>

                        <!-- User Menu Button -->
                        <button type="button" class="flex text-sm rounded-full hover:bg-green-50 p-1.5 transition duration-200" id="user-menu-button" aria-expanded="false" data-dropdown-toggle="user-dropdown" data-dropdown-placement="bottom">
                            <span class="sr-only">Open user menu</span>
                            {% if user.profile_image %}
                                <img class="w-10 h-10 rounded-full" src="{{ user.profile_image.url }}" alt="user photo">
                            {% else %}
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-700 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                            {% endif %}
                        </button>
                        {% else %}
                        <div class="hidden lg:block">
                            <a class="inline-flex py-2.5 px-4 mr-3 items-center justify-center text-sm font-medium text-green-900 hover:text-white border border-green-900 hover:bg-green-900 rounded-full transition duration-200" href="{% url 'login' %}">Iniciar SesiÃ³n</a>
                            <a class="inline-flex py-2.5 px-4 items-center justify-center text-sm font-medium text-white border border-green-900 bg-green-900 hover:bg-green-800 rounded-full transition duration-200" href="{% url 'register' %}">Registrarse</a>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button class="lg:hidden text-green-900 hover:text-green-800" x-on:click="mobileNavOpen = !mobileNavOpen">
                            <svg width="32" height="32" viewbox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.19995 23.2H26.7999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M5.19995 16H26.7999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <path d="M5.19995 8.79999H26.7999" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Mobile Menu -->
        <div class="hidden fixed top-0 left-0 bottom-0 w-full xs:w-5/6 xs:max-w-md z-50" :class="{'block': mobileNavOpen, 'hidden': !mobileNavOpen}">
            <div class="fixed inset-0 bg-gray-900 opacity-50" x-on:click="mobileNavOpen = !mobileNavOpen"></div>
            <nav class="relative flex flex-col py-7 px-10 w-full h-full bg-white overflow-y-auto">
                <div class="flex items-center justify-between">
                    <a class="inline-block" href="{% url 'index' %}">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl flex items-center justify-center">
                                <i class="fas fa-seedling text-white"></i>
                            </div>
                            <span class="text-xl font-bold text-green-900">AgroConnect</span>
                        </div>
                    </a>
                    <button x-on:click="mobileNavOpen = !mobileNavOpen">
                        <svg width="32" height="32" viewbox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M23.2 8.79999L8.80005 23.2M8.80005 8.79999L23.2 23.2" stroke="#1D1F1E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                </div>
                <div class="pt-20 pb-12 mb-auto">
                    <ul class="flex-col">
                        <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'marketplace' %}">Marketplace</a></li>
                        <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'rankings' %}">Rankings</a></li>
                        <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'core:documentation' %}">Ayuda</a></li>
                        {% if user.is_authenticated %}
                            {% if user.role == 'Productor' %}
                            <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'producer_dashboard' %}">Dashboard</a></li>
                            {% elif user.role == 'Comprador' %}
                            <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'buyer_dashboard' %}">Dashboard</a></li>
                            {% endif %}
                            <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'profile' %}">Perfil</a></li>
                            <li><a class="inline-block text-red-600 hover:text-red-700 font-medium" href="{% url 'logout' %}">Cerrar SesiÃ³n</a></li>
                        {% else %}
                            <li class="mb-6"><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'login' %}">Iniciar SesiÃ³n</a></li>
                            <li><a class="inline-block text-green-900 hover:text-green-700 font-medium" href="{% url 'register' %}">Registrarse</a></li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
        </div>
    </section>
    {% endif %}
    
                    <!-- User Dropdown -->
                    <div class="z-50 hidden my-4 text-base list-none bg-white/95 backdrop-blur divide-y divide-gray-200 rounded-2xl shadow-strong border border-gray-200 w-56" id="user-dropdown">
                        {% if user.is_authenticated %}
                        <div class="px-6 py-4 bg-gradient-to-r from-primary-50 to-accent-50 rounded-t-2xl">
                            <span class="block text-sm font-semibold text-gray-900">{{ user.username }}</span>
                            <span class="block text-sm text-gray-600 truncate">{{ user.email }}</span>
                        </div>
                        <ul class="py-2" aria-labelledby="user-menu-button">
                            {% if user.is_staff %}
                            <li>
                                <a href="{% url 'admin_dashboard' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-cog mr-3"></i>Admin Dashboard
                                </a>
                            </li>
                            {% endif %}
                            <li>
                                <a href="{% url 'profile' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-user mr-3"></i>Perfil
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'conversation_list' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-comments mr-3"></i>Mensajes
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'core:documentation' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-book mr-3"></i>DocumentaciÃ³n
                                </a>
                            </li>
                            {% if user.role == 'Productor' %}
                            <li>
                                <a href="{% url 'producer_dashboard' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-seedling mr-3"></i>Cultivos
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'producer_sales' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-chart-line mr-3"></i>Ventas
                                </a>
                            </li>
                            {% elif user.role == 'Comprador' %}
                            <li>
                                <a href="{% url 'order_history' %}" class="block px-6 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200">
                                    <i class="fas fa-shopping-cart mr-3"></i>Pedidos
                                </a>
                            </li>
                            {% endif %}
                            <li class="border-t border-gray-200 mt-2 pt-2 mx-2">
                                <a href="{% url 'logout' %}" class="flex items-center px-4 py-3 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 transition-colors duration-200 rounded-lg">
                                    <i class="fas fa-sign-out-alt mr-3 w-4"></i>
                                    <span>Cerrar SesiÃ³n</span>
                                </a>
                            </li>
                        </ul>
                        {% else %}
                        <ul class="py-2" aria-labelledby="user-menu-button">
                            <li>
                                <a href="{% url 'login' %}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200 rounded-lg mx-2">
                                    <i class="fas fa-sign-in-alt mr-3 w-4"></i>
                                    <span>Iniciar SesiÃ³n</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'register' %}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition-colors duration-200 rounded-lg mx-2">
                                    <i class="fas fa-user-plus mr-3 w-4"></i>
                                    <span>Registrarse</span>
                                </a>
                            </li>
                        </ul>
                        {% endif %}
                    </div>

    <!-- Main Content -->
    <main style="background: transparent !important;">
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
      {% if not request.resolver_match.url_name|slice:":8" == "producer" and not request.resolver_match.url_name|slice:":6" == "buyer_" and not request.resolver_match.url_name == "profile" and not request.resolver_match.url_name|slice:":12" == "conversation" and not request.resolver_match.url_name|slice:":4" == "crop" and not request.resolver_match.url_name|slice:":5" == "order" and not request.resolver_match.url_name|slice:":5" == "admin" %}
      <footer class="bg-green-900 text-white mt-0 w-full">
          <div class="w-full px-4 lg:px-8 pt-12 lg:pt-16 pb-4 lg:pb-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 mb-12">
                <!-- About Section -->
                <div>
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-700 rounded-2xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-seedling text-white text-xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">AgroConnect</h3>
                    </div>
                    <p class="text-white/90 leading-relaxed mb-6">Conectando el campo con la ciudad. Una plataforma para facilitar el comercio justo y directo entre productores y compradores.</p>
                    <div class="flex items-center text-white/90">
                        <i class="fas fa-map-marker-alt mr-3"></i>
                        <span>Barrancabermeja, Santander</span>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="text-xl font-bold mb-6 text-white">Enlaces RÃ¡pidos</h3>
                    <ul class="space-y-3">
                        <li><a href="{% url 'marketplace' %}" class="text-white/90 hover:text-white transition">Marketplace</a></li>
                        <li><a href="{% url 'rankings' %}" class="text-white/90 hover:text-white transition">Rankings</a></li>
                        <li><a href="{% url 'core:documentation' %}" class="text-white/90 hover:text-white transition">Ayuda</a></li>
                        {% if user.is_authenticated %}
                        <li><a href="{% url 'profile' %}" class="text-white/90 hover:text-white transition">Mi Perfil</a></li>
                        {% else %}
                        <li><a href="{% url 'login' %}" class="text-white/90 hover:text-white transition">Iniciar SesiÃ³n</a></li>
                        <li><a href="{% url 'register' %}" class="text-white/90 hover:text-white transition">Registrarse</a></li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Contact & Social -->
                <div>
                    <h3 class="text-xl font-bold mb-6 text-white">Contacto</h3>
                    <div class="space-y-4 mb-6">
                        <div class="flex items-center text-white/90">
                            <i class="fas fa-phone mr-3"></i>
                            <span>+57 300 123 4567</span>
                        </div>
                        <div class="flex items-center text-white/90">
                            <i class="fas fa-envelope mr-3"></i>
                            <span>contacto@agroconnect.com</span>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <a href="#" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="pt-8 pb-4 border-t border-white/20">
                <div class="text-center">
                    <p class="text-white/80 mb-2">&copy; 2025 AgroConnect. Todos los derechos reservados.</p>
                    <p class="text-white/70 text-sm">Desarrollado por Cristian Ramos y Jhonnier Arguello - <a href="https://udi.edu.co/" target="_blank" class="underline hover:text-white transition">Universidad de InvestigaciÃ³n y Desarrollo - UDI</a></p>
                </div>
            </div>
        </div>
    </footer>
    {% endif %}

    <!-- Flowbite JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script>
    // Reinicializar Flowbite despuÃ©s de que todo se cargue
    document.addEventListener('DOMContentLoaded', function() {
        // Esperar a que Flowbite se cargue completamente
        setTimeout(function() {
            if (typeof Flowbite !== 'undefined' && typeof Flowbite.initDropdowns === 'function') {
                Flowbite.initDropdowns();
            } else {
                console.warn('Flowbite no estÃ¡ disponible o initDropdowns no es una funciÃ³n');
            }
        }, 100);
    });
    </script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/enhanced-ui.js' %}"></script>
    
    <!-- Floating AI Assistant Bubble -->
    <div id="assistant-bubble" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 z-40">
        <button id="assistant-toggle" class="w-12 h-12 md:w-14 md:h-14 rounded-full shadow-strong bg-gradient-to-br from-primary-500 to-primary-700 text-white flex items-center justify-center hover:scale-105 transition-transform">
            <i class="fas fa-robot text-lg md:text-xl"></i>
        </button>
        <div id="assistant-panel" class="hidden mt-3 w-[calc(100vw-2rem)] max-w-[20rem] sm:w-[24rem] md:w-[28rem] lg:w-[32rem] bg-white rounded-2xl shadow-strong border border-gray-200 overflow-hidden" style="height: 28rem;">
            <div class="px-3 py-2 md:px-4 md:py-3 bg-primary-600 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-robot text-sm md:text-base"></i>
                        <span class="font-semibold text-sm md:text-base">Asistente IA Â· AgroConnect</span>
                    </div>
                    <button id="assistant-close" class="text-white/80 hover:text-white"><i class="fas fa-times text-sm md:text-base"></i></button>
                </div>
            </div>
            <div class="border-b border-gray-200 flex">
                <button id="tab-ai" class="flex-1 px-2 py-2 md:px-3 text-xs md:text-sm font-medium bg-white">Asistente</button>
                <button id="tab-chat" class="flex-1 px-2 py-2 md:px-3 text-xs md:text-sm text-gray-600 bg-gray-100">Chats</button>
            </div>
            <div id="assistant-title" class="px-3 py-1 md:px-4 md:py-2 text-xs text-gray-600 bg-white border-b">Nueva conversaciÃ³n</div>
            <div id="assistant-messages" class="overflow-y-auto p-3 md:p-4 space-y-2 md:space-y-3 bg-gray-50" style="height: 16rem;">
                <div class="text-sm text-gray-700 bg-white rounded-xl p-3 shadow-soft">
                    Hola, Â¿en quÃ© te ayudo hoy?
                </div>
            </div>
            <div id="chat-pane" class="hidden bg-gray-50 flex flex-col" style="height: 16rem;">
                <!-- View: conversations list only -->
                <div id="chat-list-view" class="h-full flex flex-col">
                    <div class="p-2 md:p-3 border-b bg-white flex-shrink-0">
                        <input id="chat-search" type="text" placeholder="Buscar..." class="w-full text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div id="chat-list" class="flex-1 overflow-y-auto p-1 md:p-2 space-y-1 bg-white"></div>
                </div>
                <!-- View: thread with back button -->
                <div id="chat-thread-view" class="hidden h-full flex flex-col">
                    <div class="flex items-center justify-between px-2 md:px-3 py-2 border-b bg-white flex-shrink-0">
                        <button id="chat-back" class="text-primary-700 text-xs md:text-sm px-2 py-1 rounded hover:bg-primary-50"><i class="fas fa-arrow-left mr-1"></i>AtrÃ¡s</button>
                        <div id="chat-thread-title" class="text-xs md:text-sm text-gray-700 truncate ml-2 flex-1"></div>
                    </div>
                    <div id="chat-thread" class="flex-1 overflow-y-auto p-2 md:p-3 space-y-1 md:space-y-2 bg-gray-50"></div>
                    <form id="chat-form" class="flex items-center p-2 md:p-3 border-t border-gray-200 bg-white flex-shrink-0">
                        <input id="chat-input" type="text" class="flex-1 text-xs md:text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" placeholder="Escribe un mensaje..." required>
                        <button id="chat-send" class="ml-2 md:ml-3 px-2 md:px-3 py-1 md:py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                            <i class="fas fa-paper-plane text-xs md:text-sm"></i>
                        </button>
                    </form>
                </div>
            </div>
            <form id="assistant-form" class="flex items-center p-2 md:p-3 border-t border-gray-200 bg-white">
                <input id="assistant-input" type="text" class="flex-1 text-sm px-2 md:px-3 py-1 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 placeholder:text-sm" placeholder="Pregunta sobre la plataforma..." required>
                <button id="assistant-send" class="ml-2 md:ml-3 px-2 md:px-3 py-1 md:py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    <i class="fas fa-paper-plane text-xs md:text-sm"></i>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Toast Notification System -->
    <script>
        // Sistema de notificaciones toast
        window.showToast = function(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            // Crear el elemento toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification pointer-events-auto transform transition-all duration-300 ease-out translate-x-96 opacity-0';
            
            // Definir colores e iconos segÃºn el tipo
            const types = {
                success: {
                    bg: 'bg-gradient-to-r from-green-500 to-green-600',
                    icon: 'fa-check-circle',
                    iconBg: 'bg-green-700'
                },
                error: {
                    bg: 'bg-gradient-to-r from-red-500 to-red-600',
                    icon: 'fa-times-circle',
                    iconBg: 'bg-red-700'
                },
                warning: {
                    bg: 'bg-gradient-to-r from-yellow-500 to-yellow-600',
                    icon: 'fa-exclamation-triangle',
                    iconBg: 'bg-yellow-700'
                },
                info: {
                    bg: 'bg-gradient-to-r from-blue-500 to-blue-600',
                    icon: 'fa-info-circle',
                    iconBg: 'bg-blue-700'
                }
            };
            
            const config = types[type] || types.success;
            
            toast.innerHTML = `
                <div class="${config.bg} text-white px-4 py-3 rounded-xl shadow-2xl flex items-center space-x-3 min-w-[320px] max-w-md">
                    <div class="${config.iconBg} rounded-lg p-2 flex items-center justify-center">
                        <i class="fas ${config.icon} text-lg"></i>
                    </div>
                    <p class="flex-1 font-medium text-sm">${message}</p>
                    <button onclick="this.closest('.toast-notification').remove()" class="hover:bg-white/20 rounded-lg p-1.5 transition-colors">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            `;
            
            // Agregar al contenedor
            container.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => {
                toast.classList.remove('translate-x-96', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);
            
            // Auto-remover despuÃ©s de la duraciÃ³n
            setTimeout(() => {
                toast.classList.add('translate-x-96', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        };
        
        // Manejar mensajes de Django
        {% if messages %}
            document.addEventListener('DOMContentLoaded', function() {
                {% for message in messages %}
                    showToast(
                        '{{ message|escapejs }}',
                        '{{ message.tags|default:"info" }}'.replace('error', 'error').replace('success', 'success').replace('warning', 'warning').replace('info', 'info'),
                        4000
                    );
                {% endfor %}
            });
        {% endif %}
        {% if user.is_authenticated %}
        // WebSocket para notificaciones
        (function(){
            let pollingInterval = null;
            
            function updateBadge(count){
                const badge = document.getElementById('notifications-badge');
                if (!badge) return;
                if (count > 0){
                    badge.textContent = count > 9 ? '9+' : String(count);
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            
            function fetchNotifications() {
                fetch('{% url "core:notifications_list" %}', { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(res => {
                        if (res && res.success) {
                            const unreadCount = res.notifications.filter(n => !n.is_read).length;
                            updateBadge(unreadCount);
                            console.log('Notifications polled:', unreadCount, 'unread');
                        }
                    })
                    .catch((error) => {
                        console.log('Polling error:', error);
                    });
            }
            
            function startPolling() {
                if (pollingInterval) return; // Already polling
                pollingInterval = setInterval(fetchNotifications, 500); // Poll every 0.5 seconds
            }
            
            function stopPolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }

            function addNotificationToList(payload){
                const list = document.getElementById('notifications-list');
                if (!list) return;
                const li = document.createElement('li');
                li.className = 'notification-item unread px-4 py-2 hover:bg-primary-50/50 transition-colors';
                const icon = payload.category === 'payment' ? 'fa-credit-card' : (payload.category === 'order' ? 'fa-box' : 'fa-info-circle');
                li.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="mt-0.5 text-primary-600"><i class="fas ${icon}"></i></div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${payload.title || 'NotificaciÃ³n'}</p>
                            <p class="text-sm text-gray-600">${payload.message || ''}</p>
                        </div>
                    </div>
                `;
                list.prepend(li);
                const current = parseInt(document.getElementById('notifications-badge')?.textContent || '0') || 0;
                updateBadge(current + 1);
                toggleEmptyState();
            }

            function renderNotifications(items){
                const list = document.getElementById('notifications-list');
                if (!list) return;
                list.innerHTML = '';
                const arr = Array.isArray(items) ? items : [];
                arr.forEach(n => {
                    const li = document.createElement('li');
                    li.className = 'notification-item ' + (n.is_read ? 'read' : 'unread') + ' px-4 py-2 hover:bg-primary-50/50 transition-colors';
                    const icon = n.category === 'payment' ? 'fa-credit-card' : (n.category === 'order' ? 'fa-box' : 'fa-info-circle');
                    
                    // Si tiene order_id, hacer clickeable
                    if (n.order_id) {
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', function() {
                            window.location.href = `/order/${n.order_id}/`;
                        });
                    }
                    
                    li.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="mt-0.5 text-primary-600"><i class="fas ${icon}"></i></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${n.title}</p>
                                <p class="text-sm text-gray-600">${n.message}</p>
                            </div>
                        </div>
                    `;
                    list.appendChild(li);
                });
                const unreadCount = arr.filter(n => !n.is_read).length;
                updateBadge(unreadCount);
                toggleEmptyState();
            }

            function toggleEmptyState(){
                const list = document.getElementById('notifications-list');
                const empty = document.getElementById('notifications-empty');
                if (!list || !empty) return;
                const hasItems = list.children.length > 0;
                empty.classList.toggle('hidden', hasItems);
            }

            // WebSocket eliminado - usar solo polling

            // Initialize
            document.addEventListener('DOMContentLoaded', function(){
                updateBadge(0);
                // Fetch notifications immediately
                fetchNotifications();
                // Start polling for notifications
                startPolling();
                console.log('Notifications polling started');
                
                // Stop polling when page is hidden (performance optimization)
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        stopPolling();
                        console.log('Polling stopped (page hidden)');
                    } else {
                        startPolling();
                        console.log('Polling started (page visible)');
                    }
                });
                // Load on dropdown open
                const btn = document.getElementById('notifications-button');
                const dropdown = document.getElementById('notifications-dropdown');
                const markAllBtn = document.getElementById('mark-all-read');
                
                if (btn && dropdown){
                    btn.addEventListener('click', function(e){
                        e.stopPropagation();
                        dropdown.classList.toggle('hidden');
                        
                        if (!dropdown.classList.contains('hidden')) {
                            // Position dropdown below button
                            const rect = btn.getBoundingClientRect();
                            dropdown.style.top = (rect.bottom + 8) + 'px';
                            dropdown.style.right = '16px';
                            
                            fetch('{% url "core:notifications_list" %}', { credentials: 'same-origin' })
                              .then(r => r.json()).then(res => {
                                  if (res && res.success){ 
                                      renderNotifications(res.notifications);
                                      const unreadCount = res.notifications.filter(n => !n.is_read).length;
                                      updateBadge(unreadCount);
                                  }
                                  else { toggleEmptyState(); }
                              }).catch(()=>{ toggleEmptyState(); });
                        }
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function(e){
                        if (!dropdown.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
                            dropdown.classList.add('hidden');
                        }
                    });
                    
                    // Reposition on window resize
                    window.addEventListener('resize', function(){
                        if (!dropdown.classList.contains('hidden')) {
                            const rect = btn.getBoundingClientRect();
                            dropdown.style.top = (rect.bottom + 8) + 'px';
                            dropdown.style.right = '16px';
                        }
                    });
                }
                function getCookie(name){
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }

                if (markAllBtn){
                    markAllBtn.addEventListener('click', function(e){
                        e.preventDefault();
                        const csrftoken = getCookie('csrftoken');
                        fetch('{% url "core:notifications_mark_all_read" %}', { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }, credentials: 'same-origin', body: '{}' })
                          .then(r => r.json()).then(res => {
                              if (res && res.success){
                                  document.querySelectorAll('#notifications-list .notification-item').forEach(el => {
                                      el.classList.remove('unread');
                                      el.classList.add('read');
                                  });
                                  updateBadge(0);
                              }
                          }).catch(()=>{});
                    });
                }

        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm) {
            // Crear modal de confirmaciÃ³n personalizado
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-sm sm:max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="px-4 py-4 sm:px-6 sm:py-6">
                        <div class="flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 bg-gradient-to-br from-red-100 to-red-200 rounded-full">
                            <i class="fas fa-exclamation-triangle text-2xl sm:text-3xl text-red-600"></i>
                        </div>
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900 text-center mb-2">${title}</h3>
                        <p class="text-sm sm:text-base text-gray-600 text-center mb-6">${message}</p>
                        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                            <button id="confirm-btn" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-xl text-sm sm:text-base font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-trash mr-2"></i>${confirmText}
                            </button>
                            <button id="cancel-btn" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-3 rounded-xl text-sm sm:text-base font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-times mr-2"></i>${cancelText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners
            document.getElementById('confirm-btn').addEventListener('click', function() {
                document.body.removeChild(modal);
                onConfirm();
            });
            
            document.getElementById('cancel-btn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Delete all notifications button
        const deleteAllBtn = document.getElementById('delete-all-notifications');
        if (deleteAllBtn){
            deleteAllBtn.addEventListener('click', function(e){
                e.preventDefault();
                showConfirmDialog(
                    'Â¿EstÃ¡s seguro de que quieres borrar TODAS las notificaciones?',
                    'Esta acciÃ³n no se puede deshacer.',
                    'Borrar todas',
                    'Cancelar',
                    function() {
                        const csrftoken = getCookie('csrftoken');
                        fetch('{% url "core:notifications_delete_all" %}', { 
                            method: 'POST', 
                            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }, 
                            credentials: 'same-origin', 
                            body: '{}' 
                        }).then(r => r.json()).then(res => {
                            if (res && res.success){ 
                                renderNotifications([]); 
                                updateBadge(0);
                                showToast(`Se eliminaron ${res.deleted_count} notificaciones.`, 'success');
                            }
                        }).catch(()=>{
                            showToast('Error al eliminar notificaciones', 'error');
                        });
                    }
                );
            });
        }
            });
        })();
        {% endif %}
    </script>
    
    <!-- Assistant Bubble Logic -->
    <script>
        (function(){
            const bubble = document.getElementById('assistant-bubble');
            if (!bubble) return;
            const panel = document.getElementById('assistant-panel');
            const toggle = document.getElementById('assistant-toggle');
            const closeBtn = document.getElementById('assistant-close');
            const form = document.getElementById('assistant-form');
            const input = document.getElementById('assistant-input');
            const messages = document.getElementById('assistant-messages');
            const aiTitle = document.getElementById('assistant-title');
            const sendBtn = document.getElementById('assistant-send');
            const tabAI = document.getElementById('tab-ai');
            const tabChat = document.getElementById('tab-chat');
            const chatPane = document.getElementById('chat-pane');
            const chatList = document.getElementById('chat-list');
            const chatThread = document.getElementById('chat-thread');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatListView = document.getElementById('chat-list-view');
            const chatThreadView = document.getElementById('chat-thread-view');
            const chatBack = document.getElementById('chat-back');
            const chatTitle = document.getElementById('chat-thread-title');
            let activeConversationId = null;
            let lastMsgId = 0;
            let polling = false;
            let conversationsCache = [];

            function appendMessage(text, from){
                const div = document.createElement('div');
                div.className = `text-sm rounded-xl p-3 shadow-soft ${from === 'user' ? 'bg-primary-600 text-white ml-10' : 'bg-white text-gray-800 mr-10'}`;
                if (from === 'bot'){
                    // Render minimal markdown: **bold** and '- ' lists
                    const html = (text || '')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
                        .split('\n')
                        .map(line => line.trim().startsWith('- ')
                            ? `<li>${line.trim().substring(2)}</li>`
                            : `<p>${line}</p>`)
                        .join('');
                    div.innerHTML = html.includes('<li>') ? `<ul class="list-disc ml-4 space-y-1">${html}<\/ul>` : html;
                } else {
                    div.textContent = text;
                }
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            function setTyping(state){
                let el = document.getElementById('assistant-typing');
                if (state){
                    if (!el){
                        el = document.createElement('div');
                        el.id = 'assistant-typing';
                        el.className = 'text-xs text-gray-600 italic mr-10 px-3 py-2';
                        el.textContent = 'El asistente estÃ¡ escribiendoâ€¦';
                        messages.appendChild(el);
                        messages.scrollTop = messages.scrollHeight;
                    }
                } else if (el){
                    el.remove();
                }
            }

            function setTitleIfEmpty(fromText){
                try{
                    if (fromText){
                        const t = fromText.trim().replace(/\s+/g,' ').slice(0,60);
                        aiTitle.textContent = t || 'Nueva conversaciÃ³n';
                    } else {
                        aiTitle.textContent = 'Nueva conversaciÃ³n';
                    }
                }catch(_){/* ignore */}
            }

            // Resetear tÃ­tulo al cargar la pÃ¡gina
            setTitleIfEmpty('');

            function getCookie(name){
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            toggle.addEventListener('click', ()=>{ panel.classList.toggle('hidden'); });
            closeBtn.addEventListener('click', ()=>{ panel.classList.add('hidden'); });

            // Tabs
            if (tabAI && tabChat){
                tabAI.addEventListener('click', ()=>{
                    tabAI.classList.remove('text-gray-600','bg-gray-100');
                    tabAI.classList.add('font-medium','bg-white');
                    tabChat.classList.remove('font-medium','bg-white');
                    tabChat.classList.add('text-gray-600','bg-gray-100');
                    aiTitle.classList.remove('hidden');
                    messages.classList.remove('hidden');
                    form.classList.remove('hidden');
                    chatPane.classList.add('hidden');
                });
                tabChat.addEventListener('click', ()=>{
                    tabChat.classList.remove('text-gray-600','bg-gray-100');
                    tabChat.classList.add('font-medium','bg-white');
                    tabAI.classList.remove('font-medium','bg-white');
                    tabAI.classList.add('text-gray-600','bg-gray-100');
                    aiTitle.classList.add('hidden');
                    messages.classList.add('hidden');
                    form.classList.add('hidden');
                    chatPane.classList.remove('hidden');
                    // Start in list view
                    if (chatListView && chatThreadView){
                        chatListView.classList.remove('hidden');
                        chatThreadView.classList.add('hidden');
                    }
                    loadConversations();
                });
            }

            form.addEventListener('submit', function(e){
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;
                appendMessage(text, 'user');
                input.value = '';
                sendBtn.disabled = true;
                setTyping(true);
                const csrftoken = getCookie('csrftoken');
                setTitleIfEmpty(text);
                fetch('{% url "core:assistant_reply" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    credentials: 'same-origin',
                    body: JSON.stringify({ message: text })
                }).then(r=>r.json()).then(res=>{
                    setTyping(false);
                    if (res && res.success){
                        appendMessage(res.reply + (res.model && res.model !== 'fallback' ? `\n\n` : ''), 'bot');
                        if (res.model && res.model !== 'fallback'){
                            const modelTag = document.createElement('div');
                            modelTag.className = 'text-[10px] text-gray-500 mt-1 mr-10 text-right';
                            modelTag.textContent = `Respuesta IA: ${res.model}`;
                            messages.appendChild(modelTag);
                        }
                    } else { appendMessage('Lo siento, hubo un problema. Intenta de nuevo.', 'bot'); }
                }).catch(()=>{
                    setTyping(false);
                    appendMessage('No pude conectar con el asistente.', 'bot');
                }).finally(()=>{
                    sendBtn.disabled = false;
                });
            });

            // Mini chat helpers
            function renderConvList(items){
                chatList.innerHTML = '';
                (items || []).forEach(c => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-primary-50';
                    btn.innerHTML = `<div class="font-medium">${c.other_user}</div><div class="text-xs text-gray-600 truncate">${c.last_message || ''}</div>`;
                    btn.addEventListener('click', ()=>{
                        activeConversationId = c.id;
                        chatThread.innerHTML = '';
                        lastMsgId = 0;
                        // Switch to thread view
                        if (chatListView && chatThreadView){
                            chatListView.classList.add('hidden');
                            chatThreadView.classList.remove('hidden');
                        }
                        if (chatTitle){ chatTitle.textContent = c.other_user || 'Chat'; }
                        pollMessages();
                    });
                    chatList.appendChild(btn);
                });
            }

            function loadConversations(){
                // Only last 15 days
                const since = new Date(Date.now() - 15*24*60*60*1000).toISOString().slice(0,10);
                fetch(`/api/conversations/?since=${since}`, { credentials: 'same-origin' })
                  .then(r=>r.json()).then(res=>{
                    if (res && res.success){
                        conversationsCache = res.conversations || [];
                        renderConvList(conversationsCache);
                        // Mostrar aviso si hay archivadas
                        if ((res.archived_count||0) > 0){
                            const note = document.createElement('div');
                            note.className = 'text-xs text-gray-600 px-3 py-2';
                            note.innerHTML = `Tienes ${res.archived_count} conversaciones archivadas (&gt;15 dÃ­as). <a href="/conversations/" class="text-primary-700 underline">Ver panel</a>`;
                            chatList.prepend(note);
                        }
                    }
                  }).catch(()=>{});
            }

            // Filtro de conversaciones
            const chatSearch = document.getElementById('chat-search');
            if (chatSearch){
                chatSearch.addEventListener('input', function(){
                    const q = this.value.toLowerCase().trim();
                    const filtered = conversationsCache.filter(c =>
                        (c.other_user||'').toLowerCase().includes(q) || (c.last_message||'').toLowerCase().includes(q)
                    );
                    renderConvList(filtered);
                });
            }

            function pollMessages(){
                if (!activeConversationId || polling) return;
                polling = true;
                fetch(`/conversation/${activeConversationId}/messages/?since=${lastMsgId}`, { credentials: 'same-origin' })
                  .then(r=>r.json()).then(data=>{
                    (data.messages||[]).forEach(m=>{
                        const div = document.createElement('div');
                        const own = Number('{{ user.id|default:0 }}') === m.sender_id;
                        div.className = `text-sm rounded-xl p-2 ${own ? 'bg-primary-600 text-white ml-10' : 'bg-white text-gray-800 mr-10'}`;
                        div.textContent = m.content;
                        chatThread.appendChild(div);
                        lastMsgId = Math.max(lastMsgId, m.id);
                        chatThread.scrollTop = chatThread.scrollHeight;
                    });
                    polling = false;
                  }).catch(()=>{ polling = false; });
            }

            setInterval(()=>{ if (chatPane && !chatPane.classList.contains('hidden') && activeConversationId) pollMessages(); }, 500);

            // Back button to conversations list
            if (chatBack){
                chatBack.addEventListener('click', function(){
                    activeConversationId = null;
                    if (chatListView && chatThreadView){
                        chatThreadView.classList.add('hidden');
                        chatListView.classList.remove('hidden');
                        chatThread.innerHTML = '';
                    }
                });
            }

            chatForm.addEventListener('submit', function(e){
                e.preventDefault();
                if (!activeConversationId){
                    const warn = document.createElement('div');
                    warn.className = 'text-xs text-red-600 px-3 pb-2';
                    warn.textContent = 'Primero selecciona una conversaciÃ³n.';
                    chatThread.prepend(warn);
                    setTimeout(()=> warn.remove(), 3000);
                    return;
                }
                const text = chatInput.value.trim();
                if (!text) return;
                const fd = new FormData();
                fd.append('content', text);
                fd.append('csrfmiddlewaretoken', getCookie('csrftoken'));
                fetch(`/conversation/${activeConversationId}/`, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                  .then(r=>r.json()).then(res=>{
                    if (res && res.success){
                        const div = document.createElement('div');
                        div.className = 'text-sm rounded-xl p-2 bg-primary-600 text-white ml-10';
                        div.textContent = res.message.content;
                        chatThread.appendChild(div);
                        lastMsgId = Math.max(lastMsgId, res.message.id);
                        chatInput.value = '';
                        chatThread.scrollTop = chatThread.scrollHeight;
                    } else if (res && res.archived){
                        // Si la conversaciÃ³n estÃ¡ archivada, redirigir al panel completo
                        window.location.href = '/conversations/';
                    }
                  }).catch(()=>{});
            });
        })();
    </script>
    
    {% block extra_js %}
    {% endblock %}
</body>
</html>
