{% extends 'accounts/producer_base_tailadmin.html' %}

{% block title %}{% if form.instance.pk %}Editar Cultivo{% else %}Añadir Nuevo Cultivo{% endif %} - AgroConnect{% endblock %}

{% block producer_content %}
<style>
    /* Forzar que el contenedor principal ocupe todo el ancho disponible */
    #main-content > div.p-4.mx-auto.max-w-7xl.md\:p-6 {
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
    
    #main-content footer.p-4.mx-auto.max-w-7xl.md\:p-6 {
        max-width: 100%;
        margin: 0;
    }
    
    /* Estilos para inputs, selects y textareas del formulario */
    form input[type="text"],
    form input[type="number"],
    form input[type="email"],
    form input[type="date"],
    form select,
    form textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: all 0.15s ease-in-out;
    }
    
    /* Dark mode para inputs */
    .dark form input[type="text"],
    .dark form input[type="number"],
    .dark form input[type="email"],
    .dark form input[type="date"],
    .dark form select,
    .dark form textarea {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    /* Focus states */
    form input[type="text"]:focus,
    form input[type="number"]:focus,
    form input[type="email"]:focus,
    form input[type="date"]:focus,
    form select:focus,
    form textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .dark form input[type="text"]:focus,
    .dark form input[type="number"]:focus,
    .dark form input[type="email"]:focus,
    .dark form input[type="date"]:focus,
    .dark form select:focus,
    .dark form textarea:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    
    /* Textarea específico */
    form textarea {
        min-height: 120px;
        resize: vertical;
    }
    
    /* Select específico */
    form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
    }
    
    .dark form select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%9ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    }
    
    /* Labels en modo oscuro */
    .dark label {
        color: #e5e7eb !important;
    }
    
    /* File input */
    form input[type="file"] {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        color: #1f2937;
        background-color: #ffffff;
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        cursor: pointer;
    }
    
    .dark form input[type="file"] {
        color: #f9fafb;
        background-color: #374151;
        border-color: #4b5563;
    }
    
    form input[type="file"]:hover {
        border-color: #9ca3af;
    }
    
    .dark form input[type="file"]:hover {
        border-color: #6b7280;
    }
</style>

<div class="bg-gradient-to-br from-green-50 via-white to-emerald-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 py-8 px-4 sm:px-6 lg:px-8 min-h-screen" style="padding-bottom: 2rem !important;">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10 lg:mb-12">
            <div class="flex mb-4 items-center justify-center">
                <svg width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="4" r="4" fill="#15803d"></circle>
                </svg>
                <span class="inline-block ml-2 text-sm font-medium text-green-900 dark:text-green-300">Cultivos</span>
            </div>
            <h1 class="font-heading text-4xl sm:text-5xl lg:text-6xl font-bold text-green-900 dark:text-gray-100 mb-4">
                {% if form.instance.pk %}Editar Cultivo{% else %}Añadir Nuevo Cultivo{% endif %}
            </h1>
            <p class="text-base lg:text-lg text-gray-700 dark:text-gray-300">
                {% if form.instance.pk %}Actualiza los detalles de tu cultivo{% else %}Rellena el formulario para añadir un nuevo cultivo{% endif %}
            </p>
        </div>

        <!-- Formulario -->
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-md p-6 lg:p-10">
            <form method="post" enctype="multipart/form-data" id="crop-form" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Información Básica -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-info-circle text-green-600 dark:text-green-400 mr-3"></i>
                            Información Básica
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Finca -->
                            <div>
                                <label for="{{ form.finca.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-tractor text-green-600 dark:text-green-400 mr-2"></i>{{ form.finca.label }}{% if form.finca.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.finca }}
                                {% if form.finca.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.finca.help_text }}</p>
                                {% endif %}
                                {% for error in form.finca.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <!-- Nombre -->
                            <div>
                                <label for="{{ form.nombre.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-seedling text-green-600 dark:text-green-400 mr-2"></i>{{ form.nombre.label }}{% if form.nombre.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.nombre.help_text }}</p>
                                {% endif %}
                                {% for error in form.nombre.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Características del Cultivo -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-leaf text-green-600 dark:text-green-400 mr-3"></i>
                            Características del Cultivo
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Categoría -->
                            <div>
                                <label for="{{ form.categoria.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-tag text-blue-600 dark:text-blue-400 mr-2"></i>{{ form.categoria.label }}{% if form.categoria.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.categoria }}
                                {% if form.categoria.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.categoria.help_text }}</p>
                                {% endif %}
                                {% for error in form.categoria.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <!-- Área Ocupada -->
                            <div>
                                <label for="{{ form.area_ocupada.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-ruler text-blue-600 dark:text-blue-400 mr-2"></i>{{ form.area_ocupada.label }}{% if form.area_ocupada.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.area_ocupada }}
                                {% if form.area_ocupada.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.area_ocupada.help_text }}</p>
                                {% endif %}
                                {% for error in form.area_ocupada.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Cantidad y Medida -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-weight text-green-600 dark:text-green-400 mr-3"></i>
                            Cantidad y Medida
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Cantidad Estimada -->
                            <div>
                                <label for="{{ form.cantidad_estimada.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-calculator text-purple-600 dark:text-purple-400 mr-2"></i>{{ form.cantidad_estimada.label }}{% if form.cantidad_estimada.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.cantidad_estimada }}
                                {% if form.cantidad_estimada.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.cantidad_estimada.help_text }}</p>
                                {% endif %}
                                {% for error in form.cantidad_estimada.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <!-- Unidad de Medida -->
                            <div>
                                <label for="{{ form.unidad_medida.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-balance-scale text-purple-600 dark:text-purple-400 mr-2"></i>{{ form.unidad_medida.label }}{% if form.unidad_medida.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.unidad_medida }}
                                {% if form.unidad_medida.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.unidad_medida.help_text }}</p>
                                {% endif %}
                                {% for error in form.unidad_medida.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Estado y Fechas -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-calendar text-green-600 dark:text-green-400 mr-3"></i>
                            Estado y Fechas
                        </h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Estado -->
                            <div>
                                <label for="{{ form.estado.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-info-circle text-orange-600 dark:text-orange-400 mr-2"></i>{{ form.estado.label }}{% if form.estado.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.estado }}
                                {% if form.estado.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.estado.help_text }}</p>
                                {% endif %}
                                {% for error in form.estado.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <!-- Fecha de Disponibilidad -->
                            <div>
                                <label for="{{ form.fecha_disponibilidad.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                    <i class="fas fa-calendar text-orange-600 dark:text-orange-400 mr-2"></i>{{ form.fecha_disponibilidad.label }}
                                    {% if form.fecha_disponibilidad.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.fecha_disponibilidad }}
                                {% if form.fecha_disponibilidad.help_text %}
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.fecha_disponibilidad.help_text }}</p>
                                {% endif %}
                                {% for error in form.fecha_disponibilidad.errors %}
                                <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Notas Adicionales -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                            <i class="fas fa-sticky-note text-green-600 dark:text-green-400 mr-3"></i>
                            Notas Adicionales
                        </h2>
                        
                        <div>
                            <label for="{{ form.notas.id_for_label }}" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2.5">
                                <i class="fas fa-comment text-green-600 dark:text-green-400 mr-2"></i>{{ form.notas.label }}
                            </label>
                            {{ form.notas }}
                            {% if form.notas.help_text %}
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.notas.help_text }}</p>
                            {% endif %}
                            {% for error in form.notas.errors %}
                            <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
            </form>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex flex-col sm:flex-row gap-4 pt-6 mt-6">
            <a href="{% url 'crop_list' %}" class="flex-1 inline-flex items-center justify-center px-6 py-3.5 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-xl font-medium transition-colors">
                <i class="fas fa-times mr-2"></i>
                Cancelar
            </a>
            <button type="submit" form="crop-form" class="flex-1 inline-flex items-center justify-center py-3 px-8 text-base font-medium text-white bg-green-900 hover:bg-green-800 rounded-full transition duration-200">
                <i class="fas fa-save mr-2"></i>
                {% if form.instance.pk %}Guardar Cambios{% else %}Añadir Cultivo{% endif %}
            </button>
        </div>
    </div>
</div>

<script>
function toggleFechaDisponibilidad() {
    const estadoSelect = document.getElementById('id_estado');
    const fechaInput = document.getElementById('id_fecha_disponibilidad');
    const fechaLabel = document.querySelector('label[for="id_fecha_disponibilidad"]');
    
    if (estadoSelect && fechaInput && fechaLabel) {
        const estado = estadoSelect.value;
        
        if (estado === 'cosechado') {
            // Si es cosechado, hacer el campo opcional
            fechaInput.removeAttribute('required');
            fechaInput.required = false;
            // Remover el asterisco y agregar (Opcional)
            let labelText = fechaLabel.innerHTML;
            // Remover asterisco rojo si existe
            labelText = labelText.replace(/<span class="text-red-500">\*<\/span>/g, '');
            // Remover (Opcional) si ya existe
            labelText = labelText.replace(/<span[^>]*>\(Opcional\)<\/span>/g, '');
            // Agregar (Opcional)
            fechaLabel.innerHTML = labelText.trim() + ' <span class="text-gray-500 dark:text-gray-400">(Opcional)</span>';
        } else {
            // Si no es cosechado, hacer el campo obligatorio
            fechaInput.setAttribute('required', 'required');
            fechaInput.required = true;
            // Remover (Opcional) y agregar asterisco
            let labelText = fechaLabel.innerHTML;
            // Remover (Opcional) si existe
            labelText = labelText.replace(/<span[^>]*>\(Opcional\)<\/span>/g, '');
            // Agregar asterisco si no existe
            if (!labelText.includes('text-red-500')) {
                fechaLabel.innerHTML = labelText.trim() + ' <span class="text-red-500">*</span>';
            } else {
                fechaLabel.innerHTML = labelText.trim();
            }
        }
    }
}

// Ejecutar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    toggleFechaDisponibilidad();
    
    // Agregar listener al cambio de estado
    const estadoSelect = document.getElementById('id_estado');
    if (estadoSelect) {
        estadoSelect.addEventListener('change', toggleFechaDisponibilidad);
    }
    
    // Hacer scroll al primer campo con error después de que se renderice el formulario
    setTimeout(function() {
        scrollToFirstError();
    }, 100);
});

// Función para hacer scroll al primer campo con error
function scrollToFirstError() {
    // Buscar todos los elementos con errores (Django usa .errorlist)
    const errorLists = document.querySelectorAll('.errorlist, p.text-red-600, p.text-red-400');
    
    if (errorLists.length > 0) {
        let targetElement = null;
        
        // Para cada lista de errores, buscar el campo asociado
        for (let errorElement of errorLists) {
            // Buscar el div padre que contiene el campo
            const parentDiv = errorElement.closest('div');
            if (parentDiv) {
                // Buscar el input, select o textarea dentro del mismo div
                const field = parentDiv.querySelector('input, select, textarea');
                if (field) {
                    targetElement = field;
                    break;
                }
            }
        }
        
        // Si no encontramos por el método anterior, buscar por el label
        if (!targetElement) {
            for (let errorElement of errorLists) {
                const parentDiv = errorElement.closest('div');
                if (parentDiv) {
                    // Buscar el label anterior
                    const label = parentDiv.querySelector('label');
                    if (label && label.getAttribute('for')) {
                        const fieldId = label.getAttribute('for');
                        const field = document.getElementById(fieldId);
                        if (field) {
                            targetElement = field;
                            break;
                        }
                    }
                }
            }
        }
        
        // Si encontramos un elemento, hacer scroll y enfocar
        if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(function() {
                targetElement.focus();
                // Agregar un borde rojo temporalmente para destacar el campo
                targetElement.style.borderColor = '#ef4444';
                targetElement.style.borderWidth = '2px';
                setTimeout(function() {
                    targetElement.style.borderColor = '';
                    targetElement.style.borderWidth = '';
                }, 3000);
            }, 300);
        } else if (errorLists.length > 0) {
            // Si no encontramos el campo, hacer scroll al primer error
            errorLists[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

// Interceptar el submit del formulario para validar antes de enviar
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Validar campos requeridos antes de enviar
            const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');
            let firstInvalidField = null;
            
            requiredFields.forEach(function(field) {
                // Verificar si el campo está vacío
                if (!field.value || field.value.trim() === '') {
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                    // Agregar clase de error
                    field.classList.add('border-red-500');
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            // Si hay campos inválidos, hacer scroll al primero
            if (firstInvalidField) {
                e.preventDefault();
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
                firstInvalidField.style.borderColor = '#ef4444';
                firstInvalidField.style.borderWidth = '2px';
                return false;
            }
        });
    }
});
</script>
{% endblock %}