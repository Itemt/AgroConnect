{% extends 'accounts/user_base.html' %}
{% load static %}

{% block title %}Pedidos Creados - Proceder al Pago{% endblock %}

{% block user_content %}
<div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Header con gradiente -->
    <div class="card mb-6 overflow-hidden">
        <div class="bg-gradient-to-r from-primary-600 via-primary-700 to-accent-600 px-6 py-8 relative">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-32 -mt-32"></div>
            <div class="relative text-center">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-20 backdrop-blur-sm rounded-full mb-4">
                    <i class="fas fa-check-circle text-white text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Pedidos Creados Exitosamente</h1>
                <p class="text-primary-100">Ahora puedes proceder con el pago de tus pedidos</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Columna Izquierda: Lista de Pedidos -->
        <div class="lg:col-span-2 space-y-6">
            <div class="card">
                <div class="px-6 py-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-receipt text-primary-600 mr-2"></i>
                        Resumen de tus Pedidos
                    </h3>
                    
                    {% for item in orders_with_checkout %}
                    <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-5 mb-4 border-2 border-gray-200 hover:border-primary-300 transition-all">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-xl text-gray-800 mb-2 flex items-center">
                                    <span class="bg-primary-600 text-white rounded-lg px-3 py-1 text-sm mr-2">
                                        Pedido #{{ item.order.id }}
                                    </span>
                                </h4>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500 mb-1">Total</p>
                                <p class="font-bold text-2xl text-green-600">${{ item.order.precio_total|floatformat:0 }}</p>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Producto</p>
                                <p class="font-semibold text-gray-800">{{ item.order.publicacion.cultivo.nombre }}</p>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Cantidad</p>
                                <p class="font-semibold text-gray-800">{{ item.order.cantidad_acordada }} {{ item.order.publicacion.cultivo.unidad_medida }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-primary-50 rounded-lg p-3 mb-4 border border-primary-200">
                            <p class="text-xs text-primary-600 font-medium mb-1"><i class="fas fa-user mr-1"></i> Vendedor</p>
                            <p class="text-sm font-semibold text-gray-800">{{ item.order.vendedor.get_full_name }}</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <!-- Botón de ePayco oculto -->
                            <div style="display: none;">
                                <form id="paymentForm{{ item.order.id }}">
                                    <script
                                        src="https://checkout.epayco.co/checkout.js"
                                        class="epayco-button"
                                        data-epayco-key="{{ item.checkout_data.public_key }}"
                                        data-epayco-amount="{{ item.checkout_data.payment_data.amount }}"
                                        data-epayco-name="{{ item.checkout_data.payment_data.name }}"
                                        data-epayco-description="{{ item.checkout_data.payment_data.description }}"
                                        data-epayco-currency="{{ item.checkout_data.payment_data.currency }}"
                                        data-epayco-country="{{ item.checkout_data.payment_data.country }}"
                                        data-epayco-test="{{ item.checkout_data.test_mode|yesno:'true,false' }}"
                                        data-epayco-external="false"
                                        data-epayco-response="{{ item.checkout_data.payment_data.response }}"
                                        data-epayco-confirmation="{{ item.checkout_data.payment_data.confirmation }}"
                                        data-epayco-name-billing="{{ item.checkout_data.payment_data.name_billing }}"
                                        data-epayco-invoice="{{ item.checkout_data.payment_data.invoice }}"
                                        data-epayco-extra1="{{ item.checkout_data.payment_data.extra1 }}"
                                        data-epayco-extra2="{{ item.checkout_data.payment_data.extra2 }}"
                                        data-epayco-extra3="{{ item.checkout_data.payment_data.extra3 }}"
                                        data-epayco-type-doc-billing="{{ item.checkout_data.payment_data.type_doc_billing }}"
                                        data-epayco-mobilephone-billing="{{ item.checkout_data.payment_data.mobilephone_billing }}"
                                        data-epayco-number-doc-billing="{{ item.checkout_data.payment_data.number_doc_billing }}"
                                        data-epayco-button="hidden-btn-{{ item.order.id }}"
                                    >
                                    </script>
                                </form>
                            </div>
                            
                            <!-- Botón personalizado que dispara ePayco -->
                            <button onclick="document.querySelector('#paymentForm{{ item.order.id }} .epayco-button-render').click()"
                                    class="flex-1 bg-gradient-to-r from-primary-600 to-primary-700 text-white font-bold py-3 px-4 rounded-xl hover:from-primary-700 hover:to-primary-800 shadow-md hover:shadow-lg transition-all flex items-center justify-center group">
                                <div class="bg-white bg-opacity-20 rounded-lg p-1.5 mr-2 group-hover:bg-opacity-30 transition-all">
                                    <i class="fas fa-credit-card text-white"></i>
                                </div>
                                Pagar Ahora
                            </button>
                            
                            <a href="{% url 'order_detail' item.order.id %}" 
                               class="flex-1 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl hover:from-gray-200 hover:to-gray-300 shadow-sm hover:shadow transition-all text-center flex items-center justify-center">
                                <i class="fas fa-eye mr-2"></i>Ver Detalles
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Total general -->
                    <div class="mt-6 pt-6 border-t-2 border-gray-200">
                        <div class="bg-gradient-to-br from-primary-50 to-primary-100 rounded-xl p-5 border-2 border-primary-300">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-primary-600 font-medium mb-1">Total de todos los pedidos</p>
                                    <h3 class="text-3xl font-bold text-primary-700">${{ total|floatformat:0 }} <span class="text-lg">COP</span></h3>
                                </div>
                                <div class="bg-primary-500 rounded-full w-16 h-16 flex items-center justify-center">
                                    <i class="fas fa-coins text-white text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Información y Acciones -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Métodos de Pago -->
            <div class="card">
                <div class="bg-primary-600 px-6 py-4 rounded-t-xl">
                    <h4 class="font-bold text-white flex items-center">
                        <i class="fas fa-credit-card mr-2"></i>
                        Métodos de Pago
                    </h4>
                </div>
                <div class="px-6 py-5">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-white rounded-xl p-4 border-2 border-gray-200 text-center hover:border-primary-400 hover:shadow-md transition-all">
                            <i class="fab fa-cc-visa text-4xl text-gray-700 mb-2"></i>
                            <p class="text-xs font-bold text-gray-800">Tarjeta</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 border-2 border-gray-200 text-center hover:border-primary-400 hover:shadow-md transition-all">
                            <i class="fas fa-university text-4xl text-gray-700 mb-2"></i>
                            <p class="text-xs font-bold text-gray-800">PSE</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 border-2 border-gray-200 text-center hover:border-primary-400 hover:shadow-md transition-all">
                            <i class="fas fa-money-bill-wave text-4xl text-gray-700 mb-2"></i>
                            <p class="text-xs font-bold text-gray-800">Efectivo</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Importante -->
            <div class="card">
                <div class="bg-primary-600 px-6 py-4 rounded-t-xl">
                    <h4 class="font-bold text-white flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Información Importante
                    </h4>
                </div>
                <div class="px-6 py-4">
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-primary-500 mr-2 mt-0.5"></i>
                            <span class="text-sm text-gray-700">Paga cada pedido de forma individual.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-shield-alt text-primary-500 mr-2 mt-0.5"></i>
                            <span class="text-sm text-gray-700">Pago seguro procesado por ePayco.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-bell text-primary-500 mr-2 mt-0.5"></i>
                            <span class="text-sm text-gray-700">El vendedor será notificado al pagar.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-history text-primary-500 mr-2 mt-0.5"></i>
                            <span class="text-sm text-gray-700">Consulta tu <a href="{% url 'order_history' %}" class="font-bold text-primary-600 hover:text-primary-700 underline">Historial de Pedidos</a>.</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="space-y-3">
                <a href="{% url 'order_history' %}" 
                   class="block bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold py-3 px-6 rounded-xl hover:from-gray-700 hover:to-gray-800 shadow-md hover:shadow-lg transition-all text-center">
                    <i class="fas fa-history mr-2"></i>Ver Historial de Pedidos
                </a>
                <a href="{% url 'marketplace' %}" 
                   class="block bg-gradient-to-r from-primary-600 to-primary-700 text-white font-semibold py-3 px-6 rounded-xl hover:from-primary-700 hover:to-primary-800 shadow-md hover:shadow-lg transition-all text-center">
                    <i class="fas fa-shopping-cart mr-2"></i>Seguir Comprando
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Detectar cuando se cierra el modal de ePayco
    // Monitorear clicks en los botones de pagar para empezar a detectar el cierre del modal
    document.addEventListener('DOMContentLoaded', function() {
        var payButtons = document.querySelectorAll('button[onclick*="epayco-button-render"]');
        
        payButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // Esperar a que el modal se abra
                setTimeout(function() {
                    var checkModalInterval = setInterval(function() {
                        var epaycoModal = document.querySelector('.epayco-iframe-content');
                        var epaycoIframe = document.querySelector('iframe[src*="checkout.epayco"]');
                        
                        if (epaycoModal || epaycoIframe) {
                            // El modal está abierto, comenzar a monitorear su cierre
                            clearInterval(checkModalInterval);
                            
                            var checkClosedInterval = setInterval(function() {
                                var modalStillOpen = document.querySelector('.epayco-iframe-content') || 
                                                    document.querySelector('iframe[src*="checkout.epayco"]');
                                
                                if (!modalStillOpen) {
                                    // El modal se cerró, recargar la página
                                    clearInterval(checkClosedInterval);
                                    console.log('Modal de ePayco cerrado, recargando página...');
                                    setTimeout(function() {
                                        window.location.reload();
                                    }, 500); // Pequeño delay para asegurar que el modal se cerró completamente
                                }
                            }, 500); // Verificar cada 500ms
                        }
                    }, 500); // Verificar cada 500ms hasta que el modal se abra
                }, 500); // Delay inicial para que el modal tenga tiempo de abrirse
            });
        });
    });
</script>

{% endblock %}