{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Conversación sobre {{ conversation.publication.cultivo.nombre_producto }}{% endblock %}

{% block content %}
    {% with other_user=conversation.participants.all|get_other_user:user %}
        <h1>Conversación con {{ other_user.first_name }} {{ other_user.last_name }}</h1>
        <h3>Producto: {{ conversation.publication.cultivo.nombre_producto }}</h3>
    {% endwith %}

    <div class="chat-container">
        <div class="message-list" id="message-list">
            {% for message in conversation.messages.all %}
                <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}">
                    <div class="message-bubble">
                        <p class="message-content">{{ message.content }}</p>
                        <small class="message-timestamp">{{ message.created_at|date:"d M, P" }}</small>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <form method="post" class="message-form">
            {% csrf_token %}
            {{ form.content }}
            <button type="submit">Enviar</button>
        </form>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-scroll to bottom on page load
    const messageList = document.getElementById('message-list');
    messageList.scrollTop = messageList.scrollHeight;
</script>
{% endblock %}
